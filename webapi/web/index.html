<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartDNSSort Control Panel</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="main-container">
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab-button" onclick="showTab('config')">Configuration</button>
            <button class="tab-button" onclick="showTab('adblock')">AdBlock</button>

            <div class="app-title">SmartDNSsort</div>

            <div class="header-actions" style="display: flex; align-items: center; gap: 10px; padding-right: 10px;">
                <button id="clearCacheButton" class="btn btn-warning btn-sm">Clear DNS Cache</button>
                <button id="clearStatsButton" class="btn btn-danger btn-sm">Clear All Stats</button>
                <button id="refreshButton" class="btn btn-success btn-sm">Refresh</button>
                <button id="restartButton" class="btn btn-secondary btn-sm">Restart Service</button>
            </div>
        </div>

        <div id="status" class="status">Connecting...</div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="container">
                <div class="card">
                    <h2>General Stats</h2>
                    <table>
                        <tbody>
                            <tr>
                                <td class="label">Total Queries</td>
                                <td id="total_queries" class="value">0</td>
                            </tr>
                            <tr>
                                <td class="label">Cache Hits</td>
                                <td id="cache_hits" class="value">0</td>
                            </tr>
                            <tr>
                                <td class="label">Cache Misses</td>
                                <td id="cache_misses" class="value">0</td>
                            </tr>
                            <tr>
                                <td class="label">Cache Hit Rate</td>
                                <td id="cache_hit_rate" class="value">0.00%</td>
                            </tr>
                            <tr>
                                <td class="label">Upstream Failures</td>
                                <td id="upstream_failures" class="value">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="card">
                    <h2>System Status</h2>
                    <table>
                        <tbody>
                            <tr>
                                <td class="label">CPU Usage</td>
                                <td id="cpu_usage_pct" class="value">0.0%</td>
                            </tr>
                            <tr>
                                <td class="label">Memory Usage</td>
                                <td id="mem_usage_pct" class="value">0.0%</td>
                            </tr>
                            <tr>
                                <td class="label">Goroutines</td>
                                <td id="goroutines" class="value">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="card">
                    <h2>AdBlock Status</h2>
                    <div class="management-actions">
                        <button id="adblockUpdateRulesButton" class="btn btn-primary">Update All Rules Now</button>
                    </div>
                    <table>
                        <tbody>
                            <tr>
                                <td class="label">Enable AdBlock</td>
                                <td class="value">
                                    <label class="switch">
                                        <input type="checkbox" id="adblock_enable_toggle">
                                        <span class="slider"></span>
                                    </label>
                                    <span id="adblock_status" style="margin-left: 10px;">N/A</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="label">Engine</td>
                                <td id="adblock_engine" class="value">N/A</td>
                            </tr>
                            <tr>
                                <td class="label">Total Rules</td>
                                <td id="adblock_total_rules" class="value">0</td>
                            </tr>
                            <tr>
                                <td class="label">Blocked Today</td>
                                <td id="adblock_blocked_today" class="value">0</td>
                            </tr>
                            <tr>
                                <td class="label">Blocked Total</td>
                                <td id="adblock_blocked_total" class="value">0</td>
                            </tr>
                            <tr>
                                <td class="label">Last Update</td>
                                <td id="adblock_last_update" class="value">N/A</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="card">
                    <h2>Memory Usage</h2>
                    <div class="memory-bar-container">
                        <div id="memory_usage_bar" class="memory-bar"></div>
                    </div>
                    <div id="memory_usage_text" class="memory-text">0 MB / 0 MB</div>
                    <table>
                        <tbody>
                            <tr>
                                <td class="label">Cache Entries</td>
                                <td id="cache_entries" class="value">0 / 0</td>
                            </tr>
                            <tr>
                                <td class="label">Expired Entries</td>
                                <td id="expired_entries" class="value">0 (0.0%)</td>
                            </tr>
                            <tr>
                                <td class="label">Protected Entries</td>
                                <td id="protected_entries" class="value">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="card">
                    <h2>Upstream Servers</h2>
                    <table id="upstream_stats">
                        <thead>
                            <tr>
                                <th>Server</th>
                                <th class="value">Success</th>
                                <th class="value">Failure</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="card" id="hot_domains_card">
                    <h2>Hot Domains (Top 10)</h2>
                    <table id="hot_domains_table">
                        <thead>
                            <tr>
                                <th>Domain</th>
                                <th class="value">Count</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="card" id="recent_queries_card">
                    <h2>Recent Queries</h2>
                    <div id="recent_queries_list" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- Configuration Tab -->
        <div id="config" class="tab-content">
            <div class="config-container">
                <nav class="config-nav">
                    <ul>
                        <li><a href="#config-dns">DNS Service</a></li>
                        <li><a href="#config-upstream">Upstream</a></li>
                        <li><a href="#config-ping">Ping</a></li>
                        <li><a href="#config-cache">Cache</a></li>
                        <li><a href="#config-prefetch">Prefetch</a></li>
                        <li><a href="#config-webui">Web UI</a></li>
                        <li><a href="#config-system">System</a></li>
                    </ul>
                </nav>
                <div class="config-content">
                    <form id="configForm">
                        <fieldset id="config-dns">
                            <legend>DNS Service</legend>
                            <div class="form-group">
                                <label for="dns.listen_port">Listen Port</label>
                                <input type="number" id="dns.listen_port" name="dns.listen_port">
                            </div>
                            <div class="form-group form-group-inline">
                                <input type="checkbox" id="dns.enable_tcp" name="dns.enable_tcp">
                                <label for="dns.enable_tcp">Enable TCP</label>
                            </div>
                            <div class="form-group form-group-inline">
                                <input type="checkbox" id="dns.enable_ipv6" name="dns.enable_ipv6">
                                <label for="dns.enable_ipv6">Enable IPv6</label>
                            </div>
                        </fieldset>

                        <fieldset id="config-upstream">
                            <legend>Upstream</legend>
                            <div class="form-group">
                                <label for="upstream.servers">Upstream Servers</label>
                                <textarea id="upstream.servers" name="upstream.servers"></textarea>
                                <small>One server per line.</small>
                            </div>
                            <div class="form-group">
                                <label for="upstream.bootstrap_dns">Bootstrap DNS</label>
                                <textarea id="upstream.bootstrap_dns" name="upstream.bootstrap_dns"></textarea>
                                <small>Bootstrap DNS servers (must be IP addresses) for resolving DoH/DoT domain names.
                                    One server per line.</small>
                            </div>
                            <div class="form-group">
                                <label for="upstream.strategy">Strategy</label>
                                <select id="upstream.strategy" name="upstream.strategy">
                                    <option value="random">Random</option>
                                    <option value="parallel">Parallel</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="upstream.timeout_ms">Timeout (ms)</label>
                                <input type="number" id="upstream.timeout_ms" name="upstream.timeout_ms">
                            </div>
                            <div class="form-group">
                                <label for="upstream.concurrency">Concurrency</label>
                                <input type="number" id="upstream.concurrency" name="upstream.concurrency">
                            </div>
                        </fieldset>

                        <fieldset id="config-ping">
                            <legend>Ping</legend>
                            <div class="form-group">
                                <label for="ping.count">Count</label>
                                <input type="number" id="ping.count" name="ping.count">
                            </div>
                            <div class="form-group">
                                <label for="ping.timeout_ms">Timeout (ms)</label>
                                <input type="number" id="ping.timeout_ms" name="ping.timeout_ms">
                            </div>
                            <div class="form-group">
                                <label for="ping.concurrency">Concurrency</label>
                                <input type="number" id="ping.concurrency" name="ping.concurrency">
                            </div>
                            <div class="form-group">
                                <label for="ping.strategy">Strategy</label>
                                <select id="ping.strategy" name="ping.strategy">
                                    <option value="min">Min</option>
                                    <option value="avg">Avg</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="ping.max_test_ips">Max Test IPs</label>
                                <input type="number" id="ping.max_test_ips" name="ping.max_test_ips">
                                <small>Maximum number of IPs to test per sort (0 = unlimited).</small>
                            </div>
                            <div class="form-group">
                                <label for="ping.rtt_cache_ttl_seconds">RTT Cache TTL (s)</label>
                                <input type="number" id="ping.rtt_cache_ttl_seconds" name="ping.rtt_cache_ttl_seconds">
                                <small>Cache duration for RTT results (0 = disabled).</small>
                            </div>
                        </fieldset>

                        <fieldset id="config-cache">
                            <legend>Cache</legend>
                            <div class="form-group">
                                <label for="cache.fast_response_ttl">Fast Response TTL (s)</label>
                                <input type="number" id="cache.fast_response_ttl" name="cache.fast_response_ttl">
                            </div>
                            <div class="form-group">
                                <label for="cache.user_return_ttl">User Return TTL (s)</label>
                                <input type="number" id="cache.user_return_ttl" name="cache.user_return_ttl">
                            </div>
                            <div class="form-group">
                                <label for="cache.min_ttl_seconds">Min TTL (s)</label>
                                <input type="number" id="cache.min_ttl_seconds" name="cache.min_ttl_seconds">
                            </div>
                            <div class="form-group">
                                <label for="cache.max_ttl_seconds">Max TTL (s)</label>
                                <input type="number" id="cache.max_ttl_seconds" name="cache.max_ttl_seconds">
                            </div>
                            <div class="form-group">
                                <label for="cache.negative_ttl_seconds">Negative Cache TTL (s)</label>
                                <input type="number" id="cache.negative_ttl_seconds" name="cache.negative_ttl_seconds">
                                <small>TTL for NXDOMAIN/NODATA responses.</small>
                            </div>
                            <div class="form-group">
                                <label for="cache.error_cache_ttl_seconds">Error Cache TTL (s)</label>
                                <input type="number" id="cache.error_cache_ttl_seconds"
                                    name="cache.error_cache_ttl_seconds">
                                <small>TTL for SERVFAIL/REFUSED responses.</small>
                            </div>

                            <hr>
                            <legend>Memory Cache Management</legend>

                            <div class="form-group">
                                <label for="cache.max_memory_mb">Max Memory (MB)</label>
                                <input type="number" id="cache.max_memory_mb" name="cache.max_memory_mb">
                                <small>Max memory usage for the cache. Eviction is triggered beyond this limit. 0 for
                                    unlimited.</small>
                            </div>
                            <div class="form-group">
                                <label for="cache.eviction_threshold">Eviction Threshold</label>
                                <input type="number" id="cache.eviction_threshold" name="cache.eviction_threshold"
                                    step="0.01">
                                <small>Memory usage percentage (0.7-0.95) that triggers eviction.</small>
                            </div>
                            <div class="form-group">
                                <label for="cache.eviction_batch_percent">Eviction Batch Percent</label>
                                <input type="number" id="cache.eviction_batch_percent"
                                    name="cache.eviction_batch_percent" step="0.01">
                                <small>Percentage of total cache to evict in a single batch (0.05-0.2).</small>
                            </div>
                            <div class="form-group form-group-inline">
                                <input type="checkbox" id="cache.keep_expired_entries"
                                    name="cache.keep_expired_entries">
                                <label for="cache.keep_expired_entries">Keep Expired Entries</label>
                                <small>Keep expired entries in memory if space is available to speed up subsequent
                                    queries.</small>
                            </div>
                            <div class="form-group form-group-inline">
                                <input type="checkbox" id="cache.protect_prefetch_domains"
                                    name="cache.protect_prefetch_domains">
                                <label for="cache.protect_prefetch_domains">Protect Prefetched Domains</label>
                                <small>Prevent domains in the prefetch list from being evicted during LRU
                                    cleanup.</small>
                            </div>
                        </fieldset>

                        <fieldset id="config-prefetch">
                            <legend>Prefetch</legend>
                            <div class="form-group form-group-inline">
                                <input type="checkbox" id="prefetch.enabled" name="prefetch.enabled">
                                <label for="prefetch.enabled">Enable Prefetch</label>
                            </div>
                            <div class="form-group">
                                <label for="prefetch.top_domains_limit">Top Domains Limit</label>
                                <input type="number" id="prefetch.top_domains_limit" name="prefetch.top_domains_limit">
                            </div>
                            <div class="form-group">
                                <label for="prefetch.refresh_before_expire_seconds">Refresh Before Expire (s)</label>
                                <input type="number" id="prefetch.refresh_before_expire_seconds"
                                    name="prefetch.refresh_before_expire_seconds">
                            </div>
                        </fieldset>

                        <fieldset id="config-webui">
                            <legend>Web UI</legend>
                            <div class="form-group form-group-inline">
                                <input type="checkbox" id="webui.enabled" name="webui.enabled">
                                <label for="webui.enabled">Enable Web UI</label>
                            </div>
                            <div class="form-group">
                                <label for="webui.listen_port">Listen Port</label>
                                <input type="number" id="webui.listen_port" name="webui.listen_port">
                            </div>
                        </fieldset>

                        <fieldset id="config-system">
                            <legend>System</legend>
                            <div class="form-group">
                                <label for="system.max_cpu_cores">Max CPU Cores</label>
                                <input type="number" id="system.max_cpu_cores" name="system.max_cpu_cores">
                                <small>Set to 0 to use all available cores.</small>
                            </div>
                            <div class="form-group">
                                <label for="system.sort_queue_workers">Sort Queue Workers</label>
                                <input type="number" id="system.sort_queue_workers" name="system.sort_queue_workers">
                                <small>Number of parallel sorting tasks.</small>
                            </div>
                            <div class="form-group">
                                <label for="system.refresh_workers">Refresh Workers</label>
                                <input type="number" id="system.refresh_workers" name="system.refresh_workers">
                                <small>Number of async cache refresh workers.</small>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>
            <div class="save-button-container">
                <button class="save-button" onclick="saveConfig()">Save & Apply</button>
            </div>
        </div>

        <!-- AdBlock Tab -->
        <div id="adblock" class="tab-content">
            <div class="container">
                <div class="card card-full-width">
                    <h2>Rule Sources</h2>
                    <table id="adblock_sources_table">
                        <thead>
                            <tr>
                                <th>URL</th>
                                <th>Status</th>
                                <th class="value">Rules</th>
                                <th>Last Update</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows will be added dynamically -->
                        </tbody>
                    </table>
                    <div class="card-footer">
                        <h3>Add New Source</h3>
                        <div class="form-group-inline">
                            <input type="text" id="adblock_new_source_url" placeholder="https://example.com/rules.txt"
                                class="form-control">
                            <button id="adblockAddSourceButton" class="btn btn-success">Add</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>Block Mode</h2>
                    <div class="form-group-inline">
                        <select id="adblock_block_mode" class="form-control">
                            <option value="nxdomain">NXDOMAIN</option>
                            <option value="refused">REFUSED</option>
                            <option value="zero_ip">Zero IP (0.0.0.0)</option>
                        </select>
                        <button id="adblockSaveBlockModeButton" class="btn btn-primary">Save</button>
                    </div>
                    <small style="display: block; margin-top: 0.5rem; color: #6c757d;">
                        Select how blocked domains should be handled
                    </small>
                </div>
                <div class="card">
                    <h2>Test Domain</h2>
                    <div class="form-group-inline">
                        <input type="text" id="adblock_test_domain" placeholder="example.com" class="form-control">
                        <button id="adblockTestDomainButton" class="btn btn-secondary">Test</button>
                    </div>
                    <div id="adblock_test_result" class="test-result"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <footer class="footer">
        <p>© 2025 SmartDNSSort. <a href="https://github.com/lee-alone/SmartDNSSort" target="_blank">GitHub</a></p>
    </footer>
</body>

</html>