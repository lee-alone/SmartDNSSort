# ä¸Šæ¸¸æœåŠ¡å™¨ä»ªè¡¨ç›˜æ”¹é€  - å®ç°å®Œæˆ

## ğŸ“‹ æ”¹é€ æ¦‚è¿°

æˆåŠŸå°†ä¸Šæ¸¸æœåŠ¡å™¨ä»ªè¡¨ç›˜ä»ç®€å•çš„"æˆåŠŸ/å¤±è´¥"ç»Ÿè®¡å‡çº§ä¸ºåŠŸèƒ½å®Œæ•´çš„å¥åº·çŠ¶æ€ç›‘æ§ç³»ç»Ÿã€‚

**æ”¹é€ æ—¶é—´**: 2025å¹´2æœˆ5æ—¥  
**æ”¹é€ èŒƒå›´**: åç«¯ API + å‰ç«¯ UI + å›½é™…åŒ–  
**ç¼–è¯‘çŠ¶æ€**: âœ… æˆåŠŸ

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. åç«¯ API (`/api/upstream-stats`)

**ä½ç½®**: `webapi/api_upstream.go`

æä¾›è¯¦ç»†çš„ä¸Šæ¸¸æœåŠ¡å™¨å¥åº·çŠ¶æ€æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š
- æœåŠ¡å™¨åœ°å€å’Œåè®®ç±»å‹
- æˆåŠŸ/å¤±è´¥è®¡æ•°å’ŒæˆåŠŸç‡
- å¥åº·çŠ¶æ€ï¼ˆå¥åº·/é™çº§/ä¸å¥åº·ï¼‰
- å¹³å‡å»¶è¿Ÿï¼ˆEWMAï¼‰
- ç†”æ–­å™¨çŠ¶æ€å’Œæ¢å¤ä¿¡æ¯
- è¿ç»­å¤±è´¥/æˆåŠŸæ¬¡æ•°

**æ•°æ®æ¥æº**:
- å¥åº·çŠ¶æ€: `upstream/health.go` ä¸­çš„ `ServerHealth` å¯¹è±¡
- ç»Ÿè®¡è®¡æ•°: `stats/stats.go` ä¸­çš„å…¨å±€ç»Ÿè®¡
- åè®®ä¿¡æ¯: `upstream/health_aware.go` ä¸­çš„åè®®å­—æ®µ

### 2. å‰ç«¯ UI å¢å¼º

**ä½ç½®**: `webapi/web/components/dashboard.html`

è¡¨æ ¼ä» 3 åˆ—æ‰©å±•åˆ° 8 åˆ—ï¼š

| åˆ— | å†…å®¹ | æ ·å¼ |
|----|------|------|
| 1 | Server | æœåŠ¡å™¨åœ°å€ |
| 2 | Protocol | UDP/TCP/DoH/DoT Badge |
| 3 | Success Rate | è¿›åº¦æ¡ + ç™¾åˆ†æ¯” |
| 4 | Status | å¥åº·çŠ¶æ€å›¾æ ‡ |
| 5 | Latency | å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰ |
| 6 | Total | æ€»è¯·æ±‚æ•° |
| 7 | Success | æˆåŠŸæ•°ï¼ˆç»¿è‰²ï¼‰ |
| 8 | Failure | å¤±è´¥æ•°ï¼ˆçº¢è‰²ï¼‰ |

### 3. å‰ç«¯é€»è¾‘

**ä½ç½®**: `webapi/web/js/modules/dashboard.js`

æ–°å¢å‡½æ•°ï¼š
- `fetchUpstreamStats()` - è·å–ä¸Šæ¸¸æœåŠ¡å™¨ç»Ÿè®¡
- `renderEnhancedUpstreamTable()` - æ¸²æŸ“å¢å¼ºè¡¨æ ¼
- `showUpstreamLoadError()` - æ˜¾ç¤ºåŠ è½½é”™è¯¯
- `getRateColor()` - æˆåŠŸç‡é¢œè‰²åˆ†ç±»
- `getStatusIcon()` - å¥åº·çŠ¶æ€å›¾æ ‡
- `getLatencyClass()` - å»¶è¿Ÿé¢œè‰²åˆ†ç±»
- `getProtocolBadge()` - åè®® Badge

**é›†æˆæ–¹å¼**:
- åœ¨ `updateDashboard()` ä¸­è°ƒç”¨ `fetchUpstreamStats()`
- å¤ç”¨ç°æœ‰çš„ 5 ç§’åˆ·æ–°æœºåˆ¶
- é”™è¯¯æ—¶æ˜¾ç¤ºæç¤ºï¼Œä¸‹ä¸ªå‘¨æœŸè‡ªåŠ¨é‡è¯•

### 4. å›½é™…åŒ–æ”¯æŒ

**æ”¯æŒè¯­è¨€**:
- è‹±æ–‡ (`resources-en.js`)
- ç®€ä½“ä¸­æ–‡ (`resources-zh-cn.js`)

**æ–°å¢ç¿»è¯‘**:
- `dashboard.protocol` - åè®®
- `dashboard.successRate` - æˆåŠŸç‡
- `dashboard.status` - çŠ¶æ€
- `dashboard.latency` - å»¶è¿Ÿ
- `upstream.dataLoadFailed` - æ•°æ®åŠ è½½å¤±è´¥
- `upstream.retryingNextCycle` - ä¸‹ä¸ªå‘¨æœŸé‡è¯•

---

## ğŸ“Š æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯: updateDashboard() æ¯ 5 ç§’è°ƒç”¨ä¸€æ¬¡                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯: fetchUpstreamStats()                              â”‚
â”‚ GET /api/upstream-stats                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç«¯: handleUpstreamStats()                             â”‚
â”‚ 1. è·å– upstream manager                                â”‚
â”‚ 2. éå†æ‰€æœ‰æœåŠ¡å™¨                                       â”‚
â”‚ 3. æ”¶é›†å¥åº·çŠ¶æ€å’Œç»Ÿè®¡æ•°æ®                               â”‚
â”‚ 4. è¿”å› JSON å“åº”                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯: renderEnhancedUpstreamTable()                     â”‚
â”‚ 1. è§£æ JSON æ•°æ®                                       â”‚
â”‚ 2. è®¡ç®—é¢œè‰²å’Œæ ·å¼                                       â”‚
â”‚ 3. æ¸²æŸ“è¡¨æ ¼è¡Œ                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### åç«¯å®ç°

**æ–‡ä»¶**: `webapi/api_upstream.go`

```go
// ä¸»è¦æ­¥éª¤ï¼š
1. è·å– upstream manager
2. è·å–æ‰€æœ‰æœåŠ¡å™¨åˆ—è¡¨
3. è·å–å…¨å±€ç»Ÿè®¡æ•°æ®
4. éå†æ¯ä¸ªæœåŠ¡å™¨ï¼š
   - ç±»å‹æ–­è¨€ä¸º HealthAwareUpstream
   - è·å–å¥åº·çŠ¶æ€å¯¹è±¡
   - ä»å…¨å±€ç»Ÿè®¡ä¸­æŸ¥æ‰¾æˆåŠŸ/å¤±è´¥è®¡æ•°
   - è®¡ç®—æˆåŠŸç‡
   - æå–å¥åº·çŠ¶æ€ã€å»¶è¿Ÿç­‰ä¿¡æ¯
5. è¿”å› JSON å“åº”
```

**å…³é”®æ•°æ®ç»“æ„**:

```go
type UpstreamServerStats struct {
    Address                        string
    Protocol                       string
    Success                        int64
    Failure                        int64
    Total                          int64
    SuccessRate                    float64
    Status                         string
    LatencyMs                      float64
    ConsecutiveFailures            int
    ConsecutiveSuccesses           int
    LastFailure                    *string
    SecondsSinceLastFailure        *int
    CircuitBreakerRemainingSeconds int
    IsTemporarilySkipped           bool
}
```

### å‰ç«¯å®ç°

**æ–‡ä»¶**: `webapi/web/js/modules/dashboard.js`

```javascript
// ä¸»è¦æ­¥éª¤ï¼š
1. fetchUpstreamStats() è°ƒç”¨ API
2. é”™è¯¯å¤„ç†ï¼šæ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œä¸‹ä¸ªå‘¨æœŸé‡è¯•
3. renderEnhancedUpstreamTable() æ¸²æŸ“è¡¨æ ¼
4. ä¸ºæ¯ä¸ªæœåŠ¡å™¨è®¡ç®—ï¼š
   - æˆåŠŸç‡é¢œè‰²ï¼ˆç»¿/é»„/çº¢ï¼‰
   - å¥åº·çŠ¶æ€å›¾æ ‡ï¼ˆğŸŸ¢ğŸŸ¡ğŸ”´ï¼‰
   - å»¶è¿Ÿé¢œè‰²ï¼ˆç»¿/é»„/çº¢ï¼‰
   - åè®® Badge
5. æ’å…¥è¡¨æ ¼è¡Œ
```

**é¢œè‰²åˆ†ç±»**:

| æŒ‡æ ‡ | ç»¿è‰² | é»„è‰² | çº¢è‰² |
|------|------|------|------|
| æˆåŠŸç‡ | â‰¥90% | 70-90% | <70% |
| å»¶è¿Ÿ | <50ms | 50-200ms | >200ms |

---

## ğŸ“ æ–‡ä»¶ä¿®æ”¹æ¸…å•

### æ–°å»ºæ–‡ä»¶ (1)
- `webapi/api_upstream.go` - ä¸Šæ¸¸æœåŠ¡å™¨ç»Ÿè®¡ API å¤„ç†å™¨

### ä¿®æ”¹æ–‡ä»¶ (6)
- `dnsserver/server.go` - æ·»åŠ  `GetUpstreamManager()` æ–¹æ³•
- `webapi/api.go` - æ·»åŠ  `/api/upstream-stats` è·¯ç”±
- `webapi/web/components/dashboard.html` - æ›´æ–°è¡¨æ ¼ç»“æ„
- `webapi/web/js/modules/dashboard.js` - æ·»åŠ ç»Ÿè®¡å‡½æ•°
- `webapi/web/js/i18n/resources-en.js` - è‹±æ–‡ç¿»è¯‘
- `webapi/web/js/i18n/resources-zh-cn.js` - ä¸­æ–‡ç¿»è¯‘

### æ–‡æ¡£æ–‡ä»¶ (1)
- `webapi/web_doc/UPSTREAM_DASHBOARD_RENOVATION_COMPLETE.md` - æœ¬æ–‡ä»¶

---

## âœ… æµ‹è¯•æ¸…å•

- [x] API ç«¯ç‚¹è¿”å›æ­£ç¡®çš„ JSON æ•°æ®
- [x] è¡¨æ ¼æ­£ç¡®æ¸²æŸ“æ‰€æœ‰ 8 åˆ—
- [x] æˆåŠŸç‡è¿›åº¦æ¡é¢œè‰²æ­£ç¡®
- [x] å¥åº·çŠ¶æ€å›¾æ ‡æ˜¾ç¤ºæ­£ç¡®
- [x] å»¶è¿Ÿé¢œè‰²åˆ†ç±»æ­£ç¡®
- [x] åè®® Badge æ˜¾ç¤ºæ­£ç¡®
- [x] å›½é™…åŒ–æ–‡æœ¬æ­£å¸¸æ˜¾ç¤º
- [x] å“åº”å¼å¸ƒå±€æ­£å¸¸å·¥ä½œ
- [x] æ•°æ®åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯æç¤º
- [x] ä¸‹ä¸ªåˆ·æ–°å‘¨æœŸè‡ªåŠ¨é‡è¯•
- [x] ä»£ç ç¼–è¯‘æˆåŠŸ

---

## ğŸ¨ UI æ•ˆæœç¤ºä¾‹

### å¥åº·çš„æœåŠ¡å™¨
```
8.8.8.8:53 | [UDP] | â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 95.7% | ğŸŸ¢ healthy | 23.5 ms | 1290 | 1234 | 56
```

### é™çº§çš„æœåŠ¡å™¨
```
192.168.1.1 | [TCP] | â–ˆâ–ˆâ–ˆâ–‘â–‘ 75.3% | ğŸŸ¡ degraded | 156.8 ms | 530 | 399 | 131
```

### ä¸å¥åº·çš„æœåŠ¡å™¨
```
10.0.0.1 | [DoT] | â–ˆâ–ˆâ–‘â–‘â–‘ 45.2% | ğŸ”´ unhealthy | 2500.0 ms | 200 | 90 | 110
```

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸ (å¯é€‰)
- [ ] æ·»åŠ è¡¨æ ¼åˆ—æ’åºåŠŸèƒ½
- [ ] æ·»åŠ "æµ‹è¯•æœåŠ¡å™¨"æŒ‰é’®
- [ ] æ·»åŠ æœåŠ¡å™¨å¯ç”¨/ç¦ç”¨å¼€å…³

### ä¸­æœŸ (å¯é€‰)
- [ ] æ·»åŠ å»¶è¿Ÿå†å²è¶‹åŠ¿å›¾
- [ ] ç‚¹å‡»æœåŠ¡å™¨è¡Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯æ¨¡æ€æ¡†
- [ ] å¯¼å‡ºç»Ÿè®¡æ•°æ®ä¸º CSV

### é•¿æœŸ (å¯é€‰)
- [ ] å®æ—¶æ¨é€ï¼ˆWebSocket/SSEï¼‰
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆç¼“å­˜ã€åˆ†é¡µï¼‰
- [ ] æ›´å¤šè¯­è¨€æ”¯æŒ

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åˆ·æ–°**: å¤ç”¨ç°æœ‰çš„ 5 ç§’åˆ·æ–°æœºåˆ¶ï¼Œä¸ç ´ååŸæœ‰é€»è¾‘
2. **é”™è¯¯å¤„ç†**: åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºæç¤ºï¼Œè‡ªåŠ¨é‡è¯•ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½
3. **æ€§èƒ½**: å½“å‰å®ç°ç®€å•ç›´æ¥ï¼Œæ— ç¼“å­˜ï¼Œåç»­æœ‰é—®é¢˜å†ä¼˜åŒ–
4. **å…¼å®¹æ€§**: æ”¯æŒç°æœ‰çš„æ‰€æœ‰æµè§ˆå™¨å’Œè®¾å¤‡
5. **å›½é™…åŒ–**: æ”¯æŒä¸­è‹±æ–‡ï¼Œå¯è½»æ¾æ‰©å±•å…¶ä»–è¯­è¨€

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·å‚è€ƒï¼š
- åç«¯ä»£ç : `webapi/api_upstream.go`
- å‰ç«¯ä»£ç : `webapi/web/js/modules/dashboard.js`
- ç¿»è¯‘æ–‡ä»¶: `webapi/web/js/i18n/resources-*.js`
- åŸå§‹è®¡åˆ’: `UPSTREAM_DASHBOARD_RENOVATION_PLAN.md`
