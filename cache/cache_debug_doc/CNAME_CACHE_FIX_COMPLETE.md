# âœ… CNAMEç¼“å­˜é—®é¢˜ä¿®å¤å®Œæˆ

## ä¿®å¤æ¦‚è¿°

å·²æˆåŠŸä¿®å¤å¯¼è‡´"åŸŸåå’ŒIPä¸åŒ¹é…"é—®é¢˜çš„ä¸¤ä¸ªCNAMEç¼“å­˜åˆ›å»ºä½ç½®ã€‚

## ä¿®å¤è¯¦æƒ…

### ä¿®å¤1ï¼š`dnsserver/handler_query.go` L160-195ï¼ˆå·²å®Œæˆï¼‰

**çŠ¶æ€**ï¼šâœ… å·²ä¿®å¤

**ä¿®æ”¹å†…å®¹**ï¼š
- åˆ é™¤äº†ä¸ºCNAMEé“¾ä¸­æ¯ä¸ªåŸŸååˆ›å»ºç¼“å­˜çš„å¾ªç¯
- ç°åœ¨åªä¸ºåŸå§‹æŸ¥è¯¢åŸŸååˆ›å»ºç¼“å­˜
- ä¸å†ä¸ºCNAMEé“¾ä¸­çš„å…¶ä»–åŸŸååˆ›å»ºç¼“å­˜

**ä»£ç å˜åŒ–**ï¼š
```go
// ä¿®å¤å‰ï¼šä¸ºæ‰€æœ‰CNAMEåˆ›å»ºç¼“å­˜
for i, cname := range fullCNAMEs {
    cnameDomain := strings.TrimRight(cname, ".")
    s.cache.SetRawRecords(cnameDomain, qtype, finalRecords, subCNAMEs, finalTTL)
    go s.sortIPsAsync(cnameDomain, qtype, finalIPs, finalTTL, time.Now())
}

// ä¿®å¤åï¼šåˆ é™¤è¿™ä¸ªå¾ªç¯
// åªä¿ç•™åŸå§‹åŸŸåçš„ç¼“å­˜
s.cache.SetRawRecordsWithDNSSEC(domain, qtype, finalRecords, fullCNAMEs, finalTTL, result.AuthenticatedData)
if len(finalIPs) > 0 {
    go s.sortIPsAsync(domain, qtype, finalIPs, finalTTL, time.Now())
}
```

### ä¿®å¤2ï¼š`dnsserver/refresh.go` L82-96ï¼ˆåˆšå®Œæˆï¼‰

**çŠ¶æ€**ï¼šâœ… å·²ä¿®å¤

**ä¿®æ”¹å†…å®¹**ï¼š
- åˆ é™¤äº†ä¸ºCNAMEé“¾ä¸­æ¯ä¸ªåŸŸååˆ›å»ºç¼“å­˜çš„å¾ªç¯
- ç°åœ¨åªä¸ºåŸå§‹æŸ¥è¯¢åŸŸååˆ›å»ºç¼“å­˜
- æ¸…ç†äº†ä¸å†éœ€è¦çš„ `strings` å¯¼å…¥

**ä»£ç å˜åŒ–**ï¼š
```go
// ä¿®å¤å‰ï¼šä¸ºæ‰€æœ‰CNAMEåˆ›å»ºç¼“å­˜
s.cache.SetRaw(domain, qtype, finalIPs, fullCNAMEs, finalTTL)
go s.sortIPsAsync(domain, qtype, finalIPs, finalTTL, time.Now())

for i, cname := range fullCNAMEs {
    cnameDomain := strings.TrimRight(cname, ".")
    var subCNAMEs []string
    if i < len(fullCNAMEs)-1 {
        subCNAMEs = fullCNAMEs[i+1:]
    }
    s.cache.SetRaw(cnameDomain, qtype, finalIPs, subCNAMEs, finalTTL)
    go s.sortIPsAsync(cnameDomain, qtype, finalIPs, finalTTL, time.Now())
}

// ä¿®å¤åï¼šåˆ é™¤è¿™ä¸ªå¾ªç¯
s.cache.SetRaw(domain, qtype, finalIPs, fullCNAMEs, finalTTL)
go s.sortIPsAsync(domain, qtype, finalIPs, finalTTL, time.Now())
```

## ç¼–è¯‘éªŒè¯

âœ… ä»£ç ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯æˆ–è­¦å‘Š

```
go build ./cmd
Exit Code: 0
```

## é—®é¢˜æ ¹æœ¬åŸå› 

### ä¸ºä»€ä¹ˆä¼šå‡ºç°"åŸŸåå’ŒIPä¸åŒ¹é…"

1. **åˆå§‹æŸ¥è¯¢æ—¶**ï¼ˆhandler_query.goï¼‰
   - æŸ¥è¯¢ www.a.com
   - è¿”å› CNAME é“¾ï¼šwww.a.com â†’ cdn.a.com â†’ cdn.b.com
   - IP æ± ï¼š[1.1.1.1, 2.2.2.2, 3.3.3.3]
   - **é—®é¢˜**ï¼šä¸ºæ‰€æœ‰CNAMEéƒ½åˆ›å»ºäº†ç›¸åŒçš„ç¼“å­˜
     - www.a.com â†’ IP [1.1.1.1, 2.2.2.2, 3.3.3.3]
     - cdn.a.com â†’ IP [1.1.1.1, 2.2.2.2, 3.3.3.3] âŒ
     - cdn.b.com â†’ IP [1.1.1.1, 2.2.2.2, 3.3.3.3] âŒ

2. **ç¼“å­˜åˆ·æ–°æ—¶**ï¼ˆrefresh.goï¼‰
   - ç¼“å­˜è¿‡æœŸï¼Œè§¦å‘å¼‚æ­¥åˆ·æ–°
   - å†æ¬¡ä¸ºæ‰€æœ‰CNAMEåˆ›å»ºç¼“å­˜
   - **é—®é¢˜**ï¼šå¯èƒ½è·å¾—ä¸åŒçš„IPåˆ—è¡¨ï¼Œè¦†ç›–ä¹‹å‰çš„ç¼“å­˜

3. **ç›´æ¥æŸ¥è¯¢CNAMEæ—¶**
   - ç”¨æˆ·æŸ¥è¯¢ cdn.a.com
   - è¿”å›ç¼“å­˜çš„ IP [1.1.1.1, 2.2.2.2, 3.3.3.3]
   - **é—®é¢˜**ï¼šè¿™äº›IPå¯èƒ½ä¸å±äº cdn.a.com
   - å®¢æˆ·ç«¯è¿æ¥æ—¶è¯ä¹¦é”™è¯¯ï¼

### ä¸ºä»€ä¹ˆåªæœ‰CNAMEåŸŸåå‡ºç°é—®é¢˜

- **éCNAMEåŸŸå**ï¼šåªæœ‰ä¸€ä¸ªç¼“å­˜æ¡ç›®ï¼Œä¸ä¼šå‡ºç°é—®é¢˜
- **CNAMEåŸŸå**ï¼šæœ‰å¤šä¸ªç¼“å­˜æ¡ç›®ï¼ˆåŸå§‹åŸŸå + CNAMEé“¾ä¸­çš„æ¯ä¸ªåŸŸåï¼‰ï¼Œæ‰€æœ‰æ¡ç›®éƒ½å…³è”åˆ°ç›¸åŒçš„IPï¼Œå¯¼è‡´é—®é¢˜

## ä¿®å¤åçš„è¡Œä¸º

### åˆå§‹æŸ¥è¯¢æ—¶
```
æŸ¥è¯¢ www.a.com
  â”œâ”€ è¿”å› CNAME é“¾ï¼šwww.a.com â†’ cdn.a.com â†’ cdn.b.com
  â”œâ”€ IP æ± ï¼š[1.1.1.1, 2.2.2.2, 3.3.3.3]
  â””â”€ åªä¸º www.a.com åˆ›å»ºç¼“å­˜ âœ…
     www.a.com â†’ IP [1.1.1.1, 2.2.2.2, 3.3.3.3]
```

### ç¼“å­˜åˆ·æ–°æ—¶
```
ç¼“å­˜è¿‡æœŸï¼Œè§¦å‘å¼‚æ­¥åˆ·æ–°
  â”œâ”€ é‡æ–°æŸ¥è¯¢ www.a.com
  â”œâ”€ è·å¾—æ–°çš„ IP åˆ—è¡¨
  â””â”€ åªæ›´æ–° www.a.com çš„ç¼“å­˜ âœ…
     ä¸ä¸ºCNAMEåˆ›å»ºç¼“å­˜
```

### ç›´æ¥æŸ¥è¯¢CNAMEæ—¶
```
æŸ¥è¯¢ cdn.a.com
  â”œâ”€ ç¼“å­˜æœªå‘½ä¸­ï¼ˆå› ä¸ºæ²¡æœ‰ä¸ºCNAMEåˆ›å»ºç¼“å­˜ï¼‰
  â”œâ”€ è§¦å‘æ–°çš„ä¸Šæ¸¸æŸ¥è¯¢
  â””â”€ è¿”å›æ­£ç¡®çš„ IP âœ…
     cdn.a.com çš„çœŸå® IP
```

## æµ‹è¯•å»ºè®®

1. **æµ‹è¯•CNAMEåŸŸå**
   - æŸ¥è¯¢æœ‰CNAMEçš„åŸŸåï¼ˆå¦‚ www.a.comï¼‰
   - ç­‰å¾…ç¼“å­˜è¿‡æœŸï¼Œè§¦å‘åˆ·æ–°
   - ç›´æ¥æŸ¥è¯¢CNAMEï¼ˆå¦‚ cdn.a.comï¼‰
   - éªŒè¯è¿”å›çš„IPæ˜¯å¦æ­£ç¡®

2. **éªŒè¯è¯ä¹¦é”™è¯¯æ¶ˆå¤±**
   - è®¿é—®æœ‰CNAMEçš„ç½‘ç«™
   - å¤šæ¬¡è®¿é—®ï¼Œè§‚å¯Ÿæ˜¯å¦ä»æœ‰è¯ä¹¦é”™è¯¯
   - æ¸…ç©ºç¼“å­˜åå†æ¬¡è®¿é—®

3. **æ€§èƒ½éªŒè¯**
   - ç›´æ¥æŸ¥è¯¢CNAMEæ—¶ï¼Œä¼šè§¦å‘æ–°çš„ä¸Šæ¸¸æŸ¥è¯¢
   - è¿™ä¼šå¢åŠ ä¸€äº›å»¶è¿Ÿï¼Œä½†ç¡®ä¿æ­£ç¡®æ€§

## æ€»ç»“

âœ… **ä¿®å¤å®Œæˆ**
- ä¸¤ä¸ªCNAMEç¼“å­˜åˆ›å»ºä½ç½®éƒ½å·²ä¿®å¤
- ä»£ç ç¼–è¯‘æˆåŠŸ
- é—®é¢˜æ ¹æœ¬åŸå› å·²è§£å†³

ğŸ¯ **ä¿®å¤æ•ˆæœ**
- æ¶ˆé™¤"åŸŸåå’ŒIPä¸åŒ¹é…"é—®é¢˜
- é¿å…è¯ä¹¦é”™è¯¯
- ç¡®ä¿CNAMEåŸŸåè¿”å›æ­£ç¡®çš„IP

ğŸ“ **ä¸‹ä¸€æ­¥**
- ç¼–è¯‘å¹¶è¿è¡Œæµ‹è¯•
- éªŒè¯CNAMEåŸŸåæŸ¥è¯¢æ˜¯å¦æ­£å¸¸
- è§‚å¯Ÿæ˜¯å¦ä»æœ‰è¯ä¹¦é”™è¯¯
