# 测试指南\n\n## 🧪 测试概览\n\n本指南说明如何测试并行模式的IP去重功能。\n\n---\n\n## 📋 测试前准备\n\n### 1. 编译代码\n\n```bash\n# 进入项目目录\ncd /path/to/smartdnssort\n\n# 编译\nmake build\n# 或\n./build.sh\n```\n\n### 2. 配置测试环境\n\n确保配置文件中启用了并行模式：\n\n```yaml\nupstream:\n  mode: parallel  # 确保是并行模式\n  servers:\n    - 8.8.8.8\n    - 1.1.1.1\n    - 114.114.114.114\n  timeout: 3000\n  concurrency: 5\n```\n\n### 3. 启用DEBUG日志\n\n```yaml\nlogger:\n  level: debug  # 启用DEBUG日志\n  output: logs/smartdnssort.log\n```\n\n---\n\n## 🚀 运行测试\n\n### 步骤1: 启动服务\n\n```bash\n# 启动服务\n./smartdnssort\n\n# 或在后台运行\n./smartdnssort &\n```\n\n### 步骤2: 查询测试域名\n\n```bash\n# 查询单个域名\ndig example.com +short\n\n# 查询多个域名\ndig google.com +short\ndig github.com +short\ndig cloudflare.com +short\n```\n\n### 步骤3: 检查日志\n\n```bash\n# 查看去重统计\ngrep \"去重统计\" logs/smartdnssort.log\n\n# 查看后台收集的详情\ngrep \"collectRemainingResponses\" logs/smartdnssort.log\n\n# 查看IP变化\ngrep \"IP变化\" logs/smartdnssort.log\n\n# 查看所有相关日志\ngrep -E \"(去重|collectRemainingResponses|IP变化)\" logs/smartdnssort.log\n```\n\n---\n\n## 📊 测试场景\n\n### 场景1: 基础去重测试\n\n**目标**: 验证IP级别去重是否有效\n\n**步骤**:\n1. 查询一个常见域名（如 google.com）\n2. 查看日志中的去重统计\n3. 验证去重率是否合理\n\n**预期结果**:\n```\n[collectRemainingResponses] 去重统计: 去重前 12 条记录, 去重后 4 条记录, 去重率 66.7%\n```\n\n**验证**:\n- ✅ 去重率在10-50%范围内（取决于上游配置）\n- ✅ 去重后的记录数 < 去重前的记录数\n\n---\n\n### 场景2: 缓存更新测试\n\n**目标**: 验证缓存更新和IP变化记录\n\n**步骤**:\n1. 第一次查询 example.com\n2. 查看日志中的IP变化\n3. 第二次查询 example.com（应该从缓存返回）\n4. 查看日志中是否有新的IP变化\n\n**预期结果**:\n```\n# 第一次查询\n[CacheUpdateCallback] IP数量: 4 (新增)\n\n# 第二次查询（从缓存返回，不会有新的IP变化）\n[handleQuery] 原始缓存命中: example.com (type=A)\n```\n\n**验证**:\n- ✅ 第一次查询时记录IP数量\n- ✅ 第二次查询从缓存返回\n\n---\n\n### 场景3: 重复IP检测\n\n**目标**: 验证是否能检测并去除重复IP\n\n**步骤**:\n1. 查询一个域名\n2. 检查dig返回的IP列表\n3. 验证是否有重复IP\n\n**预期结果**:\n```bash\n$ dig example.com +short | sort | uniq -d\n# 应该没有输出（没有重复IP）\n```\n\n**验证**:\n- ✅ dig返回的IP列表中没有重复\n- ✅ 缓存中的IP列表中没有重复\n\n---\n\n### 场景4: 轻量级验证测试\n\n**目标**: 验证写入前验证是否有效\n\n**步骤**:\n1. 查询一个域名\n2. 查看日志中是否有验证相关的日志\n3. 验证是否有警告信息\n\n**预期结果**:\n```\n[collectRemainingResponses] 去重统计: 去重前 12 条记录, 去重后 4 条记录, 去重率 66.7%\n[collectRemainingResponses] 📝 调用缓存更新回调，更新完整记录池到缓存\n```\n\n**验证**:\n- ✅ 有去重统计日志\n- ✅ 没有警告信息（表示验证通过）\n\n---\n\n## 🔍 日志分析\n\n### 关键日志点\n\n#### 1. 去重统计\n\n```\n[collectRemainingResponses] 去重统计: 去重前 12 条记录, 去重后 4 条记录, 去重率 66.7%\n```\n\n**含义**:\n- 去重前: 从所有上游收集到的总记录数\n- 去重后: 去重后的记录数\n- 去重率: (去重前 - 去重后) / 去重前 * 100%\n\n**分析**:\n- 去重率 > 0: 说明有重复记录\n- 去重率 = 0: 说明没有重复记录\n- 去重率 > 90%: 可能有问题，需要检查\n\n#### 2. IP变化\n\n```\n[CacheUpdateCallback] IP变化: 2 -> 4 (变化率: 100%)\n```\n\n**含义**:\n- 旧IP数量: 2\n- 新IP数量: 4\n- 变化率: (新 - 旧) / 旧 * 100%\n\n**分析**:\n- 变化率 > 0: 说明后台收集到了新IP\n- 变化率 = 0: 说明没有新IP\n- 变化率 < 0: 说明IP减少了（不太可能）\n\n#### 3. 后台收集完成\n\n```\n[collectRemainingResponses] ✅ 后台收集完成: 从 3 个服务器收集到 4 条记录\n```\n\n**含义**:\n- 从3个上游服务器收集到了结果\n- 去重后得到4条记录\n\n---\n\n## 📈 性能测试\n\n### 测试1: 去重性能\n\n**目标**: 验证去重不会显著影响性能\n\n**步骤**:\n1. 查询一个返回大量IP的域名\n2. 记录查询时间\n3. 检查日志中的处理时间\n\n**预期结果**:\n- 快速响应时间 < 20ms\n- 后台处理时间 < 100ms\n- 去重开销 < 1%\n\n### 测试2: 内存使用\n\n**目标**: 验证去重不会导致内存泄漏\n\n**步骤**:\n1. 启动服务\n2. 进行多次查询\n3. 监控内存使用\n4. 检查是否有内存泄漏\n\n**预期结果**:\n- 内存使用稳定\n- 没有内存泄漏\n\n---\n\n## ✅ 验证清单\n\n### 功能验证\n- [ ] 编译无错误\n- [ ] 服务启动正常\n- [ ] 查询返回正确结果\n- [ ] 日志输出正确\n- [ ] 去重有效\n- [ ] 缓存更新正常\n- [ ] 排序功能正常\n\n### 性能验证\n- [ ] 快速响应时间 < 20ms\n- [ ] 后台处理时间 < 100ms\n- [ ] 去重开销 < 1%\n- [ ] 内存使用正常\n- [ ] 没有内存泄漏\n\n### 日志验证\n- [ ] 有去重统计日志\n- [ ] 有IP变化日志\n- [ ] 有后台收集完成日志\n- [ ] 没有错误日志\n- [ ] 没有异常警告\n\n---\n\n## 🐛 故障排查\n\n### 问题1: 没有看到去重统计日志\n\n**原因**:\n- 日志级别不是DEBUG\n- 没有使用并行模式\n- 没有多个上游服务器\n\n**解决**:\n1. 检查日志级别是否为DEBUG\n2. 检查是否启用了并行模式\n3. 检查是否配置了多个上游服务器\n\n### 问题2: 去重率过高（> 90%）\n\n**原因**:\n- 多个上游返回相同的IP\n- 可能有配置问题\n\n**解决**:\n1. 检查上游服务器配置\n2. 检查是否有重复的上游服务器\n3. 查看具体的去重日志\n\n### 问题3: 缓存中仍然有重复IP\n\n**原因**:\n- 防御性去重没有生效\n- 可能有其他代码路径\n\n**解决**:\n1. 检查SetRawRecords是否被调用\n2. 检查SetRawRecordsWithDNSSEC是否被调用\n3. 查看详细的日志\n\n---\n\n## 📝 测试报告模板\n\n```\n测试日期: 2024-01-14\n测试环境: Linux/Windows/macOS\n\n测试场景1: 基础去重测试\n- 查询域名: example.com\n- 去重前记录数: 12\n- 去重后记录数: 4\n- 去重率: 66.7%\n- 结果: ✅ 通过\n\n测试场景2: 缓存更新测试\n- 第一次查询: IP数量 4\n- 第二次查询: 从缓存返回\n- 结果: ✅ 通过\n\n测试场景3: 重复IP检测\n- dig返回的IP: 4个\n- 重复IP数: 0\n- 结果: ✅ 通过\n\n性能测试:\n- 快速响应时间: 15ms\n- 后台处理时间: 50ms\n- 去重开销: 0.5%\n- 结果: ✅ 通过\n\n总体结果: ✅ 所有测试通过\n```\n\n---\n\n## 📞 支持\n\n如有问题，查看:\n1. [实施总结](./IMPLEMENTATION_SUMMARY.md) - 了解改动\n2. [事后验证讨论](./POST_VALIDATION_DISCUSSION.md) - 理解验证逻辑\n3. 日志文件: `logs/smartdnssort.log`\n\n---\n\n**最后更新**: 2024-01-14\n\n**状态**: ✅ 准备就绪\n