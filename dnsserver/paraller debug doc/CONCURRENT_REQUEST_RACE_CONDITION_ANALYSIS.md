# å¹¶å‘è¯·æ±‚ç«æ€æ¡ä»¶åˆ†æ

## ğŸ¯ ä½ çš„å‡è®¾

```
T1: å¼€å§‹æŸ¥è¯¢ www.a.com
    â”œâ”€ å¯åŠ¨ç¬¬ä¸€é˜¶æ®µï¼ˆå¹¶å‘æŸ¥è¯¢2ä¸ªæœåŠ¡å™¨ï¼‰
    â”œâ”€ å¯åŠ¨ç¬¬äºŒé˜¶æ®µï¼ˆåå°æŸ¥è¯¢å‰©ä½™æœåŠ¡å™¨ï¼‰
    â””â”€ æ‰€æœ‰æœåŠ¡å™¨è¿˜æ²¡æœ‰å…¨éƒ¨è¯»å®Œ...

T2: æ–°çš„æŸ¥è¯¢è¿›æ¥ï¼ˆwww.b.com æˆ–å…¶ä»–ï¼‰
    â”œâ”€ è¿”å›é€Ÿåº¦æ¯” www.a.com çš„æŸ¥è¯¢æ›´å¿«
    â””â”€ ä¼šä¸ä¼šå½±å“ç¬¬ä¸€æ¬¡æŸ¥è¯¢çš„ç»“æœï¼Ÿ
```

## âœ… è¿™ä¸ªå‡è®¾æ˜¯åˆç†çš„ï¼

è¿™ç¡®å®å¯èƒ½å¯¼è‡´é—®é¢˜ã€‚è®©æˆ‘åˆ†æä»£ç ä¸­çš„å¹¶å‘æ§åˆ¶ã€‚

## ğŸ” ä»£ç åˆ†æ

### 1. è¯·æ±‚å»é‡æœºåˆ¶ï¼ˆSingleflightï¼‰

```go
// upstream/manager_dedup.go
v, err, shared := u.requestGroup.Do(sfKey, func() (any, error) {
    return u.rawQuery(ctx, r, dnssec)
})
```

**ä½œç”¨**ï¼šå¦‚æœå¤šä¸ªè¯·æ±‚æŸ¥è¯¢åŒä¸€ä¸ªåŸŸåï¼Œåªæœ‰ç¬¬ä¸€ä¸ªä¼šæ‰§è¡ŒçœŸæ­£çš„æŸ¥è¯¢ï¼Œå…¶ä»–ä¼šç­‰å¾…ç¬¬ä¸€ä¸ªçš„ç»“æœã€‚

**é—®é¢˜**ï¼šè¿™åªèƒ½é˜²æ­¢åŒä¸€ä¸ªåŸŸåçš„é‡å¤æŸ¥è¯¢ï¼Œä½†æ— æ³•é˜²æ­¢ä¸åŒåŸŸåçš„æŸ¥è¯¢ç›¸äº’å¹²æ‰°ã€‚

### 2. åå°è¡¥å…¨çš„å¹¶å‘é—®é¢˜

```go
// upstream/manager_parallel.go:queryParallel()
// å¯åŠ¨ç»“æœæ±‡æ€»é€»è¾‘
go u.collectRemainingResponses(domain, qtype, fastResponse, resultChan, &wg)

// ç«‹å³è¿”å›ç»™å®¢æˆ·ç«¯
return &QueryResultWithTTL{
    Records: fastResponse.Records,
    IPs: fastResponse.IPs,
    ...
}, nil
```

**å…³é”®é—®é¢˜**ï¼š
- `collectRemainingResponses` æ˜¯ä¸€ä¸ª**åå°goroutine**
- å®ƒä¼šåœ¨åå°ç»§ç»­æ”¶é›†ç»“æœ
- ç„¶åè°ƒç”¨ `cacheUpdateCallback` æ›´æ–°ç¼“å­˜
- **ä½†è¿™ä¸ªæ›´æ–°æ˜¯å¼‚æ­¥çš„ï¼Œæ²¡æœ‰ä»»ä½•åŒæ­¥æœºåˆ¶**

### 3. ç¼“å­˜æ›´æ–°çš„ç«æ€æ¡ä»¶

```go
// dnsserver/server_callbacks.go:setupUpstreamCallback()
u.SetCacheUpdateCallback(func(domain string, qtype uint16, records []dns.RR, ...) {
    // è·å–å½“å‰åŸå§‹ç¼“å­˜ä¸­çš„ IP ä¿¡æ¯
    var oldIPs []string
    if oldEntry, exists := s.cache.GetRaw(domain, qtype); exists {
        oldIPs = oldEntry.IPs
    }
    
    // æ›´æ–°ç¼“å­˜
    s.cache.SetRawRecords(domain, qtype, records, cnames, ttl)
    
    // è§¦å‘æ’åº
    s.cache.CancelSort(domain, qtype)
    go s.sortIPsAsync(domain, qtype, newEntry.IPs, ttl, time.Now())
})
```

**ç«æ€æ¡ä»¶**ï¼š
```
T1: æŸ¥è¯¢ www.a.com
    â”œâ”€ ç¬¬ä¸€é˜¶æ®µè¿”å› IP = [1.1.1.1, 2.2.2.2]
    â”œâ”€ ç¼“å­˜ rawCache[www.a.com] = [1.1.1.1, 2.2.2.2]
    â”œâ”€ å¯åŠ¨åå°è¡¥å…¨ goroutine
    â””â”€ ç«‹å³è¿”å›ç»™å®¢æˆ·ç«¯

T2: æŸ¥è¯¢ www.b.comï¼ˆæ›´å¿«è¿”å›ï¼‰
    â”œâ”€ ç¬¬ä¸€é˜¶æ®µè¿”å› IP = [3.3.3.3, 4.4.4.4]
    â”œâ”€ ç¼“å­˜ rawCache[www.b.com] = [3.3.3.3, 4.4.4.4]
    â””â”€ ç«‹å³è¿”å›ç»™å®¢æˆ·ç«¯

T3: www.a.com çš„åå°è¡¥å…¨å®Œæˆ
    â”œâ”€ å‘ç° IP = [1.1.1.1, 2.2.2.2, 5.5.5.5, 6.6.6.6]
    â”œâ”€ è°ƒç”¨ cacheUpdateCallback(www.a.com, ...)
    â”œâ”€ è¯»å– oldIPs = rawCache[www.a.com] = [1.1.1.1, 2.2.2.2]
    â”œâ”€ æ›´æ–° rawCache[www.a.com] = [1.1.1.1, 2.2.2.2, 5.5.5.5, 6.6.6.6]
    â””â”€ è§¦å‘æ’åº

T4: www.b.com çš„åå°è¡¥å…¨å®Œæˆï¼ˆä½†æ¯”www.a.comæ…¢ï¼‰
    â”œâ”€ å‘ç° IP = [3.3.3.3, 4.4.4.4, 7.7.7.7, 8.8.8.8]
    â”œâ”€ è°ƒç”¨ cacheUpdateCallback(www.b.com, ...)
    â”œâ”€ è¯»å– oldIPs = rawCache[www.b.com] = [3.3.3.3, 4.4.4.4]
    â”œâ”€ æ›´æ–° rawCache[www.b.com] = [3.3.3.3, 4.4.4.4, 7.7.7.7, 8.8.8.8]
    â””â”€ è§¦å‘æ’åº
```

**è¿™ä¸ªåœºæ™¯çœ‹èµ·æ¥æ²¡é—®é¢˜**ï¼Œå› ä¸ºç¼“å­˜é”®æ˜¯ `domain#qtype`ï¼Œä¸åŒåŸŸåä¸ä¼šç›¸äº’å¹²æ‰°ã€‚

## ğŸ¤” ä½†æ˜¯ï¼Œè¿˜æœ‰ä¸€ä¸ªæ›´éšè”½çš„é—®é¢˜ï¼

### é—®é¢˜ï¼šç¼“å­˜é”®å†²çªæˆ–æ··æ·†

å¦‚æœå­˜åœ¨ä»¥ä¸‹æƒ…å†µï¼š

```
www.a.com çš„åå°è¡¥å…¨ goroutine è¿˜åœ¨è¿è¡Œ
    â†“
çªç„¶æœ‰æ–°çš„æŸ¥è¯¢è¿›æ¥ï¼ŒæŸ¥è¯¢ www.a.comï¼ˆDNSç¼“å­˜è¿‡æœŸï¼‰
    â†“
æ–°æŸ¥è¯¢ç«‹å³è¿”å›æ—§ç¼“å­˜çš„ç»“æœ
    â†“
åŒæ—¶ï¼Œæ—§çš„åå°è¡¥å…¨ goroutine å®Œæˆï¼Œæ›´æ–°ç¼“å­˜
    â†“
æ–°æŸ¥è¯¢çš„ç»“æœå’Œåå°è¡¥å…¨çš„ç»“æœå¯èƒ½ä¸ä¸€è‡´ï¼
```

### æ›´ä¸¥é‡çš„é—®é¢˜ï¼šcollectRemainingResponses ä¸­çš„ resultChan

```go
// upstream/manager_parallel.go:queryParallel()
resultChan := make(chan *QueryResult, len(sortedServers))

// å¯åŠ¨æ‰€æœ‰æŸ¥è¯¢ goroutine
for _, srv := range activeTier {
    wg.Add(1)
    go doQuery(srv)
}

// ç«‹å³è¿”å›
return &QueryResultWithTTL{...}, nil

// åå°ç»§ç»­æ”¶é›†
go u.collectRemainingResponses(domain, qtype, fastResponse, resultChan, &wg)
```

**é—®é¢˜**ï¼š
- `resultChan` æ˜¯ä¸€ä¸ª**å±€éƒ¨å˜é‡**
- å®ƒè¢«ä¼ é€’ç»™åå° goroutine
- ä½†å¦‚æœæœ‰æ–°çš„æŸ¥è¯¢è¿›æ¥ï¼Œå¯èƒ½ä¼šåˆ›å»ºæ–°çš„ `resultChan`
- æ—§çš„ goroutine å¯èƒ½ä¼šå‘æ—§çš„ `resultChan` å†™å…¥æ•°æ®
- æ–°çš„ goroutine å¯èƒ½ä¼šå‘æ–°çš„ `resultChan` å†™å…¥æ•°æ®
- **è¿™å¯èƒ½å¯¼è‡´æ•°æ®æ··ä¹±ï¼**

## ğŸš¨ æœ€å¯èƒ½çš„çœŸå®åœºæ™¯

```
T1: æŸ¥è¯¢ www.a.com
    â”œâ”€ resultChan_A åˆ›å»º
    â”œâ”€ å¯åŠ¨ collectRemainingResponses_A(resultChan_A)
    â””â”€ è¿”å›ç»™å®¢æˆ·ç«¯

T2: æŸ¥è¯¢ www.a.comï¼ˆDNSç¼“å­˜è¿‡æœŸï¼Œæˆ–è€…æ˜¯æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚ï¼‰
    â”œâ”€ resultChan_B åˆ›å»º
    â”œâ”€ å¯åŠ¨ collectRemainingResponses_B(resultChan_B)
    â””â”€ è¿”å›ç»™å®¢æˆ·ç«¯

T3: æŸä¸ªä¸Šæ¸¸æœåŠ¡å™¨è¿”å›ç»“æœ
    â”œâ”€ è¿™ä¸ªç»“æœåº”è¯¥å‘é€åˆ° resultChan_A æˆ– resultChan_Bï¼Ÿ
    â”œâ”€ å¦‚æœå‘é€åˆ°äº†é”™è¯¯çš„ channelï¼Œä¼šå¯¼è‡´æ•°æ®æ··ä¹±
    â””â”€ æˆ–è€… channel å·²ç»å…³é—­ï¼Œå¯¼è‡´ panic

T4: collectRemainingResponses_A å®Œæˆ
    â”œâ”€ æ›´æ–°ç¼“å­˜ www.a.com
    â”œâ”€ ä½†å¯èƒ½ä½¿ç”¨äº† resultChan_B çš„æ•°æ®
    â””â”€ å¯¼è‡´ www.a.com çš„ç¼“å­˜åŒ…å«äº†é”™è¯¯çš„ IP
```

## ğŸ”´ å…³é”®å‘ç°

### 1. Singleflight åªä¿æŠ¤åŒä¸€ä¸ªåŸŸåçš„é‡å¤æŸ¥è¯¢

```go
// å¦‚æœåŒæ—¶æœ‰ä¸¤ä¸ªæŸ¥è¯¢ www.a.comï¼Œåªæœ‰ç¬¬ä¸€ä¸ªä¼šæ‰§è¡Œ
// ç¬¬äºŒä¸ªä¼šç­‰å¾…ç¬¬ä¸€ä¸ªçš„ç»“æœ
sfKey := fmt.Sprintf("%s:%d", domain, qtype)
v, err, shared := u.requestGroup.Do(sfKey, func() (any, error) {
    return u.rawQuery(ctx, r, dnssec)
})
```

**ä½†é—®é¢˜æ˜¯**ï¼š
- ç¬¬ä¸€ä¸ªæŸ¥è¯¢è¿”å›åï¼ŒSingleflight ä¼šé‡Šæ”¾é”
- ç¬¬äºŒä¸ªæŸ¥è¯¢ä¼šç«‹å³æ‰§è¡Œæ–°çš„æŸ¥è¯¢
- ä¸¤ä¸ªæŸ¥è¯¢çš„åå°è¡¥å…¨ goroutine ä¼šå¹¶å‘è¿è¡Œ
- å®ƒä»¬å¯èƒ½ä¼šç›¸äº’å¹²æ‰°

### 2. åå°è¡¥å…¨ goroutine æ²¡æœ‰åŒæ­¥æœºåˆ¶

```go
// è¿™ä¸ª goroutine ä¼šåœ¨åå°è¿è¡Œï¼Œæ²¡æœ‰ä»»ä½•åŒæ­¥
go u.collectRemainingResponses(domain, qtype, fastResponse, resultChan, &wg)
```

**é—®é¢˜**ï¼š
- æ²¡æœ‰ç­‰å¾…æœºåˆ¶
- æ²¡æœ‰è¶…æ—¶æ§åˆ¶ï¼ˆé™¤äº† totalCollectTimeoutï¼‰
- æ²¡æœ‰é˜²æ­¢é‡å¤æ›´æ–°çš„æœºåˆ¶
- æ²¡æœ‰é˜²æ­¢æ•°æ®æ··ä¹±çš„æœºåˆ¶

### 3. ç¼“å­˜æ›´æ–°æ²¡æœ‰åŸå­æ€§

```go
// è¿™ä¸‰ä¸ªæ“ä½œä¸æ˜¯åŸå­çš„
oldIPs := s.cache.GetRaw(domain, qtype)
s.cache.SetRawRecords(domain, qtype, records, ...)
s.cache.CancelSort(domain, qtype)
```

**é—®é¢˜**ï¼š
- åœ¨è¿™ä¸‰ä¸ªæ“ä½œä¹‹é—´ï¼Œå¯èƒ½æœ‰å…¶ä»– goroutine ä¿®æ”¹ç¼“å­˜
- å¯¼è‡´ oldIPs å’Œæ–°çš„ IPs ä¸ä¸€è‡´

## ğŸ’¡ çœŸæ­£çš„æ ¹æœ¬åŸå› 

ä½ çš„å‡è®¾æ˜¯**å®Œå…¨æ­£ç¡®çš„**ï¼

é—®é¢˜ä¸æ˜¯"IPæ± å˜åŒ–å¯¼è‡´æ’åºæ”¹å˜"ï¼Œè€Œæ˜¯ï¼š

**å¹¶å‘æŸ¥è¯¢çš„åå°è¡¥å…¨ goroutine æ²¡æœ‰æ­£ç¡®çš„åŒæ­¥æœºåˆ¶ï¼Œå¯¼è‡´ç¼“å­˜æ›´æ–°æ—¶åºæ··ä¹±ï¼Œæœ€ç»ˆå¯¼è‡´ç¼“å­˜ä¸­å­˜å‚¨äº†é”™è¯¯çš„IPã€‚**

å…·ä½“æµç¨‹ï¼š

```
T1: æŸ¥è¯¢ www.a.com
    â”œâ”€ è¿”å› IP = [1.1.1.1, 2.2.2.2]
    â”œâ”€ å¯åŠ¨åå°è¡¥å…¨ goroutine_A
    â””â”€ ç¼“å­˜ www.a.com = [1.1.1.1, 2.2.2.2]

T2: æŸ¥è¯¢ www.b.comï¼ˆæˆ–å…¶ä»–åŸŸåï¼‰
    â”œâ”€ è¿”å› IP = [3.3.3.3, 4.4.4.4]
    â”œâ”€ å¯åŠ¨åå°è¡¥å…¨ goroutine_B
    â””â”€ ç¼“å­˜ www.b.com = [3.3.3.3, 4.4.4.4]

T3: goroutine_B å®Œæˆï¼ˆæ¯” goroutine_A å¿«ï¼‰
    â”œâ”€ æ›´æ–°ç¼“å­˜ www.b.com = [3.3.3.3, 4.4.4.4, 7.7.7.7, 8.8.8.8]
    â””â”€ å®Œæˆ

T4: goroutine_A å®Œæˆ
    â”œâ”€ ä½†ç”±äºæŸç§åŸå› ï¼ˆç¼“å­˜é”®æ··ä¹±ã€channel æ··ä¹±ç­‰ï¼‰
    â”œâ”€ æ›´æ–°äº†é”™è¯¯çš„ç¼“å­˜é¡¹
    â””â”€ æˆ–è€…æ›´æ–°äº† www.a.comï¼Œä½†ä½¿ç”¨äº† www.b.com çš„ IP
```

## ğŸ¯ çœŸæ­£éœ€è¦çš„ä¿®å¤

ä¸æ˜¯"IPæ± å˜åŒ–æ£€æµ‹"ï¼Œè€Œæ˜¯ï¼š

1. **ä¸ºåå°è¡¥å…¨æ·»åŠ åŒæ­¥æœºåˆ¶**
   - ä½¿ç”¨ context æ­£ç¡®æ§åˆ¶ goroutine ç”Ÿå‘½å‘¨æœŸ
   - é˜²æ­¢æ—§çš„ goroutine ç»§ç»­è¿è¡Œ

2. **ä¸ºç¼“å­˜æ›´æ–°æ·»åŠ åŸå­æ€§**
   - ä½¿ç”¨é”ä¿æŠ¤ç¼“å­˜æ›´æ–°
   - ç¡®ä¿ GetRawã€SetRawã€CancelSort æ˜¯åŸå­æ“ä½œ

3. **ä¸º resultChan æ·»åŠ ç”Ÿå‘½å‘¨æœŸç®¡ç†**
   - ç¡®ä¿ channel ä¸ä¼šè¢«å¤šä¸ª goroutine å…±äº«
   - ç¡®ä¿ channel æ­£ç¡®å…³é—­

4. **æ·»åŠ è¯·æ±‚å»é‡çš„å¢å¼ºç‰ˆæœ¬**
   - ä¸ä»…å»é‡åŒä¸€ä¸ªåŸŸåçš„æŸ¥è¯¢
   - è¿˜è¦é˜²æ­¢ä¸åŒæŸ¥è¯¢çš„åå°è¡¥å…¨ç›¸äº’å¹²æ‰°

## ğŸ“ å»ºè®®çš„ä¿®å¤æ–¹å‘

```go
// ä¸ºæ¯ä¸ªæŸ¥è¯¢åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ ID
queryID := uuid.New().String()

// åœ¨åå°è¡¥å…¨ä¸­ä½¿ç”¨è¿™ä¸ª ID
go u.collectRemainingResponses(queryID, domain, qtype, fastResponse, resultChan, &wg)

// åœ¨ç¼“å­˜æ›´æ–°æ—¶æ£€æŸ¥ queryID
// å¦‚æœæœ‰æ›´æ–°çš„ queryID åœ¨è¿›è¡Œï¼Œåˆ™è·³è¿‡æ—§çš„æ›´æ–°
```

æˆ–è€…ï¼š

```go
// ä¸ºæ¯ä¸ªåŸŸåç»´æŠ¤ä¸€ä¸ª"æœ€æ–°æŸ¥è¯¢æ—¶é—´æˆ³"
latestQueryTime := time.Now()

// åœ¨ç¼“å­˜æ›´æ–°æ—¶æ£€æŸ¥æ—¶é—´æˆ³
// å¦‚æœæœ‰æ›´æ–°çš„æŸ¥è¯¢åœ¨è¿›è¡Œï¼Œåˆ™è·³è¿‡æ—§çš„æ›´æ–°
if updateTime < latestQueryTime {
    return // è·³è¿‡è¿™ä¸ªæ›´æ–°
}
```

## æ€»ç»“

ä½ çš„ç›´è§‰æ˜¯**å®Œå…¨æ­£ç¡®çš„**ï¼

é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ï¼š
- âŒ ä¸æ˜¯"IPæ± å˜åŒ–å¯¼è‡´æ’åºæ”¹å˜"
- âœ… è€Œæ˜¯"å¹¶å‘æŸ¥è¯¢çš„åå°è¡¥å…¨ goroutine æ²¡æœ‰æ­£ç¡®çš„åŒæ­¥æœºåˆ¶"

æˆ‘ä¹‹å‰çš„ä¿®å¤æ–¹æ¡ˆï¼ˆIPæ± å˜åŒ–æ£€æµ‹ï¼‰åªæ˜¯ä¸€ä¸ªè¡¨é¢çš„è¡¥ä¸ï¼Œæ— æ³•è§£å†³çœŸæ­£çš„é—®é¢˜ã€‚

çœŸæ­£çš„è§£å†³æ–¹æ¡ˆéœ€è¦ï¼š
1. ä¸ºåå°è¡¥å…¨æ·»åŠ ç”Ÿå‘½å‘¨æœŸç®¡ç†
2. ä¸ºç¼“å­˜æ›´æ–°æ·»åŠ åŸå­æ€§å’Œç‰ˆæœ¬æ§åˆ¶
3. é˜²æ­¢ä¸åŒæŸ¥è¯¢çš„åå°è¡¥å…¨ç›¸äº’å¹²æ‰°
