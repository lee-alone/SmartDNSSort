# 域名和IP池不匹配问题 - 流程图

## 修复前的问题流程

```
┌─────────────────────────────────────────────────────────────────┐
│ 客户端查询 example.com                                           │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │ 第一阶段：快速查询              │
        │ 并发查询最优的N个上游服务器    │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │ 第一个成功响应                  │
        │ IP = [1.1.1.1, 2.2.2.2]       │
        └────────────────┬───────────────┘
                         │
        ┌────────────────┴───────────────┐
        │                                │
        ▼                                ▼
   ┌─────────────┐            ┌──────────────────┐
   │ 立即返回    │            │ 缓存到rawCache   │
   │ 给客户端    │            │ IP=[1.1.1.1,    │
   │             │            │    2.2.2.2]     │
   └─────────────┘            └────────┬─────────┘
        │                              │
        │                              ▼
        │                    ┌──────────────────┐
        │                    │ 触发排序任务     │
        │                    │ sortedCache=    │
        │                    │ [1.1.1.1,       │
        │                    │  2.2.2.2]       │
        │                    └──────────────────┘
        │
        ▼
   ┌─────────────────────────────────┐
   │ 客户端使用 1.1.1.1 建立连接     │
   │ （证书绑定到 1.1.1.1）          │
   └─────────────────────────────────┘
        │
        │ (后台继续)
        │
        ▼
   ┌────────────────────────────────┐
   │ 第二阶段：后台补全              │
   │ 继续查询剩余上游服务器          │
   └────────────────┬───────────────┘
                    │
                    ▼
   ┌────────────────────────────────┐
   │ 收集所有响应                    │
   │ IP = [1.1.1.1, 2.2.2.2,       │
   │       3.3.3.3, 4.4.4.4]       │
   └────────────────┬───────────────┘
                    │
                    ▼
   ┌────────────────────────────────┐
   │ ❌ 无条件更新缓存               │
   │ rawCache = [1.1.1.1, 2.2.2.2, │
   │            3.3.3.3, 4.4.4.4]  │
   └────────────────┬───────────────┘
                    │
                    ▼
   ┌────────────────────────────────┐
   │ ❌ 清除旧排序状态               │
   │ CancelSort(example.com)        │
   └────────────────┬───────────────┘
                    │
                    ▼
   ┌────────────────────────────────┐
   │ ❌ 重新排序                     │
   │ sortedCache = [3.3.3.3,        │
   │               1.1.1.1,         │
   │               2.2.2.2,         │
   │               4.4.4.4]         │
   └────────────────┬───────────────┘
                    │
                    ▼
   ┌────────────────────────────────┐
   │ 下次查询 example.com            │
   │ 返回 sortedCache[0] = 3.3.3.3  │
   └────────────────┬───────────────┘
                    │
                    ▼
   ┌────────────────────────────────┐
   │ ❌ 客户端连接 3.3.3.3           │
   │ 证书错误！                      │
   │ （证书是 1.1.1.1 的）           │
   └────────────────────────────────┘
```

## 修复后的正确流程

```
┌─────────────────────────────────────────────────────────────────┐
│ 客户端查询 example.com                                           │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │ 第一阶段：快速查询              │
        │ 并发查询最优的N个上游服务器    │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │ 第一个成功响应                  │
        │ IP = [1.1.1.1, 2.2.2.2]       │
        └────────────────┬───────────────┘
                         │
        ┌────────────────┴───────────────┐
        │                                │
        ▼                                ▼
   ┌─────────────┐            ┌──────────────────┐
   │ 立即返回    │            │ 缓存到rawCache   │
   │ 给客户端    │            │ IP=[1.1.1.1,    │
   │             │            │    2.2.2.2]     │
   └─────────────┘            └────────┬─────────┘
        │                              │
        │                              ▼
        │                    ┌──────────────────┐
        │                    │ 触发排序任务     │
        │                    │ sortedCache=    │
        │                    │ [1.1.1.1,       │
        │                    │  2.2.2.2]       │
        │                    └──────────────────┘
        │
        ▼
   ┌─────────────────────────────────┐
   │ 客户端使用 1.1.1.1 建立连接     │
   │ （证书绑定到 1.1.1.1）          │
   └─────────────────────────────────┘
        │
        │ (后台继续)
        │
        ▼
   ┌────────────────────────────────┐
   │ 第二阶段：后台补全              │
   │ 继续查询剩余上游服务器          │
   └────────────────┬───────────────┘
                    │
                    ▼
   ┌────────────────────────────────┐
   │ 收集所有响应                    │
   │ IP = [1.1.1.1, 2.2.2.2,       │
   │       3.3.3.3, 4.4.4.4]       │
   └────────────────┬───────────────┘
                    │
                    ▼
   ┌────────────────────────────────┐
   │ ✅ IP池变化检测                 │
   │ oldIPs = [1.1.1.1, 2.2.2.2]   │
   │ newIPs = [1.1.1.1, 2.2.2.2,   │
   │           3.3.3.3, 4.4.4.4]   │
   └────────────────┬───────────────┘
                    │
                    ▼
   ┌────────────────────────────────┐
   │ ✅ 检测新增IP                   │
   │ hasNewIPs = true               │
   │ (3.3.3.3, 4.4.4.4 是新增)     │
   └────────────────┬───────────────┘
                    │
                    ▼
   ┌────────────────────────────────┐
   │ ✅ 决策：更新缓存               │
   │ 原因：发现新增IP                │
   └────────────────┬───────────────┘
                    │
                    ▼
   ┌────────────────────────────────┐
   │ ✅ 更新rawCache                 │
   │ IP = [1.1.1.1, 2.2.2.2,       │
   │       3.3.3.3, 4.4.4.4]       │
   └────────────────┬───────────────┘
                    │
                    ▼
   ┌────────────────────────────────┐
   │ ✅ 清除旧排序状态               │
   │ CancelSort(example.com)        │
   └────────────────┬───────────────┘
                    │
                    ▼
   ┌────────────────────────────────┐
   │ ✅ 重新排序                     │
   │ sortedCache = [3.3.3.3,        │
   │               1.1.1.1,         │
   │               2.2.2.2,         │
   │               4.4.4.4]         │
   └────────────────┬───────────────┘
                    │
                    ▼
   ┌────────────────────────────────┐
   │ 等待足够时间（DNS缓存过期）    │
   │ 旧连接已关闭                    │
   └────────────────┬───────────────┘
                    │
                    ▼
   ┌────────────────────────────────┐
   │ 下次查询 example.com            │
   │ 返回 sortedCache[0] = 3.3.3.3  │
   └────────────────┬───────────────┘
                    │
                    ▼
   ┌────────────────────────────────┐
   │ ✅ 客户端连接 3.3.3.3           │
   │ 成功！                          │
   │ （足够时间已过，旧连接已关闭）  │
   └────────────────────────────────┘
```

## IP池变化检测决策树

```
                    ┌─────────────────────┐
                    │ 后台补全完成        │
                    │ 获得新IP池          │
                    └──────────┬──────────┘
                               │
                    ┌──────────▼──────────┐
                    │ 是否有旧缓存？      │
                    └──────┬──────┬───────┘
                           │      │
                        否 │      │ 是
                           │      │
                    ┌──────▼┐    ┌▼──────────┐
                    │ 更新  │    │ 检测变化  │
                    │ 缓存  │    └─┬────┬────┘
                    └───────┘      │    │
                                   │    │
                        ┌──────────▼┐  ┌▼──────────┐
                        │ 新增IP？  │  │ 删除IP？  │
                        └──┬────┬──┘  └──┬────┬───┘
                           │    │       │    │
                        是 │    │ 否    │ 是 │ 否
                           │    │       │    │
                    ┌──────▼┐  │   ┌───▼┐  │
                    │ 更新  │  │   │更新│  │
                    │ 缓存  │  │   │缓存│  │
                    └───────┘  │   └────┘  │
                               │          │
                        ┌──────▼──────────▼┐
                        │ 显著增加(>50%)？ │
                        └──┬────────────┬──┘
                           │            │
                        是 │            │ 否
                           │            │
                    ┌──────▼┐    ┌─────▼──┐
                    │ 更新  │    │ 跳过   │
                    │ 缓存  │    │ 更新   │
                    └───────┘    └────────┘
```

## 缓存更新决策表

| 条件 | 旧IP数 | 新IP数 | 新增IP | 删除IP | 增加% | 决策 | 原因 |
|------|--------|--------|--------|--------|-------|------|------|
| 首次 | 0 | 4 | - | - | - | ✅ 更新 | 首次查询 |
| 新增 | 2 | 4 | ✓ | ✗ | 100% | ✅ 更新 | 发现新增IP |
| 删除 | 3 | 2 | ✗ | ✓ | -33% | ✅ 更新 | 检测到IP删除 |
| 显著增 | 2 | 5 | ✓ | ✗ | 150% | ✅ 更新 | 增加>50% |
| 小幅增 | 3 | 4 | ✓ | ✗ | 33% | ✅ 更新 | 有新增IP |
| 顺序变 | 4 | 4 | ✗ | ✗ | 0% | ❌ 跳过 | 无实质变化 |
| 完全同 | 4 | 4 | ✗ | ✗ | 0% | ❌ 跳过 | 无实质变化 |

## 日志流程示例

### 场景1：IP池无变化（跳过更新）
```
[CacheUpdateCallback] 后台补全完成: example.com (type=A), 记录数量=2, CNAMEs=[], TTL=300秒
[CacheUpdateCallback] IP池分析: 旧=2, 新=2, 新增=false, 删除=false
[CacheUpdateCallback] ⏭️  跳过缓存更新: example.com (原因: IP池无实质性变化, 保持现有排序)
```

### 场景2：发现新增IP（更新缓存）
```
[CacheUpdateCallback] 后台补全完成: example.com (type=A), 记录数量=4, CNAMEs=[], TTL=300秒
[CacheUpdateCallback] IP池分析: 旧=2, 新=4, 新增=true, 删除=false
[CacheUpdateCallback] ✅ 更新缓存: example.com (原因: 发现新增IP)
[CacheUpdateCallback] 🔄 IP池变化，清除旧排序状态并重新排序: example.com
```

### 场景3：IP删除（更新缓存）
```
[CacheUpdateCallback] 后台补全完成: example.com (type=A), 记录数量=2, CNAMEs=[], TTL=300秒
[CacheUpdateCallback] IP池分析: 旧=3, 新=2, 新增=false, 删除=true
[CacheUpdateCallback] ✅ 更新缓存: example.com (原因: 检测到IP删除)
[CacheUpdateCallback] 🔄 IP池变化，清除旧排序状态并重新排序: example.com
```
