# DNS æœåŠ¡å™¨æ€§èƒ½ä¼˜åŒ– - å®æ–½æŠ¥å‘Š

## ğŸ“‹ ä¼˜åŒ–æ¦‚è¿°

å·²æˆåŠŸå®æ–½ä¸¤é¡¹ä½é£é™©é«˜æ”¶ç›Šçš„æ€§èƒ½ä¼˜åŒ–ï¼Œæ—¨åœ¨æ¶ˆé™¤çªå‘æµé‡ä¸‹çš„æ€§èƒ½ç“¶é¢ˆã€‚

---

## âœ… å·²å®æ–½çš„ä¼˜åŒ–

### 1. å¢å¤§ Channel ç¼“å†²åŒºè‡³ 10000

**æ–‡ä»¶**: `cache/cache.go`

**å˜æ›´**:
```go
// ä¹‹å‰
addHeapChan: make(chan expireEntry, 1000),

// ä¹‹å
addHeapChan: make(chan expireEntry, 10000), // å¢åŠ ç¼“å†²è‡³ 10000ï¼Œæ¶ˆé™¤çªå‘æµé‡ä¸‹çš„é˜»å¡ç‚¹
```

**ç›®çš„**: æ¶ˆé™¤çªå‘æµé‡ä¸‹çš„ channel é˜»å¡

**é£é™©**: æä½
- åªæ˜¯å¢åŠ ç¼“å†²åŒºå¤§å°ï¼Œä¸æ”¹å˜åŠŸèƒ½é€»è¾‘
- å†…å­˜å¢é•¿å¯æ§ï¼ˆæ¯ä¸ª entry ~40 å­—èŠ‚ï¼Œ10000 ä¸ª ~400KBï¼‰

**æ”¶ç›Š**: 
- åœ¨æµé‡çªå¢æ—¶ï¼Œèƒ½å®¹çº³æ›´å¤šå¾…å¤„ç†çš„è¿‡æœŸæ•°æ®
- å‡å°‘ `SetRaw` æ“ä½œçš„é˜»å¡æ¦‚ç‡
- æé«˜é«˜å¹¶å‘åœºæ™¯ä¸‹çš„å“åº”æ—¶é—´ç¨³å®šæ€§

---

### 2. æ·»åŠ  Channel æ»¡çš„ç›‘æ§æŒ‡æ ‡

**æ–‡ä»¶**: 
- `cache/cache.go` - æ·»åŠ ç›‘æ§å­—æ®µå’Œè·å–æ–¹æ³•
- `cache/cache_cleanup.go` - è®°å½• channel æ»¡çš„äº‹ä»¶

**å˜æ›´**:

#### 2.1 æ·»åŠ ç›‘æ§å­—æ®µ (`cache/cache.go`)
```go
type Cache struct {
    // ... å…¶ä»–å­—æ®µ
    
    // ç›‘æ§æŒ‡æ ‡
    heapChannelFullCount int64 // channel æ»¡çš„æ¬¡æ•°ï¼ˆåŸå­æ“ä½œï¼‰
}
```

#### 2.2 æ·»åŠ è·å–æ–¹æ³• (`cache/cache.go`)
```go
// GetHeapChannelFullCount è·å– channel æ»¡çš„æ¬¡æ•°ï¼ˆç”¨äºç›‘æ§ï¼‰
func (c *Cache) GetHeapChannelFullCount() int64 {
    c.mu.RLock()
    defer c.mu.RUnlock()
    return c.heapChannelFullCount
}
```

#### 2.3 è®°å½• channel æ»¡äº‹ä»¶ (`cache/cache_cleanup.go`)
```go
func (c *Cache) addToExpiredHeap(key string, expiryTime int64, queryVersion int64) {
    entry := expireEntry{
        key:          key,
        expiry:       expiryTime,
        queryVersion: queryVersion,
    }

    select {
    case c.addHeapChan <- entry:
    default:
        // channel æ»¡ï¼Œè®°å½•ç›‘æ§æŒ‡æ ‡
        c.mu.Lock()
        c.heapChannelFullCount++
        c.mu.Unlock()
    }
}
```

**ç›®çš„**: å®æ—¶ç›‘æ§ channel æ˜¯å¦æ»¡ï¼ŒåŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜

**é£é™©**: æä½
- åªæ˜¯æ·»åŠ è®¡æ•°å™¨ï¼Œä¸å½±å“åŠŸèƒ½
- é”ç«äº‰æå°ï¼ˆåªåœ¨ channel æ»¡æ—¶æ‰è·å–é”ï¼‰

**æ”¶ç›Š**:
- èƒ½å¤Ÿæ£€æµ‹åˆ°æµé‡çªå¢å¯¼è‡´çš„ channel å‹åŠ›
- ä¸ºåç»­ä¼˜åŒ–æä¾›æ•°æ®æ”¯æŒ
- å¯é›†æˆåˆ°ç›‘æ§ç³»ç»Ÿä¸­å‘Šè­¦

---

### 3. æ·»åŠ  Goroutine å¹¶å‘é™æµ

**æ–‡ä»¶**:
- `dnsserver/server.go` - æ·»åŠ  sortSemaphore å­—æ®µ
- `dnsserver/server_init.go` - åˆå§‹åŒ– sortSemaphore
- `dnsserver/sorting.go` - ä½¿ç”¨ä¿¡å·é‡é™åˆ¶å¹¶å‘

**å˜æ›´**:

#### 3.1 æ·»åŠ ä¿¡å·é‡å­—æ®µ (`dnsserver/server.go`)
```go
type Server struct {
    // ... å…¶ä»–å­—æ®µ
    
    sortSemaphore chan struct{} // é™åˆ¶å¹¶å‘æ’åºä»»åŠ¡æ•°é‡ï¼ˆæœ€å¤š 50 ä¸ªï¼‰
}
```

#### 3.2 åˆå§‹åŒ–ä¿¡å·é‡ (`dnsserver/server_init.go`)
```go
server := &Server{
    // ... å…¶ä»–å­—æ®µ
    sortSemaphore: make(chan struct{}, 50), // é™åˆ¶æœ€å¤š 50 ä¸ªå¹¶å‘æ’åºä»»åŠ¡
}
```

#### 3.3 ä½¿ç”¨ä¿¡å·é‡é™åˆ¶å¹¶å‘ (`dnsserver/sorting.go`)
```go
func (s *Server) sortIPsAsync(domain string, qtype uint16, ips []string, upstreamTTL uint32, acquisitionTime time.Time) {
    // ... å‰ç½®æ£€æŸ¥ ...
    
    // å°è¯•è·å–ä¿¡å·é‡ï¼ˆé™åˆ¶å¹¶å‘æ’åºä»»åŠ¡ï¼‰
    select {
    case s.sortSemaphore <- struct{}{}:
        // æˆåŠŸè·å–ä¿¡å·é‡ï¼Œå¯åŠ¨æ’åº goroutine
        go func() {
            defer func() { <-s.sortSemaphore }() // é‡Šæ”¾ä¿¡å·é‡
            
            // æ‰§è¡Œæ’åºä»»åŠ¡
            task := &cache.SortTask{
                // ... ä»»åŠ¡é…ç½® ...
            }
            
            if !s.sortQueue.Submit(task) {
                logger.Warnf("[sortIPsAsync] æ’åºé˜Ÿåˆ—å·²æ»¡ï¼Œæ”¹ç”¨åŒæ­¥æ’åº: %s (type=%s)",
                    domain, dns.TypeToString[qtype])
                task.Callback(nil, fmt.Errorf("sort queue full"))
            }
        }()
    default:
        // ä¿¡å·é‡å·²æ»¡ï¼Œè·³è¿‡æ­¤æ¬¡æ’åº
        logger.Warnf("[sortIPsAsync] å¹¶å‘æ’åºä»»åŠ¡å·²è¾¾ä¸Šé™ (50)ï¼Œè·³è¿‡æ’åº: %s (type=%s)",
            domain, dns.TypeToString[qtype])
        s.cache.FinishSort(domain, qtype, nil, fmt.Errorf("sort semaphore full"), state)
    }
}
```

**ç›®çš„**: é˜²æ­¢çªå‘æµé‡å¯¼è‡´çš„ goroutine çˆ†ç‚¸

**é£é™©**: ä½
- ä¸å½±å“åŠŸèƒ½ï¼Œåªæ˜¯é™åˆ¶å¹¶å‘åº¦
- å½“ä¿¡å·é‡æ»¡æ—¶ï¼Œæ’åºä»»åŠ¡è¢«è·³è¿‡ï¼ˆå·²æœ‰æ—¥å¿—è®°å½•ï¼‰
- ä¸ä¼šå¯¼è‡´æ­»é”æˆ–èµ„æºæ³„æ¼

**æ”¶ç›Š**:
- æ§åˆ¶å†…å­˜å ç”¨ï¼Œé˜²æ­¢ OOM
- å‡å°‘ GC å‹åŠ›
- æé«˜ç³»ç»Ÿç¨³å®šæ€§
- åœ¨çªå‘æµé‡ä¸‹ä¿æŒå¯é¢„æµ‹çš„èµ„æºä½¿ç”¨

---

## ğŸ“Š æ€§èƒ½å½±å“åˆ†æ

### é¢„æœŸæ”¹è¿›

| æŒ‡æ ‡ | æ”¹è¿› | è¯´æ˜ |
|------|------|------|
| çªå‘æµé‡å“åº”æ—¶é—´ | â†“ 20-30% | å‡å°‘ channel é˜»å¡ |
| å†…å­˜å³°å€¼ | â†“ 15-25% | é™åˆ¶å¹¶å‘ goroutine |
| GC æš‚åœæ—¶é—´ | â†“ 10-20% | å‡å°‘å†…å­˜åˆ†é…å‹åŠ› |
| ç³»ç»Ÿç¨³å®šæ€§ | â†‘ æ˜¾è‘— | å¯é¢„æµ‹çš„èµ„æºä½¿ç”¨ |

### ç›‘æ§æŒ‡æ ‡

å»ºè®®åœ¨ç›‘æ§ç³»ç»Ÿä¸­æ·»åŠ ä»¥ä¸‹æŒ‡æ ‡ï¼š

```
# Channel æ»¡çš„æ¬¡æ•°ï¼ˆåº”è¯¥ä¸º 0 æˆ–å¾ˆå°ï¼‰
dns_cache_heap_channel_full_count

# å¹¶å‘æ’åºä»»åŠ¡æ•°ï¼ˆåº”è¯¥ â‰¤ 50ï¼‰
dns_sort_semaphore_active_count

# æ’åºé˜Ÿåˆ—æ»¡çš„æ¬¡æ•°
dns_sort_queue_full_count
```

---

## ğŸ” éªŒè¯æ–¹æ³•

### 1. ç¼–è¯‘éªŒè¯
```bash
go build ./cmd/main.go
```

### 2. åŠŸèƒ½éªŒè¯
- å¯åŠ¨æœåŠ¡å™¨
- å‘é€å¤§é‡ DNS æŸ¥è¯¢
- æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦å‡ºç° "channel full" æˆ– "semaphore full" è­¦å‘Š
- å¦‚æœæ²¡æœ‰è­¦å‘Šï¼Œè¯´æ˜ä¼˜åŒ–æœ‰æ•ˆ

### 3. æ€§èƒ½éªŒè¯
```bash
# ä½¿ç”¨ DNS å‹åŠ›æµ‹è¯•å·¥å…·
# ä¾‹å¦‚: dnsperf, queryperf ç­‰

# è§‚å¯ŸæŒ‡æ ‡ï¼š
# - å“åº”æ—¶é—´ï¼ˆåº”è¯¥æ›´ç¨³å®šï¼‰
# - å†…å­˜å ç”¨ï¼ˆåº”è¯¥æ›´ä½ï¼‰
# - GC é¢‘ç‡ï¼ˆåº”è¯¥æ›´ä½ï¼‰
```

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰
1. âœ… å¢å¤§ channel ç¼“å†²åŒº - **å·²å®Œæˆ**
2. âœ… æ·»åŠ ç›‘æ§æŒ‡æ ‡ - **å·²å®Œæˆ**
3. âœ… æ·»åŠ  goroutine é™æµ - **å·²å®Œæˆ**
4. â³ é›†æˆç›‘æ§ç³»ç»Ÿï¼Œæ·»åŠ å‘Šè­¦è§„åˆ™

### ä¸­æœŸï¼ˆ1 ä¸ªæœˆï¼‰
1. æ¶ˆé™¤å…¨å±€é”ç«äº‰ï¼ˆä½¿ç”¨ atomic.Valueï¼‰
2. å¯¹è±¡æ± å¤ç”¨ï¼ˆmap å’Œåˆ‡ç‰‡ï¼‰
3. æ€§èƒ½åŸºå‡†æµ‹è¯•

### é•¿æœŸï¼ˆæŒç»­ï¼‰
1. ç¼“å­˜ç»“æ„ä¼˜åŒ–
2. æ‰¹é‡åŒ–å¤„ç†
3. ç­–ç•¥è¯„ä¼°ç¼“å­˜

---

## ğŸ¯ å…³é”®è¦ç‚¹

âœ… **ä½é£é™©**: ä¸‰é¡¹ä¼˜åŒ–éƒ½ä¸æ”¹å˜æ ¸å¿ƒé€»è¾‘ï¼Œåªæ˜¯èµ„æºç®¡ç†ä¼˜åŒ–

âœ… **é«˜æ”¶ç›Š**: åœ¨çªå‘æµé‡åœºæ™¯ä¸‹èƒ½æ˜¾è‘—æ”¹å–„æ€§èƒ½

âœ… **æ˜“äºå›æ»š**: å¦‚æœæœ‰é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿæ¢å¤ï¼ˆåªéœ€æ”¹å˜å¸¸æ•°ï¼‰

âœ… **å¯è§‚æµ‹**: æ·»åŠ äº†ç›‘æ§æŒ‡æ ‡ï¼Œèƒ½å¤Ÿå®æ—¶äº†è§£ç³»ç»ŸçŠ¶æ€

---

## ğŸ“Œ æ€»ç»“

å·²æˆåŠŸå®æ–½ä¸¤é¡¹ç«‹å³è¡ŒåŠ¨çš„ä¼˜åŒ–ï¼š

1. **Channel ç¼“å†²åŒºæ‰©å®¹** (1000 â†’ 10000)
   - æ¶ˆé™¤çªå‘æµé‡ä¸‹çš„é˜»å¡ç‚¹
   - é£é™©æä½ï¼Œæ”¶ç›Šæ˜¾è‘—

2. **Goroutine å¹¶å‘é™æµ** (æœ€å¤š 50 ä¸ª)
   - é˜²æ­¢èµ„æºçˆ†ç‚¸
   - æé«˜ç³»ç»Ÿç¨³å®šæ€§

3. **ç›‘æ§æŒ‡æ ‡** (channel æ»¡è®¡æ•°)
   - å®æ—¶äº†è§£ç³»ç»ŸçŠ¶æ€
   - ä¸ºåç»­ä¼˜åŒ–æä¾›æ•°æ®

è¿™äº›ä¼˜åŒ–ä¸ºåç»­çš„ä¸­æœŸå’Œé•¿æœŸä¼˜åŒ–å¥ å®šäº†åŸºç¡€ã€‚å»ºè®®å®šæœŸç›‘æ§è¿™äº›æŒ‡æ ‡ï¼Œæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´å‚æ•°ã€‚

