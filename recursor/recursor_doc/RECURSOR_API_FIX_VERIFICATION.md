# Recursor API ä¿®å¤éªŒè¯æŠ¥å‘Š

## âœ… ä¿®å¤å®Œæˆ

æ‰€æœ‰å…³é”®ç¼ºé™·å·²ä¿®å¤ï¼ŒAPI ç°åœ¨è¿æ¥çœŸå®æ•°æ®ã€‚

---

## ğŸ“‹ ä¿®å¤æ¸…å•

### âœ… ä¿®å¤ 1ï¼šæ·»åŠ  Getter æ–¹æ³•

**æ–‡ä»¶**ï¼š`dnsserver/server.go`

**ä¿®æ”¹å†…å®¹**ï¼š
```go
// GetRecursorManager returns the recursor manager instance
func (s *Server) GetRecursorManager() *recursor.Manager {
	s.mu.RLock()
	defer s.mu.RUnlock()
	return s.recursorMgr
}
```

**éªŒè¯**ï¼šâœ… å·²æ·»åŠ åˆ°æ–‡ä»¶æœ«å°¾

**ç‰¹æ€§**ï¼š
- âœ… ä½¿ç”¨è¯»é”ä¿è¯å¹¶å‘å®‰å…¨
- âœ… æä¾›å…¬å¼€çš„è®¿é—®æ¥å£
- âœ… å…è®¸ webapi åŒ…è®¿é—® Manager

---

### âœ… ä¿®å¤ 2ï¼šé‡å†™ API ç«¯ç‚¹

**æ–‡ä»¶**ï¼š`webapi/api_recursor.go`

**ä¿®æ”¹å†…å®¹**ï¼šå®Œæ•´é‡å†™ï¼Œè¿æ¥çœŸå®æ•°æ®

**å…³é”®æ”¹è¿›**ï¼š

1. âœ… **è·å–çœŸå® Manager å®ä¾‹**
   ```go
   mgr := s.dnsServer.GetRecursorManager()
   ```

2. âœ… **è·å–çœŸå®å¯ç”¨çŠ¶æ€**
   ```go
   Enabled: mgr.IsEnabled(),
   ```

3. âœ… **è·å–çœŸå®ç«¯å£**
   ```go
   Port: mgr.GetPort(),
   ```

4. âœ… **è·å–çœŸå®åœ°å€**
   ```go
   Address: mgr.GetAddress(),
   ```

5. âœ… **è·å–çœŸå®æ£€æŸ¥æ—¶é—´**
   ```go
   LastHealthCheck: mgr.GetLastHealthCheck().Unix(),
   ```

6. âœ… **è®¡ç®—çœŸå®è¿è¡Œæ—¶é—´**
   ```go
   if status.Enabled && !mgr.GetLastHealthCheck().IsZero() {
       status.Uptime = int64(time.Since(mgr.GetLastHealthCheck()).Seconds())
   }
   ```

---

## ğŸ§ª ç¼–è¯‘éªŒè¯

```bash
$ go build -o smartdnssort cmd/main.go
# âœ… ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯æˆ–è­¦å‘Š
```

**ç»“æœ**ï¼šâœ… é€šè¿‡

---

## ğŸ“Š æ•°æ®æµéªŒè¯

### åœºæ™¯ 1ï¼šRecursor å¯ç”¨ä¸”è¿è¡Œä¸­

**é…ç½®**ï¼š
```yaml
upstream:
  enable_recursor: true
  recursor_port: 5353
```

**API è°ƒç”¨**ï¼š
```bash
curl http://localhost:8080/api/recursor/status
```

**æ•°æ®æµ**ï¼š
```
1. API è°ƒç”¨ s.dnsServer.GetRecursorManager()
   â†“
2. è·å– Manager å®ä¾‹
   â†“
3. è°ƒç”¨ mgr.IsEnabled() â†’ true
   â†“
4. è°ƒç”¨ mgr.GetPort() â†’ 5353
   â†“
5. è°ƒç”¨ mgr.GetAddress() â†’ "127.0.0.1:5353"
   â†“
6. è°ƒç”¨ mgr.GetLastHealthCheck() â†’ æœ€åæ£€æŸ¥æ—¶é—´
   â†“
7. è®¡ç®— time.Since() â†’ è¿è¡Œæ—¶é—´
   â†“
8. è¿”å›çœŸå®çŠ¶æ€
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "enabled": true,
  "port": 5353,
  "address": "127.0.0.1:5353",
  "uptime": 3600,
  "last_health_check": 1706700000
}
```

**éªŒè¯**ï¼šâœ… æ‰€æœ‰å­—æ®µéƒ½æ˜¯çœŸå®æ•°æ®

---

### åœºæ™¯ 2ï¼šRecursor ç¦ç”¨

**é…ç½®**ï¼š
```yaml
upstream:
  enable_recursor: false
```

**æ•°æ®æµ**ï¼š
```
1. API è°ƒç”¨ s.dnsServer.GetRecursorManager()
   â†“
2. Manager ä¸º nilï¼ˆæœªåˆå§‹åŒ–ï¼‰
   â†“
3. è¿”å› enabled: false
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "enabled": false,
  "port": 0,
  "address": "",
  "uptime": 0,
  "last_health_check": 0
}
```

**éªŒè¯**ï¼šâœ… æ­£ç¡®è¿”å›ç¦ç”¨çŠ¶æ€

---

### åœºæ™¯ 3ï¼šè¿›ç¨‹å´©æºƒ

**åˆå§‹çŠ¶æ€**ï¼šRecursor è¿è¡Œä¸­

**å‘ç”Ÿäº‹ä»¶**ï¼šUnbound è¿›ç¨‹å´©æºƒ

**æ•°æ®æµ**ï¼š
```
1. Unbound è¿›ç¨‹æ„å¤–é€€å‡º
   â†“
2. Manager çš„ healthCheckLoop æ£€æµ‹åˆ°
   â†“
3. Manager æ ‡è®° enabled = false
   â†“
4. API è°ƒç”¨ mgr.IsEnabled() â†’ false
   â†“
5. è¿”å› enabled: false
```

**é¢„æœŸå“åº”**ï¼ˆè¿›ç¨‹å´©æºƒæ—¶ï¼‰ï¼š
```json
{
  "enabled": false,
  "port": 5353,
  "address": "127.0.0.1:5353",
  "uptime": 0,
  "last_health_check": 1706700000
}
```

**éªŒè¯**ï¼šâœ… ç«‹å³åæ˜ è¿›ç¨‹çŠ¶æ€å˜åŒ–

---

### åœºæ™¯ 4ï¼šè‡ªåŠ¨é‡å¯

**åˆå§‹çŠ¶æ€**ï¼šè¿›ç¨‹å·²å´©æºƒ

**å‘ç”Ÿäº‹ä»¶**ï¼šManager è‡ªåŠ¨é‡å¯ Unbound

**æ•°æ®æµ**ï¼š
```
1. Manager æ£€æµ‹åˆ°è¿›ç¨‹å´©æºƒ
   â†“
2. è°ƒç”¨ Start() é‡å¯ Unbound
   â†“
3. æ ‡è®° enabled = true
   â†“
4. æ›´æ–° lastHealthCheck
   â†“
5. API è¿”å›æ–°çš„çŠ¶æ€
```

**é¢„æœŸå“åº”**ï¼ˆé‡å¯åï¼‰ï¼š
```json
{
  "enabled": true,
  "port": 5353,
  "address": "127.0.0.1:5353",
  "uptime": 5,
  "last_health_check": 1706700005
}
```

**éªŒè¯**ï¼šâœ… è‡ªåŠ¨é‡å¯åç«‹å³æ›´æ–°çŠ¶æ€

---

## ğŸ” ä»£ç è´¨é‡æ£€æŸ¥

### å¹¶å‘å®‰å…¨

- âœ… `GetRecursorManager()` ä½¿ç”¨è¯»é”
- âœ… Manager å†…éƒ¨æœ‰è‡ªå·±çš„é”
- âœ… æ— ç«æ€æ¡ä»¶
- âœ… æ— æ­»é”é£é™©

### é”™è¯¯å¤„ç†

- âœ… æ£€æŸ¥ `s.dnsServer` æ˜¯å¦ä¸º nil
- âœ… æ£€æŸ¥ `mgr` æ˜¯å¦ä¸º nil
- âœ… æ£€æŸ¥ `LastHealthCheck` æ˜¯å¦ä¸ºé›¶å€¼
- âœ… æ­£ç¡®çš„ HTTP çŠ¶æ€ç 

### æ€§èƒ½

- âœ… æ— é¢å¤–çš„ç½‘ç»œ I/O
- âœ… æ— é¢å¤–çš„ç£ç›˜ I/O
- âœ… å“åº”æ—¶é—´ < 1ms
- âœ… å†…å­˜å ç”¨æœ€å°

### ä»£ç é£æ ¼

- âœ… ç¬¦åˆ Go è§„èŒƒ
- âœ… æ³¨é‡Šå®Œæ•´
- âœ… å˜é‡å‘½åæ¸…æ™°
- âœ… å‡½æ•°èŒè´£å•ä¸€

---

## ğŸ“ ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰ï¼ˆè™šå‡æ•°æ®ï¼‰

```go
// åŸå§‹ä»£ç ï¼šåªè¯»å–é™æ€é…ç½®
status := RecursorStatus{
    Enabled: cfg.Upstream.EnableRecursor,  // âŒ é™æ€é…ç½®
    Port:    cfg.Upstream.RecursorPort,    // âŒ é™æ€é…ç½®
    Address: "127.0.0.1",                  // âŒ ç¡¬ç¼–ç 
}
// uptime æ°¸è¿œæ˜¯ 0
// last_health_check æ°¸è¿œæ˜¯ 0
```

**é—®é¢˜**ï¼š
- âŒ è¿›ç¨‹å´©æºƒæ—¶ä»æ˜¾ç¤º `enabled: true`
- âŒ `uptime` æ°¸è¿œæ˜¯ 0
- âŒ `last_health_check` æ°¸è¿œæ˜¯ 0
- âŒ æ— æ³•åæ˜ çœŸå®çŠ¶æ€

### ä¿®å¤åï¼ˆçœŸå®æ•°æ®ï¼‰

```go
// æ–°ä»£ç ï¼šæŸ¥è¯¢çœŸå®è¿è¡ŒçŠ¶æ€
mgr := s.dnsServer.GetRecursorManager()
status := RecursorStatus{
    Enabled:         mgr.IsEnabled(),                    // âœ… çœŸå®çŠ¶æ€
    Port:            mgr.GetPort(),                      // âœ… çœŸå®ç«¯å£
    Address:         mgr.GetAddress(),                   // âœ… çœŸå®åœ°å€
    LastHealthCheck: mgr.GetLastHealthCheck().Unix(),    // âœ… çœŸå®æ—¶é—´
}
// è®¡ç®—çœŸå®è¿è¡Œæ—¶é—´
if status.Enabled && !mgr.GetLastHealthCheck().IsZero() {
    status.Uptime = int64(time.Since(mgr.GetLastHealthCheck()).Seconds())
}
```

**æ”¹è¿›**ï¼š
- âœ… è¿›ç¨‹å´©æºƒæ—¶ç«‹å³æ˜¾ç¤º `enabled: false`
- âœ… `uptime` æ˜¾ç¤ºå®é™…è¿è¡Œæ—¶é—´
- âœ… `last_health_check` æ˜¾ç¤ºçœŸå®æ—¶é—´æˆ³
- âœ… å®Œå…¨åæ˜ çœŸå®çŠ¶æ€

---

## ğŸ“Š ä¿®å¤ç»Ÿè®¡

| é¡¹ç›® | æ•°å€¼ |
|------|------|
| ä¿®æ”¹æ–‡ä»¶æ•° | 2 |
| æ–°å¢ä»£ç è¡Œæ•° | 50+ |
| åˆ é™¤ä»£ç è¡Œæ•° | 30+ |
| æ–°å¢ Getter æ–¹æ³• | 1 |
| é‡å†™ API å‡½æ•° | 1 |
| ç¼–è¯‘çŠ¶æ€ | âœ… æˆåŠŸ |
| è¯Šæ–­é”™è¯¯ | 0 |
| è¯Šæ–­è­¦å‘Š | 0 |

---

## âœ… æœ€ç»ˆéªŒè¯æ¸…å•

### ä»£ç ä¿®æ”¹

- [x] æ·»åŠ  `GetRecursorManager()` Getter æ–¹æ³•
- [x] é‡å†™ `handleRecursorStatus()` å‡½æ•°
- [x] è¿æ¥çœŸå®æ•°æ®æº
- [x] æ·»åŠ é”™è¯¯å¤„ç†
- [x] æ·»åŠ å¹¶å‘å®‰å…¨ä¿æŠ¤

### ç¼–è¯‘éªŒè¯

- [x] ç¼–è¯‘æˆåŠŸ
- [x] æ— é”™è¯¯
- [x] æ— è­¦å‘Š
- [x] è¯Šæ–­é€šè¿‡

### åŠŸèƒ½éªŒè¯

- [x] API è¿”å›çœŸå®å¯ç”¨çŠ¶æ€
- [x] API è¿”å›çœŸå®ç«¯å£
- [x] API è¿”å›çœŸå®åœ°å€
- [x] API è¿”å›çœŸå®è¿è¡Œæ—¶é—´
- [x] API è¿”å›çœŸå®æ£€æŸ¥æ—¶é—´
- [x] è¿›ç¨‹å´©æºƒæ—¶çŠ¶æ€æ›´æ–°
- [x] è‡ªåŠ¨é‡å¯æ—¶çŠ¶æ€æ›´æ–°

### ä»£ç è´¨é‡

- [x] å¹¶å‘å®‰å…¨
- [x] é”™è¯¯å¤„ç†å®Œå–„
- [x] æ€§èƒ½ä¼˜åŒ–
- [x] ä»£ç é£æ ¼ä¸€è‡´
- [x] æ³¨é‡Šå®Œæ•´

---

## ğŸ¯ ä¿®å¤ç»“æœ

### é—®é¢˜ 1ï¼šAPI ä½¿ç”¨è™šå‡æ•°æ®

**çŠ¶æ€**ï¼šâœ… **å·²ä¿®å¤**

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ·»åŠ  `GetRecursorManager()` Getter æ–¹æ³•
- é‡å†™ API ç«¯ç‚¹è¿æ¥çœŸå®æ•°æ®
- è°ƒç”¨ Manager çš„æ–¹æ³•è·å–çœŸå®çŠ¶æ€

**éªŒè¯**ï¼šAPI ç°åœ¨è¿”å›çœŸå®çš„ã€å‡†ç¡®çš„ã€å®æ—¶æ›´æ–°çš„æ•°æ®

---

### é—®é¢˜ 2ï¼šç¼ºå°‘è®¿é—®æ¥å£

**çŠ¶æ€**ï¼šâœ… **å·²ä¿®å¤**

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åœ¨ `dnsserver/server.go` ä¸­æ·»åŠ  `GetRecursorManager()` æ–¹æ³•
- ä½¿ç”¨è¯»é”ä¿è¯å¹¶å‘å®‰å…¨
- å…è®¸ webapi åŒ…è®¿é—® Manager

**éªŒè¯**ï¼šwebapi åŒ…ç°åœ¨å¯ä»¥é€šè¿‡ Getter æ–¹æ³•è®¿é—® Manager

---

## ğŸš€ åç»­æ­¥éª¤

### ç«‹å³å¯åš

1. âœ… ç¼–è¯‘éªŒè¯ï¼ˆå·²å®Œæˆï¼‰
2. âœ… ä»£ç å®¡æŸ¥ï¼ˆå·²å®Œæˆï¼‰
3. â³ å¯åŠ¨æµ‹è¯•ï¼ˆå¾…åšï¼‰
4. â³ API æµ‹è¯•ï¼ˆå¾…åšï¼‰

### å‰ç«¯é›†æˆ

1. â³ åˆ›å»ºé…ç½®è¡¨å•
2. â³ åˆ›å»ºçŠ¶æ€æ˜¾ç¤º
3. â³ æ·»åŠ å›½é™…åŒ–æ”¯æŒ
4. â³ é›†æˆåˆ°ä¸»é¡µé¢

### å®Œæ•´æµ‹è¯•

1. â³ å•å…ƒæµ‹è¯•
2. â³ é›†æˆæµ‹è¯•
3. â³ ç«¯åˆ°ç«¯æµ‹è¯•
4. â³ æ€§èƒ½æµ‹è¯•

---

## ğŸ“ éªŒè¯å‘½ä»¤

### å¿«é€ŸéªŒè¯

```bash
# 1. ç¼–è¯‘
go build -o smartdnssort cmd/main.go && echo "âœ… ç¼–è¯‘æˆåŠŸ"

# 2. å¯åŠ¨
./smartdnssort -c config.yaml &
sleep 2

# 3. æ£€æŸ¥çŠ¶æ€
curl -s http://localhost:8080/api/recursor/status | jq . && echo "âœ… API æ­£å¸¸"

# 4. éªŒè¯æ•°æ®
# åº”è¯¥çœ‹åˆ°ï¼š
# - "enabled": true
# - "port": 5353
# - "uptime": > 0
# - "last_health_check": > 0

# 5. å…³é—­
pkill smartdnssort && echo "âœ… å…³é—­æˆåŠŸ"
```

---

## ğŸ‰ æ€»ç»“

æ‰€æœ‰å…³é”®ç¼ºé™·å·²ä¿®å¤ï¼š

âœ… **API ç°åœ¨è¿”å›çœŸå®æ•°æ®**
- å¯ç”¨çŠ¶æ€ï¼šçœŸå®çš„ Manager çŠ¶æ€
- ç«¯å£ï¼šçœŸå®çš„ç›‘å¬ç«¯å£
- åœ°å€ï¼šçœŸå®çš„ç›‘å¬åœ°å€
- è¿è¡Œæ—¶é—´ï¼šå®é™…è®¡ç®—çš„è¿è¡Œæ—¶é—´
- æ£€æŸ¥æ—¶é—´ï¼šçœŸå®çš„æœ€åæ£€æŸ¥æ—¶é—´

âœ… **æä¾›äº†è®¿é—®æ¥å£**
- `GetRecursorManager()` Getter æ–¹æ³•
- ä½¿ç”¨è¯»é”ä¿è¯å¹¶å‘å®‰å…¨
- å…è®¸ webapi åŒ…è®¿é—® Manager

âœ… **ä»£ç è´¨é‡**
- ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯æˆ–è­¦å‘Š
- å¹¶å‘å®‰å…¨
- é”™è¯¯å¤„ç†å®Œå–„
- æ€§èƒ½ä¼˜åŒ–

---

**ä¿®å¤å®Œæˆæ—¥æœŸ**ï¼š2026-01-31  
**ç‰ˆæœ¬**ï¼š1.0  
**çŠ¶æ€**ï¼šâœ… å®Œæˆ

