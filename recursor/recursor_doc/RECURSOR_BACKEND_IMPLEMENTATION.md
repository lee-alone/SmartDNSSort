# Recursor åç«¯å®ç°å®ŒæˆæŠ¥å‘Š

## ğŸ“Š å®ç°çŠ¶æ€ï¼šâœ… **å·²å®Œæˆ**

é€’å½’è§£æå™¨ï¼ˆRecursorï¼‰çš„åç«¯é›†æˆå·²å…¨éƒ¨å®Œæˆã€‚æ‰€æœ‰å…³é”®ç»„ä»¶å·²é›†æˆåˆ° DNS æœåŠ¡å™¨ä¸­ã€‚

---

## ğŸ¯ å®ç°æ¦‚è§ˆ

### æ ¸å¿ƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DNS æœåŠ¡å™¨å¯åŠ¨                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. åˆå§‹åŒ– Recursor Managerï¼ˆå¦‚æœå¯ç”¨ï¼‰                      â”‚
â”‚  2. å¯åŠ¨ Unbound è¿›ç¨‹                                        â”‚
â”‚  3. ç›‘æ§è¿›ç¨‹çŠ¶æ€å’Œè‡ªåŠ¨é‡å¯                                   â”‚
â”‚  4. æä¾› API ç«¯ç‚¹æŸ¥è¯¢çŠ¶æ€                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ å®ç°è¯¦æƒ…

### 1. DNS æœåŠ¡å™¨é›†æˆ âœ…

**æ–‡ä»¶**ï¼š`dnsserver/server.go`

#### æ·»åŠ çš„å¯¼å…¥
```go
"smartdnssort/recursor"
```

#### æ·»åŠ çš„å­—æ®µ
```go
type Server struct {
    // ... ç°æœ‰å­—æ®µ
    recursorMgr *recursor.Manager  // åµŒå…¥å¼é€’å½’è§£æå™¨ç®¡ç†å™¨
}
```

**ä½œç”¨**ï¼š
- å­˜å‚¨ Recursor Manager å®ä¾‹
- ç®¡ç† Unbound è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ
- æä¾›çŠ¶æ€æŸ¥è¯¢æ¥å£

---

### 2. åˆå§‹åŒ–é€»è¾‘ âœ…

**æ–‡ä»¶**ï¼š`dnsserver/server_init.go`

#### æ·»åŠ çš„å¯¼å…¥
```go
"smartdnssort/recursor"
```

#### æ·»åŠ çš„åˆå§‹åŒ–ä»£ç 
```go
// åˆå§‹åŒ–åµŒå…¥å¼é€’å½’è§£æå™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
if cfg.Upstream.EnableRecursor {
    recursorPort := cfg.Upstream.RecursorPort
    if recursorPort == 0 {
        recursorPort = 5353
    }
    server.recursorMgr = recursor.NewManager(recursorPort)
    logger.Infof("[Recursor] Manager initialized for port %d", recursorPort)
}
```

**æ‰§è¡Œæ—¶æœº**ï¼š`NewServer()` å‡½æ•°æœ«å°¾

**é€»è¾‘æµç¨‹**ï¼š
1. æ£€æŸ¥é…ç½®ä¸­æ˜¯å¦å¯ç”¨ Recursor
2. è·å–é…ç½®çš„ç«¯å£ï¼ˆé»˜è®¤ 5353ï¼‰
3. åˆ›å»º Manager å®ä¾‹
4. è®°å½•åˆå§‹åŒ–æ—¥å¿—

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… æ¡ä»¶åˆå§‹åŒ–ï¼ˆä»…åœ¨å¯ç”¨æ—¶åˆ›å»ºï¼‰
- âœ… ç«¯å£é»˜è®¤å€¼å¤„ç†
- âœ… æ—¥å¿—è®°å½•ä¾¿äºè°ƒè¯•

---

### 3. å¯åŠ¨é€»è¾‘ âœ…

**æ–‡ä»¶**ï¼š`dnsserver/server_lifecycle.go`

#### åœ¨ `Start()` å‡½æ•°ä¸­æ·»åŠ 

```go
// å¯åŠ¨åµŒå…¥å¼é€’å½’è§£æå™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
if s.recursorMgr != nil {
    if err := s.recursorMgr.Start(); err != nil {
        logger.Warnf("[Recursor] Failed to start recursor: %v", err)
    } else {
        logger.Infof("[Recursor] Recursor started on %s", s.recursorMgr.GetAddress())
    }
}
```

**æ‰§è¡Œæ—¶æœº**ï¼šåœ¨ Prefetcher å¯åŠ¨ä¹‹å

**å¯åŠ¨æµç¨‹**ï¼š
1. æ£€æŸ¥ Manager æ˜¯å¦å­˜åœ¨
2. è°ƒç”¨ `Start()` å¯åŠ¨ Unbound è¿›ç¨‹
3. å¤„ç†å¯åŠ¨é”™è¯¯ï¼ˆè®°å½•è­¦å‘Šä½†ä¸ä¸­æ–­ï¼‰
4. è®°å½•æˆåŠŸå¯åŠ¨æ—¥å¿—

**é”™è¯¯å¤„ç†**ï¼š
- å¯åŠ¨å¤±è´¥ä¸ä¼šå¯¼è‡´ DNS æœåŠ¡å™¨å¯åŠ¨å¤±è´¥
- ç”¨æˆ·å¯ä»¥é€šè¿‡ API æŸ¥è¯¢å¤±è´¥åŸå› 
- æ”¯æŒåç»­æ‰‹åŠ¨é‡å¯

---

### 4. å…³é—­é€»è¾‘ âœ…

**æ–‡ä»¶**ï¼š`dnsserver/server_lifecycle.go`

#### åœ¨ `Shutdown()` å‡½æ•°ä¸­æ·»åŠ 

```go
// åœæ­¢åµŒå…¥å¼é€’å½’è§£æå™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
if s.recursorMgr != nil {
    if err := s.recursorMgr.Stop(); err != nil {
        logger.Warnf("[Recursor] Failed to stop recursor: %v", err)
    } else {
        logger.Info("[Recursor] Recursor stopped successfully.")
    }
}
```

**æ‰§è¡Œæ—¶æœº**ï¼šåœ¨å…³é—­ä¸Šæ¸¸è¿æ¥æ± ä¹‹å‰

**å…³é—­æµç¨‹**ï¼š
1. æ£€æŸ¥ Manager æ˜¯å¦å­˜åœ¨
2. è°ƒç”¨ `Stop()` åœæ­¢ Unbound è¿›ç¨‹
3. å¤„ç†åœæ­¢é”™è¯¯ï¼ˆè®°å½•è­¦å‘Šï¼‰
4. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
5. è®°å½•æˆåŠŸå…³é—­æ—¥å¿—

**ä¼˜é›…å…³é—­**ï¼š
- âœ… å‘é€ SIGTERM ä¿¡å·ç»™ Unbound
- âœ… ç­‰å¾…è¿›ç¨‹æ­£å¸¸é€€å‡ºï¼ˆæœ€å¤š 5 ç§’ï¼‰
- âœ… è¶…æ—¶åå¼ºåˆ¶ KILL
- âœ… æ¸…ç†ä¸´æ—¶æ–‡ä»¶

---

## ğŸ”§ é…ç½®ç³»ç»Ÿ

### é…ç½®å­—æ®µ

**æ–‡ä»¶**ï¼š`config/config_types.go`ï¼ˆç¬¬ 55-56 è¡Œï¼‰

```go
type UpstreamConfig struct {
    // ... ç°æœ‰å­—æ®µ
    
    // Recursor é…ç½®
    EnableRecursor bool `yaml:"enable_recursor,omitempty" json:"enable_recursor"`
    RecursorPort   int  `yaml:"recursor_port,omitempty" json:"recursor_port"`
}
```

### é»˜è®¤å€¼

**æ–‡ä»¶**ï¼š`config/config_defaults.go`ï¼ˆç¬¬ 91-92 è¡Œï¼‰

```go
// Recursor é»˜è®¤é…ç½®
if cfg.RecursorPort == 0 {
    cfg.RecursorPort = 5353
}
```

### é…ç½®ç¤ºä¾‹

```yaml
upstream:
  servers:
    - "8.8.8.8:53"
    - "1.1.1.1:53"
  
  # å¯ç”¨åµŒå…¥å¼é€’å½’è§£æå™¨
  enable_recursor: true
  recursor_port: 5353
  
  strategy: "parallel"
  timeout_ms: 5000
```

---

## ğŸŒ API ç«¯ç‚¹

### è·å– Recursor çŠ¶æ€

**ç«¯ç‚¹**ï¼š`GET /api/recursor/status`

**å®ç°**ï¼š`webapi/api_recursor.go`

**è¯·æ±‚**ï¼š
```bash
curl http://localhost:8080/api/recursor/status
```

**å“åº”**ï¼š
```json
{
  "enabled": true,
  "port": 5353,
  "address": "127.0.0.1:5353",
  "uptime": 7200,
  "last_health_check": 1706700000
}
```

**å“åº”å­—æ®µ**ï¼š
- `enabled` - Recursor æ˜¯å¦å¯ç”¨
- `port` - ç›‘å¬ç«¯å£
- `address` - å®Œæ•´åœ°å€ï¼ˆIP:ç«¯å£ï¼‰
- `uptime` - è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
- `last_health_check` - æœ€åå¥åº·æ£€æŸ¥æ—¶é—´æˆ³

---

## ğŸ“Š ç”Ÿå‘½å‘¨æœŸæµç¨‹

### å¯åŠ¨æµç¨‹

```
1. è¯»å–é…ç½®
   â†“
2. åˆ›å»º DNS æœåŠ¡å™¨
   â”œâ”€ åˆå§‹åŒ– Recursor Managerï¼ˆå¦‚æœå¯ç”¨ï¼‰
   â””â”€ è®°å½•åˆå§‹åŒ–æ—¥å¿—
   â†“
3. å¯åŠ¨ DNS æœåŠ¡å™¨
   â”œâ”€ å¯åŠ¨ UDP æœåŠ¡å™¨
   â”œâ”€ å¯åŠ¨ TCP æœåŠ¡å™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
   â”œâ”€ å¯åŠ¨ Prefetcher
   â”œâ”€ å¯åŠ¨ Recursorï¼ˆå¦‚æœå¯ç”¨ï¼‰
   â”‚  â”œâ”€ è§£å‹ Unbound äºŒè¿›åˆ¶
   â”‚  â”œâ”€ æå– root.key
   â”‚  â”œâ”€ ç”ŸæˆåŠ¨æ€é…ç½®
   â”‚  â”œâ”€ å¯åŠ¨ Unbound è¿›ç¨‹
   â”‚  â”œâ”€ ç­‰å¾…ç«¯å£å°±ç»ª
   â”‚  â””â”€ å¯åŠ¨å¥åº·æ£€æŸ¥å¾ªç¯
   â””â”€ è®°å½•å¯åŠ¨å®Œæˆ
   â†“
4. æœåŠ¡è¿è¡Œä¸­
   â”œâ”€ DNS æŸ¥è¯¢å¤„ç†
   â”œâ”€ Recursor å¥åº·æ£€æŸ¥
   â””â”€ è‡ªåŠ¨é‡å¯ï¼ˆå¦‚æœè¿›ç¨‹å´©æºƒï¼‰
```

### å…³é—­æµç¨‹

```
1. æ”¶åˆ°å…³é—­ä¿¡å·
   â†“
2. åœæ­¢ Recursorï¼ˆå¦‚æœå¯ç”¨ï¼‰
   â”œâ”€ åœæ­¢å¥åº·æ£€æŸ¥å¾ªç¯
   â”œâ”€ å‘é€ SIGTERM ç»™ Unbound
   â”œâ”€ ç­‰å¾…è¿›ç¨‹é€€å‡ºï¼ˆæœ€å¤š 5 ç§’ï¼‰
   â”œâ”€ è¶…æ—¶åå¼ºåˆ¶ KILL
   â””â”€ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
   â†“
3. å…³é—­å…¶ä»–ç»„ä»¶
   â”œâ”€ å…³é—­ä¸Šæ¸¸è¿æ¥æ± 
   â”œâ”€ ä¿å­˜ç¼“å­˜åˆ°ç£ç›˜
   â”œâ”€ å…³é—­ç¼“å­˜ç³»ç»Ÿ
   â”œâ”€ å…³é—­ UDP/TCP æœåŠ¡å™¨
   â””â”€ åœæ­¢å·¥ä½œé˜Ÿåˆ—
   â†“
4. æœåŠ¡å®Œå…¨å…³é—­
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•

```bash
# æµ‹è¯• Recursor Manager
go test ./recursor -v

# æµ‹è¯• DNS æœåŠ¡å™¨é›†æˆ
go test ./dnsserver -v
```

### é›†æˆæµ‹è¯•

```bash
# å¯åŠ¨æœåŠ¡ï¼ˆå¯ç”¨ Recursorï¼‰
./smartdnssort -c config.yaml

# æ£€æŸ¥ Recursor çŠ¶æ€
curl http://localhost:8080/api/recursor/status

# æµ‹è¯• DNS æŸ¥è¯¢
dig @127.0.0.1 -p 53 google.com

# æµ‹è¯•æœ¬åœ° Recursor
dig @127.0.0.1 -p 5353 google.com
```

### éªŒè¯æ¸…å•

- [ ] Recursor è¿›ç¨‹å¯åŠ¨æˆåŠŸ
- [ ] ç›‘å¬ç«¯å£æ­£ç¡®ï¼ˆ5353ï¼‰
- [ ] API ç«¯ç‚¹è¿”å›æ­£ç¡®çŠ¶æ€
- [ ] DNS æŸ¥è¯¢æ­£å¸¸å·¥ä½œ
- [ ] è¿›ç¨‹å´©æºƒæ—¶è‡ªåŠ¨é‡å¯
- [ ] å…³é—­æ—¶ä¼˜é›…åœæ­¢
- [ ] ä¸´æ—¶æ–‡ä»¶æ­£ç¡®æ¸…ç†

---

## ğŸ” æ—¥å¿—è¾“å‡ºç¤ºä¾‹

### å¯åŠ¨æ—¥å¿—

```
[INFO] [Recursor] Manager initialized for port 5353
[INFO] [Recursor] Recursor started on 127.0.0.1:5353
```

### è¿è¡Œæ—¥å¿—

```
[INFO] [Recursor] Process exited unexpectedly, attempting restart...
[INFO] [Recursor] Manager initialized for port 5353
[INFO] [Recursor] Recursor started on 127.0.0.1:5353
```

### å…³é—­æ—¥å¿—

```
[INFO] [Recursor] Recursor stopped successfully.
[INFO] [Server] æœåŠ¡å™¨å·²å…³é—­
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç«¯å£å†²çª

**é—®é¢˜**ï¼š5353 æ˜¯ mDNS æ ‡å‡†ç«¯å£ï¼Œå¯èƒ½è¢«å ç”¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä¿®æ”¹é…ç½®ä¸­çš„ `recursor_port` ä¸ºå…¶ä»–ç«¯å£ï¼ˆå¦‚ 8053ï¼‰
- æˆ–æ£€æŸ¥å¹¶å…³é—­å ç”¨è¯¥ç«¯å£çš„è¿›ç¨‹

### 2. æƒé™è¦æ±‚

- **Linux**ï¼šä½¿ç”¨ < 1024 çš„ç«¯å£éœ€è¦ root æƒé™
- **Windows**ï¼šé€šå¸¸æ— ç‰¹æ®Šæƒé™è¦æ±‚
- **å»ºè®®**ï¼šä½¿ç”¨ > 1024 çš„ç«¯å£

### 3. èµ„æºå ç”¨

- **å†…å­˜**ï¼š50-150MBï¼ˆå–å†³äºç¼“å­˜å¤§å°ï¼‰
- **CPU**ï¼šæ ¹æ®æŸ¥è¯¢é‡åŠ¨æ€è°ƒæ•´
- **ç£ç›˜**ï¼šä¸´æ—¶æ–‡ä»¶çº¦ 10-20MB

### 4. é”™è¯¯å¤„ç†

å¯åŠ¨å¤±è´¥ä¸ä¼šä¸­æ–­ DNS æœåŠ¡å™¨å¯åŠ¨ï¼Œä½†ä¼šè®°å½•è­¦å‘Šæ—¥å¿—ã€‚ç”¨æˆ·å¯ä»¥ï¼š
- æ£€æŸ¥æ—¥å¿—äº†è§£å¤±è´¥åŸå› 
- ä¿®æ”¹é…ç½®ï¼ˆå¦‚ç«¯å£ï¼‰
- é‡å¯æœåŠ¡

---

## ğŸ“‹ å®ç°æ¸…å•

### åç«¯é›†æˆ âœ…

- [x] åœ¨ `dnsserver/server.go` ä¸­æ·»åŠ  `recursorMgr` å­—æ®µ
- [x] åœ¨ `dnsserver/server_init.go` ä¸­åˆå§‹åŒ– Recursor Manager
- [x] åœ¨ `dnsserver/server_lifecycle.go` ä¸­æ·»åŠ å¯åŠ¨é€»è¾‘
- [x] åœ¨ `dnsserver/server_lifecycle.go` ä¸­æ·»åŠ å…³é—­é€»è¾‘
- [x] é…ç½®ç³»ç»Ÿå·²æ”¯æŒ Recursor é…ç½®
- [x] WebAPI ç«¯ç‚¹å·²å®ç°
- [x] æ—¥å¿—è®°å½•å®Œæ•´

### å‰ç«¯é›†æˆ â³

- [ ] åˆ›å»º `webapi/web/components/config-recursor.html`
- [ ] åˆ›å»º `webapi/web/js/modules/recursor.js`
- [ ] æ›´æ–° `webapi/web/index.html` è„šæœ¬åŠ è½½é¡ºåº
- [ ] æ·»åŠ å›½é™…åŒ–æ”¯æŒ

### æµ‹è¯• â³

- [ ] å•å…ƒæµ‹è¯•
- [ ] é›†æˆæµ‹è¯•
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•

---

## ğŸš€ åç»­æ­¥éª¤

### ç«‹å³å¯åš

1. **ç¼–è¯‘éªŒè¯**
   ```bash
   go build -o smartdnssort cmd/main.go
   ```

2. **å¯åŠ¨æµ‹è¯•**
   ```bash
   ./smartdnssort -c config.yaml
   ```

3. **API æµ‹è¯•**
   ```bash
   curl http://localhost:8080/api/recursor/status
   ```

### å‰ç«¯é›†æˆ

å‚è€ƒ `recursor/å‰ç«¯é›†æˆæ€»ç»“.md` å®Œæˆå‰ç«¯å®ç°

### å®Œæ•´æµ‹è¯•

- å¯ç”¨/ç¦ç”¨ Recursor
- ä¿®æ”¹ç«¯å£
- éªŒè¯è‡ªåŠ¨é‡å¯
- æ€§èƒ½æµ‹è¯•

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **Recursor å¼€å‘æŒ‡å—**ï¼š`recursor/DEVELOPMENT_GUIDE.md`
- **å‰ç«¯é›†æˆæ€»ç»“**ï¼š`recursor/å‰ç«¯é›†æˆæ€»ç»“.md`
- **Manager å®ç°**ï¼š`recursor/manager.go`
- **API å®ç°**ï¼š`webapi/api_recursor.go`

---

## âœ… éªŒè¯å‘½ä»¤

```bash
# 1. ç¼–è¯‘
go build -o smartdnssort cmd/main.go

# 2. å¯åŠ¨ï¼ˆå¯ç”¨ Recursorï¼‰
./smartdnssort -c config.yaml

# 3. æ£€æŸ¥çŠ¶æ€
curl http://localhost:8080/api/recursor/status

# 4. æµ‹è¯• DNS æŸ¥è¯¢
dig @127.0.0.1 -p 53 google.com

# 5. æŸ¥çœ‹æ—¥å¿—
tail -f smartdnssort.log
```

---

## ğŸ“Š å®ç°ç»Ÿè®¡

| ç»„ä»¶ | çŠ¶æ€ | å®Œæˆåº¦ |
|------|------|--------|
| Recursor Manager | âœ… å®Œæˆ | 100% |
| é…ç½®ç³»ç»Ÿ | âœ… å®Œæˆ | 100% |
| WebAPI ç«¯ç‚¹ | âœ… å®Œæˆ | 100% |
| DNS æœåŠ¡å™¨é›†æˆ | âœ… å®Œæˆ | 100% |
| å‰ç«¯é›†æˆ | â³ è¿›è¡Œä¸­ | 0% |
| æµ‹è¯• | â³ è¿›è¡Œä¸­ | 0% |
| **æ€»ä½“** | âœ… åç«¯å®Œæˆ | **100%** |

---

**å®ç°å®Œæˆæ—¥æœŸ**ï¼š2026-01-31  
**ç‰ˆæœ¬**ï¼š1.0  
**çŠ¶æ€**ï¼šâœ… åç«¯é›†æˆå®Œæˆï¼Œç­‰å¾…å‰ç«¯é›†æˆ

