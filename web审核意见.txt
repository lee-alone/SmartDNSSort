åŸºäºå¯¹webapiåŒ…æ‰€æœ‰æ–‡ä»¶çš„å…¨é¢åˆ†æï¼Œæˆ‘ä¸ºæ‚¨å‡†å¤‡äº†è¯¦ç»†çš„ä»£ç å®¡æ ¸æŠ¥å‘Šï¼š

---

# WebAPI ä»£ç å®¡æ ¸æŠ¥å‘Š

## ğŸ“‹ æ€»ä½“è¯„ä»·
- **ä»£ç è´¨é‡**: â­â­â­â­â˜† (4/5)
- **å®‰å…¨æ€§**: â­â­â˜†â˜†â˜† (2/5) - å­˜åœ¨è¾ƒå¤šå®‰å…¨éšæ‚£
- **æ€§èƒ½**: â­â­â­â˜†â˜† (3/5) - æœ‰ä¼˜åŒ–ç©ºé—´
- **å¯ç»´æŠ¤æ€§**: â­â­â­â­â˜† (4/5)

---

## ğŸ”´ é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼ˆéœ€ç«‹å³ä¿®å¤ï¼‰

### 1. ğŸ”’ å®‰å…¨é—®é¢˜

#### 1.1 CORSé…ç½®è¿‡äºå®½æ¾
**æ–‡ä»¶**: `webapi/api_utils.go:38-45`
```go
func (s *Server) corsMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        w.Header().Set("Access-Control-Allow-Origin", "*") // âŒ å…è®¸æ‰€æœ‰æ¥æº
        w.Header().Set("Access-Control-Allow-Methods", "GET, POST, OPTIONS")
        w.Header().Set("Access-Control-Allow-Headers", "Content-Type")
```

**é—®é¢˜**: å…è®¸ä»»æ„æ¥æºçš„è¯·æ±‚ï¼Œç”Ÿäº§ç¯å¢ƒå­˜åœ¨é‡å¤§å®‰å…¨é£é™©
**å»ºè®®**: é™åˆ¶ä¸ºç‰¹å®šåŸŸååˆ—è¡¨æˆ–ä»è¯·æ±‚å¤´è¯»å–RefereréªŒè¯

#### 1.2 ç¼ºå°‘èº«ä»½éªŒè¯å’Œæˆæƒæœºåˆ¶
**å½±å“**: æ‰€æœ‰APIç«¯ç‚¹
```go
// æ‰€æœ‰handleréƒ½ç¼ºå°‘è®¤è¯æ£€æŸ¥
func (s *Server) handleRestart(w http.ResponseWriter, r *http.Request) {
    // âŒ ä»»ä½•äººéƒ½å¯ä»¥è§¦å‘é‡å¯
    if r.Method != http.MethodPost {
        s.writeJSONError(w, "Invalid request method", http.StatusMethodNotAllowed)
        return
    }
```

**å»ºè®®**: 
- æ·»åŠ APIå¯†é’¥æˆ–JWTè®¤è¯
- æ•æ„Ÿæ“ä½œï¼ˆé‡å¯ã€é…ç½®ä¿®æ”¹ï¼‰éœ€è¦ç®¡ç†å‘˜æƒé™
- æ·»åŠ é€Ÿç‡é™åˆ¶

#### 1.3 é…ç½®æ–‡ä»¶æƒé™è¿‡å®½
**æ–‡ä»¶**: `webapi/api_utils.go:100`, `webapi/api_custom.go:44`
```go
return os.WriteFile(s.configPath, yamlData, 0644) // âŒ ä¸–ç•Œå¯è¯»
```

**é—®é¢˜**: æ•æ„Ÿé…ç½®å¯è¢«å…¶ä»–ç”¨æˆ·è¯»å–
**å»ºè®®**: ä½¿ç”¨æ›´ä¸¥æ ¼çš„æƒé™ `0600`

#### 1.4 è·¯å¾„éå†é£é™©
**æ–‡ä»¶**: `webapi/api_custom.go:26-30`
```go
customRulesFile := s.cfg.AdBlock.CustomRulesFile
if customRulesFile == "" {
    customRulesFile = "./custom_rules.txt" // âŒ ç›¸å¯¹è·¯å¾„å¯èƒ½è¢«æ»¥ç”¨
}
```

**å»ºè®®**: éªŒè¯æ–‡ä»¶è·¯å¾„ï¼Œé™åˆ¶åœ¨æŒ‡å®šç›®å½•å†…

---

### 2. âš ï¸ å¹¶å‘å®‰å…¨é—®é¢˜

#### 2.1 é…ç½®æ›´æ–°æ²¡æœ‰é”ä¿æŠ¤
**æ–‡ä»¶**: `webapi/api_config.go`, `webapi/api_adblock.go`
```go
func (s *Server) handlePostConfig(w http.ResponseWriter, r *http.Request) {
    // âŒ æ²¡æœ‰ä¿æŠ¤å¹¶å‘é…ç½®æ›´æ–°
    existingCfg, err := config.LoadConfig(s.configPath)
    // ... ä¿®æ”¹é…ç½®
    s.writeConfigFile(yamlData) // å¯èƒ½è¢«å¹¶å‘å†™å…¥
}
```

**å»ºè®®**: æ·»åŠ äº’æ–¥é”ä¿æŠ¤é…ç½®æ–‡ä»¶æ“ä½œ

#### 2.2 é‡å¯æ“ä½œçš„ç«æ€æ¡ä»¶
**æ–‡ä»¶**: `webapi/api_handlers.go:135-142`
```go
func (s *Server) handleRestart(w http.ResponseWriter, r *http.Request) {
    // âŒ å¤šä¸ªè¯·æ±‚å¯åŒæ—¶è§¦å‘é‡å¯
    if s.restartFunc != nil {
        go func() {
            logger.Info("Executing restart function...")
            s.restartFunc()
        }()
    }
}
```

**å»ºè®®**: æ·»åŠ é‡å¯çŠ¶æ€æ£€æŸ¥å’Œäº’æ–¥é”

---

### 3. ğŸš¨ èµ„æºæ³„æ¼é£é™©

#### 3.1 HTTPè¯·æ±‚ä½“æœªå…³é—­
**æ–‡ä»¶**: `webapi/api_config.go:21-23`
```go
func (s *Server) handlePostConfig(w http.ResponseWriter, r *http.Request) {
    bodyBytes, err := io.ReadAll(r.Body) // âŒ æœªæ˜¾å¼å…³é—­r.Body
```

**è¯´æ˜**: è™½ç„¶Go HTTPæœåŠ¡å™¨ä¼šåœ¨å“åº”åè‡ªåŠ¨å…³é—­ï¼Œä½†æ˜¾å¼å…³é—­ä»æ¨è

#### 3.2 é•¿æ—¶é—´è¿è¡Œçš„goroutineæ²¡æœ‰è¶…æ—¶æ§åˆ¶
**æ–‡ä»¶**: `webapi/api_adblock.go:57-66`
```go
go func() {
    // âŒ æ²¡æœ‰contextå–æ¶ˆï¼Œå¯èƒ½æ°¸ä¹…è¿è¡Œ
    result, err := adblockMgr.UpdateRules(true)
    if err != nil {
        logger.Errorf("[AdBlock] Manual update failed: %v", err)
    }
}()
```

**å»ºè®®**: ä½¿ç”¨context.WithTimeoutæˆ–sync.WaitGroupè¿›è¡Œæ§åˆ¶

---

## ğŸŸ¡ ä¸­ä¼˜å…ˆçº§é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰

### 4. ğŸ“Š æ€§èƒ½é—®é¢˜

#### 4.1 å†…å­˜ä¼°ç®—ä¸å‡†ç¡®
**æ–‡ä»¶**: `webapi/api.go:82-131`
```go
func estimateEntrySize(entry *cache.RawCacheEntry) int64 {
    // âš ï¸ ç¡¬ç¼–ç çš„ä¼°ç®—å€¼ï¼Œå¯èƒ½ä¸å‡†ç¡®
    size += 8 + 8 + 8 + 8 + 8 + 8 + 8 + 1 + 8 // å„å­—æ®µçš„å¤§å°
    size += int64(len(entry.IPs)) * 24         // åˆ‡ç‰‡å¤´çš„ä¼°ç®—å¯èƒ½åå·®å¾ˆå¤§
```

**å»ºè®®**: 
- ä½¿ç”¨`unsafe.Sizeof`è·å–å®é™…å¤§å°
- æˆ–è€…æ·»åŠ è¿è¡Œæ—¶ç²¾ç¡®è®¡ç®—é€‰é¡¹

#### 4.2 ç¼ºå°‘å“åº”å‹ç¼©
**æ–‡ä»¶**: `webapi/api.go:56-74`
```go
mux.Handle("/", s.corsMiddleware(http.FileServer(http.FS(webSubFS))))
// âš ï¸ é™æ€æ–‡ä»¶æ²¡æœ‰å‹ç¼©ä¼ è¾“
```

**å»ºè®®**: æ·»åŠ gzipå‹ç¼©ä¸­é—´ä»¶

#### 4.3 é‡å¤è®¡ç®—
**æ–‡ä»¶**: `webapi/api_handlers.go:36-50`, `webapi/api_handlers.go:76-94`
```go
// handleStatså’ŒhandleCacheMemoryStatsæœ‰å¤§é‡é‡å¤ä»£ç 
avgBytesPerEntry := s.calculateAvgBytesPerEntry()
evictionsPerMin := s.calculateEvictionsPerMinute()
// ... å‡ ä¹ç›¸åŒçš„é€»è¾‘
```

**å»ºè®®**: æå–å…¬å…±è®¡ç®—é€»è¾‘ä¸ºç‹¬ç«‹æ–¹æ³•

---

### 5. ğŸ—ï¸ ä»£ç è´¨é‡æ”¹è¿›

#### 5.1 ç¡¬ç¼–ç çš„é­”æ³•æ•°å­—
**æ–‡ä»¶**: `webapi/api_config.go:99-118`
```go
if val < 100 || val > 2000 { // âŒ é­”æ³•æ•°å­—
    return fmt.Errorf("sequential timeout must be between 100ms and 2000ms if specified, got %dms", val)
}
```

**å»ºè®®**: å®šä¹‰å¸¸é‡
```go
const (
    MinSequentialTimeoutMs = 100
    MaxSequentialTimeoutMs = 2000
)
```

#### 5.2 æœªä½¿ç”¨çš„ç±»å‹å£°æ˜
**æ–‡ä»¶**: `webapi/api.go:12-16`
```go
// âš ï¸ APIResponseã€QueryResultç­‰ç±»å‹å®šä¹‰äº†ä½†åœ¨handlerä¸­ä¸ä¸€è‡´ä½¿ç”¨
type APIResponse struct {
    Success bool        `json:"success"`
    Message string      `json:"message"`
    Data    interface{} `json:"data,omitempty"`
}
// æœ‰äº›åœ°æ–¹è¿”å›åŸå§‹JSONï¼Œæœ‰äº›ä½¿ç”¨è¿™ä¸ªç»“æ„
```

**å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨APIResponseæ ¼å¼

#### 5.3 ç¼ºå°‘å•å…ƒæµ‹è¯•
**å½±å“**: æ•´ä¸ªwebapiåŒ…ä¸­æ²¡æœ‰æµ‹è¯•æ–‡ä»¶

**å»ºè®®**: æ·»åŠ åŸºæœ¬åŠŸèƒ½çš„å•å…ƒæµ‹è¯•ï¼Œç‰¹åˆ«æ˜¯ï¼š
- é…ç½®éªŒè¯é€»è¾‘
- é”™è¯¯å¤„ç†
- å·¥å…·å‡½æ•°

---

### 6. ğŸ”§ é”™è¯¯å¤„ç†æ”¹è¿›

#### 6.1 é”™è¯¯ä¿¡æ¯ä¸ä¸€è‡´
**æ–‡ä»¶**: å¤šå¤„
```go
// æœ‰æ—¶ä½¿ç”¨
http.Error(w, message, statusCode)

// æœ‰æ—¶ä½¿ç”¨
s.writeJSONError(w, message, statusCode)
```

**å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨`writeJSONError`ï¼Œå¹¶ç¡®ä¿æ‰€æœ‰å“åº”éƒ½æ˜¯JSONæ ¼å¼

#### 6.2 éƒ¨åˆ†é”™è¯¯æœªè®°å½•
**æ–‡ä»¶**: `webapi/api_handlers.go:63`
```go
if err := s.dnsCache.Clear(); err != nil {
    // âš ï¸ æ¸…ç©ºå¤±è´¥åªè¿”å›é”™è¯¯ï¼Œæ²¡æœ‰è®°å½•åˆ°æ—¥å¿—
    s.writeJSONError(w, err.Error(), http.StatusInternalServerError)
    return
}
```

**å»ºè®®**: å…³é”®æ“ä½œå¤±è´¥éƒ½åº”è®°å½•æ—¥å¿—

---

## ğŸŸ¢ ä½ä¼˜å…ˆçº§å»ºè®®ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

### 7. ä»£ç ç»“æ„ä¼˜åŒ–

#### 7.1 æå–è·¯ç”±æ³¨å†Œé€»è¾‘
**æ–‡ä»¶**: `webapi/api.go:49-80`
```go
// å»ºè®®ï¼šå°†è·¯ç”±æ³¨å†Œæå–ä¸ºå•ç‹¬çš„æ–¹æ³•
func (s *Server) registerRoutes(mux *http.ServeMux) {
    // åŸºç¡€ API è·¯ç”±
    mux.HandleFunc("/api/query", s.handleQuery)
    // ...
}
```

#### 7.2 æ·»åŠ å¥åº·æ£€æŸ¥è¯¦æƒ…
**æ–‡ä»¶**: `webapi/api_handlers.go:95-97`
```go
func (s *Server) handleHealth(w http.ResponseWriter, r *http.Request) {
    w.Header().Set("Content-Type", "application/json")
    w.Write([]byte(`{"status":"healthy"}`)) // âš ï¸ å¯ä»¥æ·»åŠ æ›´å¤šå¥åº·æŒ‡æ ‡
}
```

**å»ºè®®**: æ·»åŠ ä¾èµ–é¡¹æ£€æŸ¥ï¼ˆæ•°æ®åº“ã€DNSæœåŠ¡å™¨ç­‰ï¼‰

#### 7.3 æ·»åŠ è¯·æ±‚æ—¥å¿—
**å»ºè®®**: æ·»åŠ è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶ï¼Œè®°å½•è¯·æ±‚æ–¹æ³•ã€è·¯å¾„ã€å“åº”æ—¶é—´ç­‰

---

## ğŸ“ ä¿®å¤ä¼˜å…ˆçº§å»ºè®®

### ç«‹å³ä¿®å¤ï¼ˆ1-2å‘¨ï¼‰
1. âœ… æ·»åŠ APIè®¤è¯æœºåˆ¶
2. âœ… ä¿®å¤CORSé…ç½®
3. âœ… æ·»åŠ å¹¶å‘çš„é…ç½®æ›´æ–°ä¿æŠ¤

### çŸ­æœŸä¿®å¤ï¼ˆ1ä¸ªæœˆï¼‰
4. âœ… ä¿®å¤é…ç½®æ–‡ä»¶æƒé™
5. âœ… æ·»åŠ è¯·æ±‚é€Ÿç‡é™åˆ¶
6. âœ… ä¼˜åŒ–é”™è¯¯å¤„ç†ä¸€è‡´æ€§
7. âœ… æ·»åŠ å•å…ƒæµ‹è¯•

### é•¿æœŸæ”¹è¿›ï¼ˆ2-3ä¸ªæœˆï¼‰
8. âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆå‹ç¼©ã€ç¼“å­˜ï¼‰
9. âœ… ä»£ç é‡æ„ï¼ˆæå–å…¬å…±é€»è¾‘ï¼‰
10. âœ… æ·»åŠ ç›‘æ§å’ŒæŒ‡æ ‡

---

## ğŸ¯ æ€»ä½“å»ºè®®

**ä¼˜åŠ¿**:
- âœ… ä»£ç ç»“æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†ç¦»è‰¯å¥½
- âœ… ä½¿ç”¨ç°ä»£Goç‰¹æ€§ï¼ˆembed.FSï¼‰
- âœ… æœ‰è¯¦ç»†çš„æ—¥å¿—è®°å½•
- âœ… ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®ç®¡ç†

**ä¸»è¦æ”¹è¿›æ–¹å‘**:
- ğŸ”’ åŠ å¼ºå®‰å…¨æ€§ï¼ˆè®¤è¯ã€æˆæƒï¼‰
- âš¡ æå‡å¹¶å‘å®‰å…¨æ€§
- ğŸ§ª å¢åŠ æµ‹è¯•è¦†ç›–ç‡
- ğŸ“Š æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–

æ•´ä½“æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„Web APIï¼Œä½†éœ€è¦åŠ å¼ºå®‰å…¨æ€§å’Œå¹¶å‘æ“ä½œçš„å¤„ç†ã€‚ä¼˜å…ˆè§£å†³é«˜ä¼˜å…ˆçº§å®‰å…¨é—®é¢˜åï¼Œä»£ç è´¨é‡å°†æ˜¾è‘—æå‡ã€‚