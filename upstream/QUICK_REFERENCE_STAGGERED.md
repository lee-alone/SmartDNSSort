# ä¸¤é˜¶æ®µå¹¶è¡ŒæŸ¥è¯¢ - å¿«é€Ÿå‚è€ƒ

## æ ¸å¿ƒæ¦‚å¿µï¼ˆ30 ç§’é€Ÿè§ˆï¼‰

```
ç”¨æˆ·è¯·æ±‚ example.com
    â†“
ç¬¬ä¸€é˜¶æ®µï¼ˆActive Tierï¼‰
â”œâ”€ T=0ms:   å¯åŠ¨ 2 ä¸ªæœ€ä¼˜æœåŠ¡å™¨
â”œâ”€ T=50ms:  ç¬¬ä¸€ä¸ªè¿”å›ž âœ…
â””â”€ ç«‹å³å“åº”ç”¨æˆ·ï¼ˆç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿï¼š50msï¼‰
    â†“
ç¬¬äºŒé˜¶æ®µï¼ˆStaggered Tierï¼‰- åŽå°è¿è¡Œ
â”œâ”€ T=300ms: å¯åŠ¨ç¬¬ä¸€æ‰¹ï¼ˆ2 ä¸ªï¼‰
â”œâ”€ T=350ms: å¯åŠ¨ç¬¬äºŒæ‰¹ï¼ˆ2 ä¸ªï¼‰
â””â”€ T=400ms: æ‰€æœ‰å“åº”æ”¶é›†å®Œæˆ
    â†“
ç¼“å­˜æ›´æ–°ï¼ˆå®Œæ•´ IP æ± ï¼‰
```

## å‚æ•°é€ŸæŸ¥è¡¨

| å‚æ•° | é»˜è®¤å€¼ | è°ƒæ•´å»ºè®® |
|------|-------|--------|
| `activeTierSize` | 2 | ä¸Šæ¸¸å¤šâ†’3ï¼Œä¸Šæ¸¸å°‘â†’1 |
| `fallbackTimeout` | 300ms | å»¶è¿Ÿæ•æ„Ÿâ†’200msï¼Œå®Œæ•´æ€§æ•æ„Ÿâ†’500ms |
| `batchSize` | 2 | ä¸Šæ¸¸å¤šâ†’3ï¼Œä¸Šæ¸¸å°‘â†’1 |
| `staggerDelay` | 50ms | å»¶è¿Ÿæ•æ„Ÿâ†’30msï¼ŒåŽ‹åŠ›æ•æ„Ÿâ†’100ms |
| `totalCollectTimeout` | 3s | ä¸Šæ¸¸å¤šâ†’5sï¼Œä¸Šæ¸¸å°‘â†’2s |

## è°ƒä¼˜åœºæ™¯

### åœºæ™¯ 1ï¼šå»¶è¿Ÿæ•æ„Ÿï¼ˆç§»åŠ¨åº”ç”¨ï¼‰
```go
activeTierSize:      3
fallbackTimeout:     200ms
batchSize:           2
staggerDelay:        30ms
totalCollectTimeout: 2s
```
**ç†ç”±**ï¼šæ›´æ¿€è¿›çš„ç¬¬ä¸€é˜¶æ®µï¼Œæ›´å¿«çš„ç¬¬äºŒé˜¶æ®µå¯åŠ¨

### åœºæ™¯ 2ï¼šå®Œæ•´æ€§æ•æ„Ÿï¼ˆç¼“å­˜é¢„çƒ­ï¼‰
```go
activeTierSize:      2
fallbackTimeout:     500ms
batchSize:           2
staggerDelay:        100ms
totalCollectTimeout: 5s
```
**ç†ç”±**ï¼šç»™ç¬¬ä¸€é˜¶æ®µæ›´å¤šæ—¶é—´ï¼Œç»™åŽå°è¡¥å…¨æ›´å¤šæ—¶é—´

### åœºæ™¯ 3ï¼šä¸Šæ¸¸è¾ƒå°‘ï¼ˆ2-3 ä¸ªï¼‰
```go
activeTierSize:      1
fallbackTimeout:     300ms
batchSize:           1
staggerDelay:        100ms
totalCollectTimeout: 2s
```
**ç†ç”±**ï¼šæœåŠ¡å™¨å°‘ï¼Œä¸éœ€è¦åˆ†ç»„

### åœºæ™¯ 4ï¼šä¸Šæ¸¸è¾ƒå¤šï¼ˆ10+ ä¸ªï¼‰
```go
activeTierSize:      3
fallbackTimeout:     300ms
batchSize:           3
staggerDelay:        50ms
totalCollectTimeout: 5s
```
**ç†ç”±**ï¼šæœåŠ¡å™¨å¤šï¼Œéœ€è¦æ›´ç»†è‡´çš„åˆ†ç»„

## æ—¥å¿—è§£è¯»

### âœ… æ­£å¸¸æµç¨‹
```
[queryParallel] ä¸¤é˜¶æ®µå¹¶è¡ŒæŸ¥è¯¢ 5 ä¸ªæœåŠ¡å™¨
[queryParallel] åˆ†å±‚: Active Tier=2 ä¸ªæœåŠ¡å™¨, Staggered Tier=3 ä¸ªæœåŠ¡å™¨
[queryParallel] ðŸš€ ç¬¬ä¸€é˜¶æ®µ: å¯åŠ¨ 2 ä¸ª Active Tier æœåŠ¡å™¨
[executeQuery] ðŸš€ å¿«é€Ÿå“åº”: æœåŠ¡å™¨ 8.8.8.8:53 è¿”å›žæˆåŠŸç»“æžœ
[queryParallel] âœ… ç¬¬ä¸€é˜¶æ®µæˆåŠŸ: æœåŠ¡å™¨ 8.8.8.8:53 è¿”å›ž 2 ä¸ªIP
[queryParallel] ðŸ“Š ç¬¬äºŒé˜¶æ®µ: å¯åŠ¨åˆ†ç»„æ­¥è¿›ï¼Œå…± 3 ä¸ªæœåŠ¡å™¨
[collectRemainingResponsesWithTimeout] âœ… åŽå°æ”¶é›†å®Œæˆ: ä»Ž 4 ä¸ªæœåŠ¡å™¨æ”¶é›†åˆ° 8 æ¡è®°å½•
```

### âš ï¸ ç¬¬ä¸€é˜¶æ®µå¤±è´¥ï¼Œå¿«é€Ÿé™çº§
```
[queryParallel] ðŸš€ ç¬¬ä¸€é˜¶æ®µ: å¯åŠ¨ 2 ä¸ª Active Tier æœåŠ¡å™¨
[queryParallel] â±ï¸  ç¬¬ä¸€é˜¶æ®µè¶…æ—¶ (300ms)ï¼Œå¯åŠ¨ç¬¬äºŒé˜¶æ®µè¡¥å…¨
[queryParallel] ðŸ“Š ç¬¬äºŒé˜¶æ®µ: å¯åŠ¨åˆ†ç»„æ­¥è¿›
[executeQuery] ðŸš€ å¿«é€Ÿå“åº”: æœåŠ¡å™¨ 1.1.1.1:53 è¿”å›žæˆåŠŸç»“æžœ
[queryParallel] âœ… ç¬¬äºŒé˜¶æ®µé¦–ä¸ªæˆåŠŸ: æœåŠ¡å™¨ 1.1.1.1:53 è¿”å›ž 2 ä¸ªIP
```

### â±ï¸ åŽå°è¡¥å…¨è¶…æ—¶
```
[collectRemainingResponsesWithTimeout] ðŸ”„ å¼€å§‹åŽå°æ”¶é›†å‰©ä½™å“åº”
[collectRemainingResponsesWithTimeout] â±ï¸  åŽå°æ”¶é›†è¶…æ—¶ï¼ˆ3sï¼‰ï¼Œå·²æ”¶é›† 3 ä¸ªæˆåŠŸå“åº”
[collectRemainingResponsesWithTimeout] âœ… åŽå°æ”¶é›†å®Œæˆ: ä»Ž 3 ä¸ªæœåŠ¡å™¨æ”¶é›†åˆ° 6 æ¡è®°å½•
```

## æ€§èƒ½æŒ‡æ ‡

### å…¸åž‹åœºæ™¯ï¼ˆ5 ä¸ªä¸Šæ¸¸ï¼‰

| æŒ‡æ ‡ | å…¨å¹¶å‘ | ä¸¤é˜¶æ®µ |
|------|-------|--------|
| ç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿ | 200ms | 50ms â†“ 75% |
| ä¸Šæ¸¸çž¬æ—¶å¹¶å‘ | 5 | 2 â†“ 60% |
| æ€»è€—æ—¶ | 200ms | 400ms |
| IP å®Œæ•´æ€§ | 100% | 100% |

**å…³é”®ç‚¹**ï¼šç”¨æˆ·åªæ„ŸçŸ¥ 50msï¼ŒåŽå°è¡¥å…¨åœ¨ 400ms å†…å®Œæˆ

## æ•…éšœæŽ’æŸ¥

### é—®é¢˜ 1ï¼šç¬¬ä¸€é˜¶æ®µæ€»æ˜¯è¶…æ—¶
**ç—‡çŠ¶**ï¼šæ—¥å¿—ä¸­é¢‘ç¹å‡ºçŽ° "ç¬¬ä¸€é˜¶æ®µè¶…æ—¶"
**åŽŸå› **ï¼šActive Tier æœåŠ¡å™¨å“åº”æ…¢
**è§£å†³**ï¼š
- å¢žåŠ  `fallbackTimeout`ï¼ˆç»™ç¬¬ä¸€é˜¶æ®µæ›´å¤šæ—¶é—´ï¼‰
- æˆ–å‡å°‘ `activeTierSize`ï¼ˆé€‰æ‹©æ›´å°‘ä½†æ›´å¿«çš„æœåŠ¡å™¨ï¼‰

### é—®é¢˜ 2ï¼šåŽå°è¡¥å…¨æ”¶é›†ä¸å®Œæ•´
**ç—‡çŠ¶**ï¼šç¼“å­˜ä¸­ IP æ•°é‡å°‘äºŽé¢„æœŸ
**åŽŸå› **ï¼šåŽå°è¡¥å…¨è¶…æ—¶æˆ–æŸäº›æœåŠ¡å™¨å¤±è´¥
**è§£å†³**ï¼š
- å¢žåŠ  `totalCollectTimeout`
- æ£€æŸ¥ä¸Šæ¸¸æœåŠ¡å™¨å¥åº·çŠ¶æ€
- æŸ¥çœ‹æ—¥å¿—ä¸­çš„å¤±è´¥ä¿¡æ¯

### é—®é¢˜ 3ï¼šä¸Šæ¸¸åŽ‹åŠ›ä»ç„¶å¾ˆé«˜
**ç—‡çŠ¶**ï¼šä¸Šæ¸¸æœåŠ¡å™¨è´Ÿè½½é«˜
**åŽŸå› **ï¼šåˆ†ç»„å¤ªå¤§æˆ–æ­¥è¿›å»¶è¿Ÿå¤ªçŸ­
**è§£å†³**ï¼š
- å‡å°‘ `batchSize`ï¼ˆæ¯æ‰¹å¯åŠ¨æ›´å°‘æœåŠ¡å™¨ï¼‰
- å¢žåŠ  `staggerDelay`ï¼ˆæ‰¹æ¬¡é—´éš”æ›´é•¿ï¼‰

### é—®é¢˜ 4ï¼šç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿé«˜
**ç—‡çŠ¶**ï¼šç”¨æˆ·åé¦ˆå“åº”æ…¢
**åŽŸå› **ï¼šç¬¬ä¸€é˜¶æ®µå“åº”æ…¢
**è§£å†³**ï¼š
- å¢žåŠ  `activeTierSize`ï¼ˆé€‰æ‹©æ›´å¤šå€™é€‰ï¼‰
- å‡å°‘ `fallbackTimeout`ï¼ˆæ›´å¿«é™çº§åˆ°ç¬¬äºŒé˜¶æ®µï¼‰
- æ£€æŸ¥ Active Tier æœåŠ¡å™¨æ˜¯å¦å¥åº·

## ä¸Žå…¶ä»–ç­–ç•¥çš„å¯¹æ¯”

```
Sequential:  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ ä½ŽåŽ‹åŠ›ï¼Œé«˜å»¶è¿Ÿ
Racing:      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ ä¸­ç­‰åŽ‹åŠ›ï¼Œä¸­ç­‰å»¶è¿Ÿ
Parallel:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ é«˜åŽ‹åŠ›ï¼Œä½Žå»¶è¿Ÿ
Staggered:   â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ ä½ŽåŽ‹åŠ›ï¼Œä½Žå»¶è¿Ÿ â­
```

## ä»£ç ä½ç½®

- **ä¸»å®žçŽ°**ï¼š`upstream/manager_parallel.go`
- **é…ç½®**ï¼š`upstream/manager.go` ä¸­çš„ `NewManager` å‡½æ•°
- **è¯¦ç»†æ–‡æ¡£**ï¼š`upstream/STAGGERED_PARALLEL_STRATEGY.md`

## å…³é”®å‡½æ•°

| å‡½æ•° | ä½œç”¨ |
|------|------|
| `queryParallel` | ä¸¤é˜¶æ®µå¹¶è¡ŒæŸ¥è¯¢å…¥å£ |
| `executeQuery` | æ‰§è¡Œå•ä¸ªæŸ¥è¯¢ |
| `launchStaggeredTier` | åˆ†ç»„æ­¥è¿›å¯åŠ¨å¼•æ“Ž |
| `collectRemainingResponsesWithTimeout` | åŽå°æ”¶é›†å‡½æ•° |
| `getSortedHealthyServers` | èŽ·å–æŽ’åºåŽçš„å¥åº·æœåŠ¡å™¨ |

## å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆä¸ç›´æŽ¥ç”¨å…¨å¹¶å‘ï¼Ÿ**
A: å…¨å¹¶å‘ä¼šå¯¹ä¸Šæ¸¸é€ æˆçž¬æ—¶åŽ‹åŠ›ï¼Œç‰¹åˆ«æ˜¯åœ¨é…ç½®äº†å¤§é‡ä¸Šæ¸¸æ—¶ã€‚ä¸¤é˜¶æ®µæ–¹æ¡ˆåœ¨ä¿è¯å®Œæ•´æ€§çš„åŒæ—¶ï¼Œå‰Šå‡äº† 60% çš„çž¬æ—¶å¹¶å‘ã€‚

**Q: åŽå°è¡¥å…¨ä¼šä¸ä¼šæµªè´¹èµ„æºï¼Ÿ**
A: ä¸ä¼šã€‚åŽå°è¡¥å…¨æ˜¯å¼‚æ­¥çš„ï¼Œä¸é˜»å¡žç”¨æˆ·è¯·æ±‚ã€‚è€Œä¸”é€šè¿‡ Singleflight åŽ»é‡ï¼Œå¹¶å‘è¯·æ±‚ä¼šå…±äº«åŒä¸€ä¸ªè¡¥å…¨ä»»åŠ¡ã€‚

**Q: èƒ½å¦æå‰ç»ˆæ­¢åŽå°è¡¥å…¨ï¼Ÿ**
A: å¯ä»¥ï¼Œä½†éœ€è¦è°¨æ…Žã€‚å½“å‰å®žçŽ°ä¼˜å…ˆä¿è¯å®Œæ•´æ€§ï¼Œæ‰§è¡Œå®Œæ‰€æœ‰ä¸Šæ¸¸æˆ–è¾¾åˆ°ç¡¬è¶…æ—¶ã€‚å¦‚æžœéœ€è¦æå‰ç»ˆæ­¢ï¼Œå¯ä»¥æ·»åŠ "è¦†ç›–çŽ‡"æ¡ä»¶ã€‚

**Q: ä¸Ž Singleflight å¦‚ä½•åä½œï¼Ÿ**
A: Singleflight åœ¨è¯·æ±‚çº§åˆ«åŽ»é‡ï¼Œä¸¤é˜¶æ®µå¹¶è¡Œåœ¨å“åº”çº§åˆ«ä¼˜åŒ–ã€‚å¹¶å‘è¯·æ±‚ä¼šå…±äº«åŒä¸€ä¸ª Parallel ä»»åŠ¡çš„ç»“æžœã€‚

**Q: å¦‚ä½•ç›‘æŽ§æ•ˆæžœï¼Ÿ**
A: æŸ¥çœ‹æ—¥å¿—ä¸­çš„å…³é”®æŒ‡æ ‡ï¼š
- ç¬¬ä¸€é˜¶æ®µæˆåŠŸçŽ‡ï¼ˆç›®æ ‡ > 80%ï¼‰
- åŽå°è¡¥å…¨æ”¶é›†çŽ‡ï¼ˆç›®æ ‡ > 50%ï¼‰
- ç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿï¼ˆç›®æ ‡ < 100msï¼‰

## æ€»ç»“

ä¸¤é˜¶æ®µå¹¶è¡Œæ˜¯ä¸€ä¸ª**å¹³è¡¡åž‹æ–¹æ¡ˆ**ï¼š
- âœ… å¿«é€Ÿå“åº”ï¼ˆç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿä½Žï¼‰
- âœ… å®Œæ•´æ€§ä¿è¯ï¼ˆæ‰€æœ‰ä¸Šæ¸¸éƒ½è¢«æŸ¥è¯¢ï¼‰
- âœ… åŽ‹åŠ›å‹å¥½ï¼ˆä¸Šæ¸¸çž¬æ—¶å¹¶å‘ä½Žï¼‰
- âœ… å¯é æ€§é«˜ï¼ˆæ™ºèƒ½é™çº§å’Œè¶…æ—¶æŽ§åˆ¶ï¼‰

**æŽ¨èåœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­ä½¿ç”¨**ã€‚
