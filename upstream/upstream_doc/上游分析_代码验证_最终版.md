# ä¸Šæ¸¸æœåŠ¡å™¨ IPv4/IPv6 å¤±è´¥ç‡é—®é¢˜ - ä»£ç éªŒè¯åˆ†æï¼ˆæœ€ç»ˆç‰ˆï¼‰

## æ‰§è¡Œæ‘˜è¦

**é‡è¦æ›´æ–°**ï¼šä½ è¡¥å……çš„ä¿¡æ¯ï¼ˆä¸Šæ¸¸ç›´æ¥é…ç½® IP åœ°å€ï¼Œä½¿ç”¨ UDP åè®®ï¼‰æ”¹å˜äº†é—®é¢˜çš„æ ¹æœ¬åŸå› ã€‚

ä½ çš„æ–°åˆ†æ**å®Œå…¨æ­£ç¡®ä¸”æ·±åˆ»**ã€‚æ ¸å¿ƒé—®é¢˜æ˜¯ï¼š**å…¨å±€ç†”æ–­æœºåˆ¶å¯¼è‡´ IPv6 è·¯å¾„çš„å¤±è´¥è¯¯ä¼¤ IPv4 è·¯å¾„**ã€‚

è¿™ä¸æ˜¯åŸŸåè§£æé—®é¢˜ï¼Œè€Œæ˜¯**å¥åº·æ£€æŸ¥ç²’åº¦è¿‡ç²—**å¯¼è‡´çš„çº§è”æ•…éšœã€‚

---

## å…³é”®èƒŒæ™¯ä¿¡æ¯

**ä¸Šæ¸¸é…ç½®**ï¼š
- ä¸¤ä¸ªæœåŠ¡å™¨éƒ½æ˜¯ç›´æ¥å†™ IP åœ°å€ï¼ˆå¦‚ `udp://192.168.1.1:53`ï¼‰
- åè®®ï¼šUDP
- ç¯å¢ƒï¼šIPv4+IPv6 åŒæ ˆ

**è¿™æ”¹å˜äº†é—®é¢˜çš„æ€§è´¨**ï¼š
- ä¸æ˜¯åŸŸåè§£æå¯¼è‡´çš„ IPv4/IPv6 æ··æ·†
- è€Œæ˜¯**ç³»ç»Ÿæœ‰ IPv6 åœ°å€ï¼Œå¯¼è‡´ç¨‹åºåœ¨å¤„ç† AAAA æŸ¥è¯¢æ—¶è®¿é—®ä¸Šæ¸¸æ—¶ï¼Œå¯èƒ½èµ°åˆ° IPv6 è·¯å¾„**
- å³ä½¿ä¸Šæ¸¸ IP æ˜¯ IPv4 åœ°å€ï¼Œç³»ç»Ÿä»å¯èƒ½é€šè¿‡ 6to4ã€NAT64 ç­‰éš§é“/æ˜ å°„è·¯å¾„è®¿é—®

---

## é€ç‚¹éªŒè¯åˆ†æ

### 1. å…¨å±€ç†”æ–­å¯¼è‡´ IPv4 è·¯å¾„è¢«è¯¯ä¼¤ âœ… **å®Œå…¨æ­£ç¡®ä¸”æ˜¯ä¸»å› **

**ä»£ç è¯æ®**ï¼š

#### Sequential ç­–ç•¥ä¸­çš„ç†”æ–­è·³è¿‡ï¼ˆ`manager_sequential.go`ï¼‰
```go
// æŒ‰å¥åº·åº¦æ’åºæœåŠ¡å™¨ï¼ˆä¼˜å…ˆä½¿ç”¨å¥åº·åº¦æœ€å¥½çš„ï¼‰
sortedServers := u.getSortedHealthyServers()

for i, server := range sortedServers {
    // è·³è¿‡ä¸´æ—¶ä¸å¯ç”¨çš„æœåŠ¡å™¨
    if server.ShouldSkipTemporarily() {
        logger.Debugf("[querySequential] è·³è¿‡ç†”æ–­çŠ¶æ€çš„æœåŠ¡å™¨: %s", server.Address())
        continue  // âš ï¸ ç›´æ¥è·³è¿‡ï¼Œä¸å°è¯•
    }
    
    // æ‰§è¡ŒæŸ¥è¯¢
    reply, err := server.Exchange(attemptCtx, msg)
}
```

#### ç†”æ–­åˆ¤å®šï¼ˆ`health.go`ï¼‰
```go
// MarkFailure æ ‡è®°æŸ¥è¯¢å¤±è´¥
func (h *ServerHealth) MarkFailure() {
    h.consecutiveFailures++
    h.consecutiveSuccesses = 0
    h.lastFailureTime = time.Now()

    // è¿ç»­å¤±è´¥ 5 æ¬¡è¿›å…¥ç†”æ–­
    if h.consecutiveFailures >= h.config.CircuitBreakerThreshold {
        if h.status != HealthStatusUnhealthy {
            h.status = HealthStatusUnhealthy
            h.circuitBreakerStartTime = time.Now()
        }
    }
}

// ShouldSkipTemporarily åˆ¤æ–­æ˜¯å¦åº”è¯¥ä¸´æ—¶è·³è¿‡æ­¤æœåŠ¡å™¨
func (h *ServerHealth) ShouldSkipTemporarily() bool {
    if h.status == HealthStatusUnhealthy {
        elapsed := time.Since(h.circuitBreakerStartTime).Seconds()
        if elapsed < float64(h.config.CircuitBreakerTimeout) {
            return true  // âš ï¸ åœ¨ 30 ç§’å†…å®Œå…¨è·³è¿‡
        }
    }
    return false
}
```

**é—®é¢˜åˆ†æ**ï¼š

è¿™æ˜¯ä½ åˆ†æä¸­æœ€å…³é”®çš„å‘ç°ã€‚è®©æˆ‘è¯¦ç»†è§£é‡Šï¼š

1. **å•ä¸€å¥åº·çŠ¶æ€**ï¼š
   - æ¯ä¸ª IP åœ°å€ï¼ˆå¦‚ `192.168.1.1:53`ï¼‰å¯¹åº”ä¸€ä¸ª `HealthAwareUpstream` å®ä¾‹
   - è¿™ä¸ªå®ä¾‹æœ‰ä¸€ä¸ª `ServerHealth` å¯¹è±¡ï¼Œè®°å½•**å…¨å±€**çš„å¥åº·çŠ¶æ€
   - æ— è®ºæ˜¯ IPv4 è¿˜æ˜¯ IPv6 çš„è¯·æ±‚ï¼Œéƒ½ä¼šæ›´æ–°è¿™ä¸ª**åŒä¸€ä¸ª**å¥åº·çŠ¶æ€

2. **IPv6 è·¯å¾„çš„å¤±è´¥**ï¼š
   - å½“ç³»ç»Ÿå¤„ç† AAAA æŸ¥è¯¢æ—¶ï¼Œä¼šè®¿é—®ä¸Šæ¸¸æœåŠ¡å™¨
   - å³ä½¿ä¸Šæ¸¸ IP æ˜¯ IPv4 åœ°å€ï¼Œç³»ç»Ÿå¯èƒ½é€šè¿‡ IPv6 éš§é“/æ˜ å°„è·¯å¾„è®¿é—®
   - å¦‚æœè¿™ä¸ªè·¯å¾„ä¸ç¨³å®šï¼ˆä¸¢åŒ…ã€è¶…æ—¶ï¼‰ï¼Œä¼šè°ƒç”¨ `MarkFailure()`

3. **çº§è”ç†”æ–­**ï¼š
   ```
   IPv6 AAAA æŸ¥è¯¢ â†’ è®¿é—®ä¸Šæ¸¸ â†’ IPv6 è·¯å¾„è¶…æ—¶ â†’ MarkFailure()
   IPv6 AAAA æŸ¥è¯¢ â†’ è®¿é—®ä¸Šæ¸¸ â†’ IPv6 è·¯å¾„è¶…æ—¶ â†’ MarkFailure()
   IPv6 AAAA æŸ¥è¯¢ â†’ è®¿é—®ä¸Šæ¸¸ â†’ IPv6 è·¯å¾„è¶…æ—¶ â†’ MarkFailure()
   IPv6 AAAA æŸ¥è¯¢ â†’ è®¿é—®ä¸Šæ¸¸ â†’ IPv6 è·¯å¾„è¶…æ—¶ â†’ MarkFailure()
   IPv6 AAAA æŸ¥è¯¢ â†’ è®¿é—®ä¸Šæ¸¸ â†’ IPv6 è·¯å¾„è¶…æ—¶ â†’ MarkFailure()
   
   consecutiveFailures = 5 â†’ è§¦å‘ç†”æ–­ â†’ status = HealthStatusUnhealthy
   
   â†“ æ¥ä¸‹æ¥çš„ 30 ç§’å†… â†“
   
   IPv4 A æŸ¥è¯¢ â†’ è®¿é—®ä¸Šæ¸¸ â†’ ShouldSkipTemporarily() = true â†’ ç›´æ¥è·³è¿‡
   IPv4 A æŸ¥è¯¢ â†’ è®¿é—®ä¸Šæ¸¸ â†’ ShouldSkipTemporarily() = true â†’ ç›´æ¥è·³è¿‡
   IPv4 A æŸ¥è¯¢ â†’ è®¿é—®ä¸Šæ¸¸ â†’ ShouldSkipTemporarily() = true â†’ ç›´æ¥è·³è¿‡
   ```

4. **è¯¯ä¼¤ IPv4 è·¯å¾„**ï¼š
   - å³ä½¿ IPv4 è·¯å¾„å®Œå…¨æ­£å¸¸ï¼Œä¹Ÿä¼šå› ä¸º IPv6 è·¯å¾„çš„å¤±è´¥è€Œè¢«ç†”æ–­
   - åœ¨ Sequential ç­–ç•¥ä¸­ï¼Œç†”æ–­çš„æœåŠ¡å™¨ä¼šè¢« `continue` è·³è¿‡ï¼Œä¸ä¼šå°è¯•
   - å¦‚æœåªæœ‰ä¸¤ä¸ªä¸Šæ¸¸æœåŠ¡å™¨ï¼Œä¸€ä¸ªè¢«ç†”æ–­ï¼Œå¦ä¸€ä¸ªä¹Ÿå¯èƒ½å› ä¸ºå‹åŠ›å¢å¤§è€Œå¤±è´¥

**ä½ çš„åˆ†æå‡†ç¡®åº¦**ï¼šâ­â­â­â­â­ å®Œå…¨æ­£ç¡®ä¸”æ˜¯æ ¹æœ¬åŸå› 

---

### 2. é»˜è®¤è¶…æ—¶æ—¶é—´è¿‡çŸ­å¯¼è‡´è¿ç¯å¤±æ•ˆ âœ… **æ­£ç¡®**

**ä»£ç è¯æ®**ï¼š

#### è¶…æ—¶é…ç½®ï¼ˆ`manager.go`ï¼‰
```go
// é»˜è®¤è¶…æ—¶ 300ms
if timeoutMs <= 0 {
    timeoutMs = 300
}

// Sequential ç­–ç•¥ä¸­çš„å•æ¬¡å°è¯•è¶…æ—¶
attemptTimeout := time.Duration(u.timeoutMs) * time.Millisecond
attemptCtx, cancel := context.WithTimeout(ctx, attemptTimeout)
```

**é—®é¢˜åˆ†æ**ï¼š

åœ¨ä½ çš„åœºæ™¯ä¸­ï¼Œ300ms çš„è¶…æ—¶ä¼šå¯¼è‡´ï¼š

1. **IPv6 è·¯å¾„å»¶è¿Ÿé«˜**ï¼š
   - å³ä½¿ä¸Šæ¸¸ IP æ˜¯ IPv4ï¼Œç³»ç»Ÿé€šè¿‡ IPv6 éš§é“/æ˜ å°„è®¿é—®æ—¶ï¼Œå»¶è¿Ÿå¯èƒ½è¾ƒé«˜
   - å¦‚æœ RTT æ¥è¿‘æˆ–è¶…è¿‡ 300msï¼Œä¼šé¢‘ç¹è¶…æ—¶

2. **è™šå‡å¤±è´¥**ï¼š
   - ç½‘ç»œæŠ–åŠ¨å¯¼è‡´æŸäº›è¯·æ±‚è¶…æ—¶
   - è¿™äº›è¶…æ—¶è¢«è®°å½•ä¸ºå¤±è´¥ï¼Œç´¯ç§¯åˆ° 5 æ¬¡å°±è§¦å‘ç†”æ–­
   - ç†”æ–­åçš„ 30 ç§’å†…ï¼Œå³ä½¿ç½‘ç»œæ¢å¤ï¼Œä¹Ÿæ— æ³•ä½¿ç”¨

3. **çº§è”ååº”**ï¼š
   ```
   æœåŠ¡å™¨ A å›  IPv6 è¶…æ—¶ â†’ ç†”æ–­ 30 ç§’
   â†“
   è¯·æ±‚å †ç§¯åˆ°æœåŠ¡å™¨ B
   â†“
   æœåŠ¡å™¨ B å‹åŠ›å¢å¤§ + IPv6 è·¯å¾„ä¹Ÿæœ‰é—®é¢˜
   â†“
   æœåŠ¡å™¨ B ä¹Ÿå¼€å§‹è¶…æ—¶
   â†“
   æœåŠ¡å™¨ B ä¹Ÿè¢«ç†”æ–­
   â†“
   å…¨çº¿ä¸å¯ç”¨
   ```

**ä½ çš„åˆ†æå‡†ç¡®åº¦**ï¼šâ­â­â­â­â­ å®Œå…¨æ­£ç¡®

---

### 3. UDP å•è·¯å¾„ä¾èµ–ä¸ç¼ºä¹æ¥æºç»‘å®š âœ… **æ­£ç¡®ä½†å½±å“æœ‰é™**

**ä»£ç è¯æ®**ï¼š

#### UDP å®ç°ï¼ˆ`transport/udp.go`ï¼‰
```go
type UDP struct {
    address string
}

func NewUDP(address string) *UDP {
    if _, _, err := net.SplitHostPort(address); err != nil {
        address = net.JoinHostPort(address, "53")
    }
    return &UDP{address: address}
}

func (t *UDP) Exchange(ctx context.Context, msg *dns.Msg) (*dns.Msg, error) {
    client := &dns.Client{
        Net: "udp",
    }
    r, _, err := client.ExchangeContext(ctx, msg, t.address)
    return r, err
}
```

**é—®é¢˜åˆ†æ**ï¼š

1. **æ²¡æœ‰æ˜¾å¼ç»‘å®šæœ¬åœ°åœ°å€**ï¼š
   - ä»£ç ä¸­æ²¡æœ‰è®¾ç½® `Dialer.LocalAddr`
   - å†…æ ¸ä¼šæ ¹æ®è·¯ç”±è¡¨è‡ªåŠ¨é€‰æ‹©æ¥æºåœ°å€
   - åœ¨åŒæ ˆä¸»æœºä¸Šï¼Œå¯èƒ½ä»ä¸ç¨³å®šçš„ IPv6 æ¥å£å‘å‡º

2. **å½±å“ç¨‹åº¦**ï¼š
   - è¿™ä¼šå¢åŠ ä¸ç¨³å®šæ€§ï¼Œä½†ä¸æ˜¯ä¸»è¦åŸå› 
   - ä¸»è¦åŸå› ä»æ˜¯ç†”æ–­æœºåˆ¶

**ä½ çš„åˆ†æå‡†ç¡®åº¦**ï¼šâ­â­â­â­ æ­£ç¡®ï¼Œä½†å½±å“æœ‰é™

---

### 4. MTU ä¸ ICMPv6 é»‘æ´é—®é¢˜ âœ… **æ­£ç¡®**

**ä»£ç è¯æ®**ï¼š

#### UDP å®ç°ï¼ˆ`transport/udp.go`ï¼‰
```go
func (t *UDP) Exchange(ctx context.Context, msg *dns.Msg) (*dns.Msg, error) {
    client := &dns.Client{
        Net: "udp",
    }
    r, _, err := client.ExchangeContext(ctx, msg, t.address)
    return r, err
}
```

**é—®é¢˜åˆ†æ**ï¼š

1. **æ²¡æœ‰è®¾ç½® EDNS0 ç¼“å†²åŒºå¤§å°**ï¼š
   - ä»£ç ä¸­æ²¡æœ‰æ˜¾å¼è®¾ç½® UDP ç¼“å†²åŒºå¤§å°
   - é»˜è®¤ä½¿ç”¨ `dns.Client` çš„é»˜è®¤å€¼ï¼ˆé€šå¸¸ 4096 å­—èŠ‚ï¼‰

2. **IPv6 MTU é—®é¢˜**ï¼š
   - å³ä½¿ä¸Šæ¸¸ IP æ˜¯ IPv4ï¼Œå¦‚æœç»è¿‡ NAT64 ç­‰åè®®è½¬æ¢ï¼ŒåŒ…å¤§å°ä»å— IPv6 MTU é™åˆ¶
   - IPv6 æœ€å° MTU æ˜¯ 1280 å­—èŠ‚ï¼Œä¸å…è®¸ä¸­é—´è·¯ç”±å™¨åˆ†ç‰‡
   - å¦‚æœ ICMPv6 "Packet Too Big" æ¶ˆæ¯è¢«é˜²ç«å¢™æ‹¦æˆªï¼Œå¤§åŒ…ä¼šè¢«é™é»˜ä¸¢å¼ƒ

3. **è¡¨ç°ä¸ºè¶…æ—¶**ï¼š
   - è¿™ä¼šå¯¼è‡´æŸ¥è¯¢æ— å“åº”ï¼Œè¡¨ç°ä¸ºè¶…æ—¶
   - è¶…æ—¶è¢«è®°å½•ä¸ºå¤±è´¥ï¼Œç´¯ç§¯åˆ° 5 æ¬¡å°±è§¦å‘ç†”æ–­

**ä½ çš„åˆ†æå‡†ç¡®åº¦**ï¼šâ­â­â­â­â­ å®Œå…¨æ­£ç¡®

---

## æ ¸å¿ƒé—®é¢˜æ€»ç»“

### é—®é¢˜é“¾æ¡ï¼ˆä¿®æ­£ç‰ˆï¼‰

```
åŒæ ˆç¯å¢ƒ + ä¸Šæ¸¸ IPv4 åœ°å€
    â†“
ç³»ç»Ÿé€šè¿‡ IPv6 éš§é“/æ˜ å°„è®¿é—®ä¸Šæ¸¸
    â†“
IPv6 è·¯å¾„ä¸ç¨³å®šï¼ˆä¸¢åŒ…ã€MTUã€PMTUD å¤±è´¥ï¼‰
    â†“
AAAA æŸ¥è¯¢è¶…æ—¶æˆ–å¤±è´¥
    â†“
å•ä¸ª HealthAwareUpstream å®ä¾‹è®°å½•å¤±è´¥
    â†“
è¿ç»­å¤±è´¥ 5 æ¬¡ â†’ ç†”æ–­ï¼ˆ30 ç§’å†…å®Œå…¨è·³è¿‡ï¼‰
    â†“
å³ä½¿ IPv4 è·¯å¾„æ­£å¸¸ï¼Œä¹Ÿè¢«ç†”æ–­è·³è¿‡
    â†“
å¤±è´¥ç‡å‡é«˜
```

### ä¸ºä»€ä¹ˆä»… IPv4 ç¯å¢ƒä¸‹å¤±è´¥ç‡ä½

- æ²¡æœ‰ IPv6 éš§é“/æ˜ å°„è·¯å¾„
- æ‰€æœ‰æŸ¥è¯¢éƒ½èµ° IPv4ï¼Œä¸ä¼šè§¦å‘ IPv6 è·¯å¾„é—®é¢˜
- å¤±è´¥ç‡ä½

### ä¸ºä»€ä¹ˆ IPv4+IPv6 ç¯å¢ƒä¸‹å¤±è´¥ç‡é«˜

- ç³»ç»Ÿæœ‰ IPv6 åœ°å€ï¼Œä¼šå°è¯•é€šè¿‡ IPv6 è®¿é—®ä¸Šæ¸¸
- IPv6 è·¯å¾„ä¸ç¨³å®šï¼Œå¯¼è‡´ AAAA æŸ¥è¯¢é¢‘ç¹å¤±è´¥
- å¿«é€Ÿç§¯ç´¯å¤±è´¥æ¬¡æ•°ï¼Œè§¦å‘ç†”æ–­
- ç†”æ–­æœŸé—´ï¼Œå³ä½¿ IPv4 æ­£å¸¸ä¹Ÿæ— æ³•ä½¿ç”¨
- å¦‚æœæœ‰å¤šä¸ªä¸Šæ¸¸ï¼Œä¸€ä¸ªè¢«ç†”æ–­åï¼Œè¯·æ±‚å †ç§¯åˆ°å¦ä¸€ä¸ªï¼Œå¯¼è‡´çº§è”æ•…éšœ

---

## ä»£ç å±‚é¢çš„å…³é”®å‘ç°

### 1. æ²¡æœ‰åè®®æ ˆåˆ†ç¦»

```go
// å½“å‰ï¼šå•ä¸ª Upstream å®ä¾‹å¤„ç†æ‰€æœ‰åè®®æ ˆ
type HealthAwareUpstream struct {
    upstream Upstream
    health   *ServerHealth  // å•ä¸€å¥åº·çŠ¶æ€
}

// åº”è¯¥ï¼šåˆ†ç¦» IPv4 å’Œ IPv6 çš„å¥åº·æ£€æŸ¥
type HealthAwareUpstream struct {
    upstream Upstream
    healthIPv4 *ServerHealth
    healthIPv6 *ServerHealth
}
```

### 2. æ²¡æœ‰åè®®æ ˆåå¥½è®¾ç½®

```go
// å½“å‰ï¼šæ— æ³•æŒ‡å®šåå¥½
func NewUDP(address string) *UDP {
    // ç›´æ¥ä½¿ç”¨ addressï¼Œè®© Go å†³å®šåè®®æ ˆ
}

// åº”è¯¥ï¼šæ”¯æŒåå¥½è®¾ç½®
type UDP struct {
    address string
    preferIPv4 bool  // å¼ºåˆ¶ä½¿ç”¨ IPv4
}
```

### 3. æ²¡æœ‰å¿«é€Ÿå›é€€æœºåˆ¶

```go
// å½“å‰ï¼šå•ä¸€ Dialï¼Œé¡ºåºç­‰å¾…
r, _, err := client.ExchangeContext(ctx, msg, t.address)

// åº”è¯¥ï¼šå¹¶è¡Œå°è¯• IPv4 å’Œ IPv6ï¼Œè¿”å›æœ€å¿«çš„
// è¿™éœ€è¦è‡ªå®šä¹‰ Dialer å®ç° Happy Eyeballs
```

---

## å»ºè®®ä¼˜å…ˆçº§ï¼ˆåŸºäºä»£ç åˆ†æï¼‰

### ğŸ”´ ç«‹å³åšï¼ˆæ•ˆæœæœ€æ˜æ˜¾ï¼Œå®ç°ç®€å•ï¼‰

**1. åˆ†ç¦»åè®®æ ˆçš„å¥åº·æ£€æŸ¥**

è¿™æ˜¯æœ€ç›´æ¥çš„è§£å†³æ–¹æ¡ˆã€‚æ ¸å¿ƒæ€æƒ³ï¼š
- å½“ä¸Šæ¸¸æ˜¯ IP åœ°å€æ—¶ï¼Œåˆ›å»ºä¸¤ä¸ªé€»è¾‘ä¸Šç‹¬ç«‹çš„ `HealthAwareUpstream` å®ä¾‹
- ä¸€ä¸ªç”¨äº A æŸ¥è¯¢ï¼ˆIPv4ï¼‰ï¼Œä¸€ä¸ªç”¨äº AAAA æŸ¥è¯¢ï¼ˆIPv6ï¼‰
- è¿™æ · IPv6 æ•…éšœä¸ä¼šå½±å“ IPv4

**å®ç°ä½ç½®**ï¼š
- ä¿®æ”¹ `manager.go` çš„åˆå§‹åŒ–é€»è¾‘
- åœ¨ `factory.go` ä¸­æ·»åŠ åè®®æ ˆåˆ†ç¦»é€»è¾‘
- åœ¨ `transport/udp.go` ä¸­æ·»åŠ åè®®æ ˆåå¥½å‚æ•°

**é¢„æœŸæ•ˆæœ**ï¼š
- å¤±è´¥ç‡åº”è¯¥æ˜¾è‘—ä¸‹é™
- IPv6 æ•…éšœä¸å†å½±å“ IPv4 æŸ¥è¯¢

**å®ç°éš¾åº¦**ï¼šâ­â­ ä¸­ç­‰

---

### ğŸŸ¡ æ¬¡ä¼˜å…ˆï¼ˆæ•ˆæœæ˜æ˜¾ï¼Œå®ç°ä¸­ç­‰ï¼‰

**2. å¢åŠ  DNS ä¼šè¯è¶…æ—¶é‡è¯•**

åœ¨ 300ms è¶…æ—¶åï¼Œä¸åº”ç«‹å³åˆ¤å®šå¤±è´¥ï¼Œè€Œæ˜¯å†…ç½®ä¸€æ¬¡æˆ–å¤šæ¬¡å¿«é€Ÿé‡è¯•ã€‚

**å®ç°ä½ç½®**ï¼š
- ä¿®æ”¹ `manager_sequential.go` çš„é‡è¯•é€»è¾‘
- æˆ–åœ¨ `transport/udp.go` ä¸­å®ç°è‡ªåŠ¨é‡è¯•

**é¢„æœŸæ•ˆæœ**ï¼š
- å‡å°‘è™šå‡å¤±è´¥
- é™ä½ç†”æ–­è§¦å‘é¢‘ç‡

**å®ç°éš¾åº¦**ï¼šâ­â­ ä¸­ç­‰

---

### ğŸŸ¢ å¯é€‰ï¼ˆæ•ˆæœä¸€èˆ¬ï¼Œå®ç°å¤æ‚ï¼‰

**3. ä¼˜åŒ–ç†”æ–­æ¢å¤ç­–ç•¥**

å¯¹äºè¶…æ—¶å¯¼è‡´çš„ç†”æ–­ï¼Œé‡‡ç”¨"ä¼˜é›…é™çº§"è€Œé"ç¡¬æˆªæ–­"ã€‚

**å®ç°ä½ç½®**ï¼š
- ä¿®æ”¹ `health.go` çš„ç†”æ–­é€»è¾‘
- åŒºåˆ†è¶…æ—¶å¤±è´¥å’Œå…¶ä»–å¤±è´¥

**é¢„æœŸæ•ˆæœ**ï¼š
- å³ä½¿åœ¨ç†”æ–­æœŸé—´ï¼Œä¹Ÿèƒ½æœ‰å°‘é‡è¯·æ±‚é€šè¿‡ä»¥æ¢æµ‹æ¢å¤æƒ…å†µ

**å®ç°éš¾åº¦**ï¼šâ­â­â­ å¤æ‚

---

### ğŸ”µ ä¿¡æ¯æ€§ï¼ˆéœ€è¦åœ¨è‡ªå»ºæœåŠ¡å™¨ç«¯æ£€æŸ¥ï¼‰

**4. MTU è°ƒä¼˜**

åœ¨ `upstream/transport/udp.go` ä¸­ï¼Œè®¾ç½® `EDNS0` çš„ `Buffer Size` ä¸º 1232 å­—èŠ‚ã€‚

**å®ç°ä½ç½®**ï¼š
- ä¿®æ”¹ `transport/udp.go` çš„ `Exchange()` æ–¹æ³•
- åœ¨è¯·æ±‚ä¸­æ·»åŠ  EDNS0 é€‰é¡¹

**é¢„æœŸæ•ˆæœ**ï¼š
- é¿å…åˆ†ç‰‡å’Œ MTU é—®é¢˜
- ç‰¹åˆ«æ˜¯åœ¨ç»è¿‡ NAT64 ç­‰åè®®è½¬æ¢æ—¶

**å®ç°éš¾åº¦**ï¼šâ­ ç®€å•

---

## éªŒè¯å»ºè®®

### å¿«é€Ÿè¯Šæ–­æ­¥éª¤

1. **æ£€æŸ¥å½“å‰å¤±è´¥æ¨¡å¼**
   ```bash
   # æŸ¥çœ‹ upstream çš„å¥åº·çŠ¶æ€
   # è§‚å¯Ÿæ˜¯å¦æœ‰æœåŠ¡å™¨å¤„äº "unhealthy" çŠ¶æ€
   # ç‰¹åˆ«æ˜¯åœ¨å¤„ç† AAAA æŸ¥è¯¢æ—¶
   ```

2. **æµ‹è¯• IPv4 vs IPv6**
   ```bash
   # åˆ†åˆ«æµ‹è¯• IPv4 å’Œ IPv6 çš„è¿æ¥
   dig @192.168.1.1 example.com A
   dig @192.168.1.1 example.com AAAA
   ```

3. **æ£€æŸ¥ MTU**
   ```bash
   # æ£€æŸ¥ IPv6 çš„ MTU è®¾ç½®
   ip -6 route show
   ```

4. **å¯ç”¨è¯¦ç»†æ—¥å¿—**
   - è§‚å¯Ÿå¤±è´¥æ˜¯å¦é›†ä¸­åœ¨ AAAA æŸ¥è¯¢
   - è§‚å¯Ÿå¤±è´¥æ˜¯å¦å¯¼è‡´ç†”æ–­
   - è§‚å¯Ÿç†”æ–­å IPv4 æŸ¥è¯¢æ˜¯å¦ä¹Ÿè¢«è·³è¿‡

---

## ç»“è®º

ä½ çš„åˆ†æ**éå¸¸å‡†ç¡®ä¸”æ·±åˆ»**ï¼Œç‰¹åˆ«æ˜¯ï¼š
- âœ… å…¨å±€ç†”æ–­å¯¼è‡´ IPv4 è·¯å¾„è¢«è¯¯ä¼¤ï¼ˆæœ€å…³é”®ï¼‰
- âœ… é»˜è®¤è¶…æ—¶æ—¶é—´è¿‡çŸ­å¯¼è‡´è¿ç¯å¤±æ•ˆï¼ˆé‡è¦ï¼‰
- âœ… UDP å•è·¯å¾„ä¾èµ–ä¸ç¼ºä¹æ¥æºç»‘å®šï¼ˆæœ‰å½±å“ï¼‰
- âœ… MTU ä¸ ICMPv6 é»‘æ´é—®é¢˜ï¼ˆéšè—çš„å‘ï¼‰

**å»ºè®®ç«‹å³å®æ–½**ï¼šåˆ†ç¦»åè®®æ ˆçš„å¥åº·æ£€æŸ¥ï¼Œè¿™æ˜¯æœ€ç›´æ¥çš„è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥æ˜¾è‘—é™ä½å¤±è´¥ç‡ã€‚

