# 上游 IPv4/IPv6 失败率问题 - 快速参考

## 问题一句话总结

IPv6 路径的失败导致整个上游被熔断 30 秒，即使 IPv4 路径正常也无法使用。

---

## 根本原因

```
单个 HealthAwareUpstream 实例
    ↓
一个 ServerHealth 对象（全局健康状态）
    ↓
IPv6 失败 + IPv4 失败 → 同一个计数器
    ↓
5 次失败 → 熔断
    ↓
30 秒内完全跳过（包括 IPv4）
```

---

## 代码位置

| 问题 | 文件 | 函数 |
|-----|-----|------|
| 单一健康状态 | `upstream/health_aware.go` | `Exchange()` |
| 熔断判定 | `upstream/health.go` | `MarkFailure()` |
| 熔断跳过 | `upstream/manager_sequential.go` | `querySequential()` |
| 超时设置 | `upstream/manager.go` | `NewManager()` |

---

## 解决方案（优先级）

### 🔴 立即做：分离协议栈

**修改文件**：
1. `transport/udp.go` - 添加 `preferIPv4` 参数
2. `factory.go` - 添加 `NewUpstreamWithStackPreference()`
3. `manager.go` - 添加 `NewManagerWithStackSeparation()`

**效果**：失败率下降 50-80%

**工作量**：2-4 小时

---

### 🟡 次优先：增加重试

**修改文件**：
1. `manager_sequential.go` - 添加重试逻辑

**效果**：减少虚假失败

**工作量**：1-2 小时

---

### 🟢 可选：优化熔断

**修改文件**：
1. `health.go` - 区分超时和其他失败

**效果**：更快恢复

**工作量**：2-4 小时

---

### 🔵 简单：MTU 调优

**修改文件**：
1. `manager_sequential.go` - 设置 EDNS0 缓冲区

**效果**：减少大包超时

**工作量**：30 分钟

---

## 验证方法

### 1. 查看日志

```bash
# 启用详细日志，观察：
# - AAAA 查询是否失败
# - 是否触发熔断
# - 熔断后 A 查询是否被跳过
```

### 2. 测试查询

```bash
# 分别测试 IPv4 和 IPv6
dig @192.168.1.1 example.com A
dig @192.168.1.1 example.com AAAA
```

### 3. 监控指标

- 失败率（应该下降）
- 熔断事件（应该减少）
- 响应时间（应该稳定）

---

## 关键数字

| 参数 | 值 | 说明 |
|-----|-----|------|
| 超时时间 | 300ms | 可能过短 |
| 失败阈值 | 3 次 | 进入降级状态 |
| 熔断阈值 | 5 次 | 进入熔断状态 |
| 熔断时间 | 30 秒 | 完全跳过时间 |
| 恢复阈值 | 2 次 | 连续成功恢复 |

---

## 快速诊断

### 症状 1：失败率在双栈环境下升高

**可能原因**：IPv6 路径问题 → 熔断 → IPv4 也被跳过

**验证**：查看日志中是否有 AAAA 查询失败后 A 查询被跳过

### 症状 2：间歇性全线不可用

**可能原因**：两个上游都被熔断

**验证**：查看日志中是否有多个服务器同时进入熔断状态

### 症状 3：恢复缓慢

**可能原因**：熔断 30 秒超时太长

**验证**：观察故障恢复时间是否接近 30 秒

---

## 实施清单

- [ ] 理解问题根本原因
- [ ] 阅读 `上游问题_实现方案.md`
- [ ] 修改 `transport/udp.go`
- [ ] 修改 `factory.go`
- [ ] 修改 `manager.go`
- [ ] 编译测试
- [ ] 在双栈环境下验证
- [ ] 对比失败率改善
- [ ] 考虑可选优化

---

## 相关文档

| 文档 | 用途 |
|-----|------|
| `上游分析.md` | 问题分析 |
| `上游分析_代码验证_最终版.md` | 代码验证 |
| `上游问题_实现方案.md` | 详细实现 |
| `分析总结.md` | 完整总结 |
| `快速参考.md` | 本文件 |

---

## 常见问题

### Q: 为什么仅 IPv4 环境下没有问题？

A: 因为没有 IPv6 路径，所以不会触发 IPv6 失败，也就不会熔断。

### Q: 为什么不直接禁用 IPv6？

A: 因为程序需要支持 AAAA 查询，禁用 IPv6 会导致功能缺失。

### Q: 分离协议栈会增加内存占用吗？

A: 会增加一倍的 `HealthAwareUpstream` 实例，但内存占用仍然很小。

### Q: 分离协议栈会影响性能吗？

A: 不会，因为查询时会根据类型选择合适的列表，不会增加额外开销。

### Q: 如何快速验证修改是否有效？

A: 在双栈环境下运行，观察失败率是否下降。

---

## 下一步

1. **立即**：实施方案 1（分离协议栈）
2. **测试**：在双栈环境下验证
3. **优化**：根据结果考虑方案 2、3、4
4. **监控**：持续观察失败率和熔断事件

