# 上游服务器访问故障分析

在 IPv4+IPv6 双栈环境下，程序作为转发器访问上游递归服务器失败率升高。根据最新的补充信息（上游服务器使用 IP 地址直接配置，协议为 UDP），重新进行深度代码分析：

## 1. 全局熔断导致 IPv4 路径被误伤 (Global Circuit Breaker)
**关键位置**: `upstream/health.go`, `upstream/manager_utils.go`

即便上游配置的是 IP 地址，健康检查机制仍然是主要风险点：
- **问题**：如果系统有 IPv6 地址，由于上游是递归服务器，程序在处理客户端 AAAA 查询时会访问上游。
- **机制**：如果网络环境中的 IPv6 到达该 IP 的路径不稳定（即便该 IP 是公网 IPv4 地址，但如果走到了 6to4 或类似的隧道/映射路径），会导致 UDP 包丢失或超时。
- **后果**：一旦 IPv6 请求由于路径问题连续失败（默认 5 次），该 IP 服务器会被标记为 `HealthStatusUnhealthy` 并熔断 30 秒。
- **误伤**：熔断是针对该服务器实体的。这意味着原本正常的 IPv4 请求也会因为这 30 秒的熔断窗口而被直接拦截，导致整体失败率大幅上升。

## 2. 默认超时时间过短导致连环失效 (Default Timeout)
**关键位置**: `config/config_defaults.go`, `upstream/manager.go`

- **现状**：程序默认的 `timeout_ms` 是 300ms。
- **风险**：在双栈环境下，UDP 路径可能会因为复杂的路由（尤其是自建递归服务器可能涉及跨网段）导致延迟抖动。一旦 RTT 接近 300ms，大量的“虚假失败”会触发上述的熔断机制。
- **级联反应**：一个服务器熔断后，剩余请求会堆积到其他服务器，导致其他服务器也因压力增大或路径抖动而触发熔断，最终形成全线不可用的局面。

## 3. UDP 单路径依赖与缺乏来源绑定 (Single Path UDP)
**关键位置**: `upstream/transport/udp.go`

- **问题**：程序在 `net.Dial` 时没有显式绑定本地来源地址（Local Address）。
- **风险**：在双栈主机上，内核会根据路由表自动选择来源。如果路由表变更或有多个 IPv6 输出接口，UDP 包可能会从不稳定的接口发出，而程序对此完全无感。

## 4. MTU 与 ICMPv6 黑洞问题 (IPv6 UDP MTU)
**关键位置**: `upstream/transport/udp.go`

即便上游是 IPv4 地址，如果经过了某些协议转换（如 NAT64），包大小仍受 IPv6 MTU 限制。
- **风险**：UDP 响应包如果超过 1280 字节（IPv6 的最小 MTU），且中间链路屏蔽了 ICMPv6，包会被静默丢弃。
- **现象**：IPv4 环境下由于路由器可以进行分片，响应正常；IPv4+IPv6 环境下，由于路径 MTU 限制，大包（如包含大量记录的回复）会频繁超时。

---

# 改进建议 (针对 IP 配置场景)

1.  **细化健康检查维度**：
    将健康度统计从“按服务器”细化为“按服务器+协议栈”。确保 IPv6 路径的失败不会拖累 IPv4 路径。

2.  **增加 DNS 会话超时重试**：
    在 300ms 超时后，不应立即判定失败，而是内置一次或多次快速重试。

3.  **优化熔断恢复策略**：
    对于超时导致的熔断，可以采用“优雅降级”而非“硬截断”。例如：不再作为首选服务器，但仍允许少部分请求通过以探测恢复情况。

4.  **MTU 调优**：
    在 `upstream/transport/udp.go` 中，可以尝试设置 `EDNS0` 的 `Buffer Size` 为 1232 字节（这是目前互联网上推荐的最佳实践，以避免分片和 MTU 问题）。
