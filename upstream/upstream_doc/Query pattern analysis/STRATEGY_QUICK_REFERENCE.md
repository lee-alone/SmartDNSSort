# 上游查询策略快速参考

## 策略选择决策树

```
开始
  ↓
有多少个上游服务器？
  ├─ 1 个 → Sequential（唯一选择）
  ├─ 2-3 个 → 
  │   ├─ 网络好？→ Racing（推荐）
  │   └─ 网络差？→ Parallel
  ├─ 4-6 个 →
  │   ├─ 资源充足？→ Racing（推荐）
  │   ├─ 资源有限？→ Sequential
  │   └─ 需要完整 IP？→ Parallel
  └─ 7+ 个 →
      ├─ 资源充足？→ Sequential（推荐）
      ├─ 需要完整 IP？→ Parallel（谨慎）
      └─ 需要均衡？→ Random
```

---

## 策略对比速查表

### 响应速度

```
Parallel  ████████████████████ 最快（第一个成功即返回）
Racing    ███████████████░░░░░ 很快（平衡速度和资源）
Sequential ██████████░░░░░░░░░ 中等（取决于第一个服务器）
Random    ████░░░░░░░░░░░░░░░ 慢（随机顺序）
```

### 资源消耗

```
Parallel  ████████████████████ 最高（并发所有）
Racing    ███████████░░░░░░░░░ 中等（延迟后并发）
Sequential ██░░░░░░░░░░░░░░░░░ 最低（逐个尝试）
Random    ██░░░░░░░░░░░░░░░░░ 最低（逐个尝试）
```

### 完整性（IP 池）

```
Parallel  ████████████████████ 最完整（汇总所有）
Racing    ██░░░░░░░░░░░░░░░░░ 低（只返回第一个）
Sequential ██░░░░░░░░░░░░░░░░░ 低（只返回第一个）
Random    ██░░░░░░░░░░░░░░░░░ 低（只返回第一个）
```

### 可靠性

```
Parallel  ████████████████████ 最高（多个备选）
Racing    ███████████████░░░░░ 很高（有备选方案）
Sequential ███████████░░░░░░░░░ 高（有多个备选）
Random    ███████████░░░░░░░░░ 高（有多个备选）
```

### 负载均衡

```
Parallel  ████░░░░░░░░░░░░░░░ 低（所有服务器同时承载）
Racing    ██████░░░░░░░░░░░░░ 中等（优先使用最佳的）
Sequential ████████░░░░░░░░░░░ 好（按健康度分散）
Random    ████████████████████ 最好（完全随机分散）
```

---

## 场景推荐

### 场景 1：ISP DNS（2-3 个服务器）

**特点：** 服务器少，需要高可靠性

**推荐：** Parallel

**配置：**
```yaml
strategy: parallel
timeout_ms: 3000
concurrency: 3
```

**理由：**
- 服务器少，资源消耗可接受
- 需要最完整的 IP 池
- 可靠性最高

---

### 场景 2：公共 DNS（3-5 个服务器）

**特点：** 服务器中等，需要平衡速度和资源

**推荐：** Racing

**配置：**
```yaml
strategy: racing
timeout_ms: 2000
racing_delay: 50
racing_max_concurrent: 2
```

**理由：**
- 平衡速度和资源消耗
- 可靠性高
- 适合大多数场景

---

### 场景 3：企业 DNS（5+ 个服务器）

**特点：** 服务器多，需要节省资源

**推荐：** Sequential

**配置：**
```yaml
strategy: sequential
timeout_ms: 5000
sequential_timeout: 1500
```

**理由：**
- 资源消耗最低
- 优先使用最健康的服务器
- 适合资源受限的环境

---

### 场景 4：混合 DNS（多个不同类型）

**特点：** 服务器多且类型不同，需要自动优化

**推荐：** Auto

**配置：**
```yaml
strategy: auto
timeout_ms: 3000
dynamic_param_optimization:
  ewma_alpha: 0.2
  max_step_ms: 10
```

**理由：**
- 自动选择最优策略
- 支持动态参数优化
- 无需手动调整

---

### 场景 5：网络不稳定

**特点：** 网络质量差，需要高可靠性

**推荐：** Parallel 或 Racing

**配置：**
```yaml
strategy: parallel  # 或 racing
timeout_ms: 5000    # 延长超时
concurrency: 3
```

**理由：**
- 多个备选方案
- 更容易成功
- 容错能力强

---

### 场景 6：低延迟要求

**特点：** 需要快速响应

**推荐：** Parallel 或 Racing

**配置：**
```yaml
strategy: parallel  # 或 racing
timeout_ms: 1000    # 缩短超时
concurrency: 3
```

**理由：**
- 响应最快
- 第一个成功即返回
- 不需要等待所有服务器

---

### 场景 7：资源受限（嵌入式设备）

**特点：** CPU/内存/网络有限

**推荐：** Sequential 或 Random

**配置：**
```yaml
strategy: sequential
timeout_ms: 5000
sequential_timeout: 1500
concurrency: 1
```

**理由：**
- 资源消耗最低
- 逐个尝试
- 适合嵌入式环境

---

## 参数调优指南

### timeout_ms（总超时时间）

| 网络条件 | 推荐值 | 说明 |
|---------|--------|------|
| 很好 | 1000-2000ms | 快速响应 |
| 一般 | 2000-3000ms | 平衡 |
| 较差 | 3000-5000ms | 容错 |
| 很差 | 5000-10000ms | 最大容错 |

### racing_delay（竞速延迟）

| 网络延迟 | 推荐值 | 说明 |
|---------|--------|------|
| < 50ms | 10-20ms | 给第一个服务器优势 |
| 50-100ms | 20-50ms | 平衡 |
| 100-200ms | 50-100ms | 给更多时间 |
| > 200ms | 100-200ms | 最大延迟 |

### sequential_timeout（顺序超时）

| 场景 | 推荐值 | 说明 |
|------|--------|------|
| 快速网络 | 500-1000ms | 快速失败 |
| 一般网络 | 1000-1500ms | 平衡 |
| 慢速网络 | 1500-2000ms | 给更多时间 |

### concurrency（并发数）

| 场景 | 推荐值 | 说明 |
|------|--------|------|
| 资源充足 | CPU 核数 * 10 | 最大并发 |
| 资源一般 | CPU 核数 * 5 | 中等并发 |
| 资源受限 | CPU 核数 | 最小并发 |

---

## 常见问题

### Q1：为什么 Parallel 策略会导致上游限流？

**A：** Parallel 同时向所有服务器发起请求，如果服务器数量多或查询频繁，可能超过上游的限流阈值。

**解决方案：**
1. 减少上游服务器数量
2. 使用 Racing 或 Sequential 策略
3. 配置 `parallel_max_concurrent` 限制并发数
4. 增加缓存 TTL，减少查询频率

---

### Q2：Sequential 策略为什么响应慢？

**A：** 如果第一个服务器响应慢，整个查询都会慢。

**解决方案：**
1. 改用 Racing 策略
2. 调整服务器顺序（把快的放前面）
3. 缩短 `sequential_timeout`
4. 启用健康检查，自动跳过慢的服务器

---

### Q3：Racing 策略的延迟参数怎么调？

**A：** 延迟应该基于网络延迟。

**调优步骤：**
1. 测试网络延迟：`ping -c 10 <server>`
2. 计算平均延迟
3. 设置 `racing_delay = 平均延迟 * 0.5`
4. 观察性能，逐步调整

---

### Q4：如何选择最优策略？

**A：** 使用 Auto 策略，让系统自动选择。

**或者手动选择：**
1. 查看上游服务器数量
2. 评估网络条件
3. 考虑资源限制
4. 参考上面的"场景推荐"

---

### Q5：如何监控策略性能？

**A：** 查看日志中的性能指标。

**关键指标：**
- 平均响应时间
- 成功率
- 错误率
- 资源消耗

**查看方法：**
```bash
# 查看最近的性能统计
grep "Performance" /var/log/smartdnssort.log

# 查看策略切换日志
grep "策略切换" /var/log/smartdnssort.log
```

---

### Q6：如何处理某个上游服务器故障？

**A：** 系统会自动检测并跳过。

**自动处理：**
1. 健康检查检测故障
2. 自动标记为"不可用"
3. 后续查询自动跳过
4. 定期尝试恢复

**手动处理：**
1. 从配置中移除故障服务器
2. 重启服务
3. 或者等待自动恢复

---

## 性能基准

### 测试环境
- 上游服务器：3 个（延迟 50ms, 100ms, 150ms）
- 网络条件：正常
- 查询类型：A 记录
- 样本数：1000 次查询

### 测试结果

| 策略 | 平均延迟 | P95 延迟 | 成功率 | 资源 |
|------|---------|---------|--------|------|
| Parallel | 52ms | 65ms | 99.9% | 高 |
| Racing | 58ms | 72ms | 99.8% | 中 |
| Sequential | 65ms | 95ms | 99.5% | 低 |
| Random | 75ms | 120ms | 99.2% | 低 |

### 结论
- **最快：** Parallel（52ms）
- **最平衡：** Racing（58ms，资源中等）
- **最省资源：** Sequential（65ms，资源低）
- **最均衡：** Random（75ms，负载均衡最好）

---

## 故障排查

### 问题：响应时间突然变长

**可能原因：**
1. 网络延迟增加
2. 某个上游服务器故障
3. 查询量突增

**排查步骤：**
1. 检查网络延迟：`ping <server>`
2. 检查上游服务器状态
3. 查看日志中的错误信息
4. 检查系统资源使用情况

**解决方案：**
1. 切换到 Parallel 策略（提高可靠性）
2. 增加超时时间
3. 减少并发数
4. 重启服务

---

### 问题：成功率下降

**可能原因：**
1. 上游服务器故障
2. 网络质量下降
3. 超时设置过短

**排查步骤：**
1. 检查上游服务器日志
2. 测试网络连接
3. 查看错误日志

**解决方案：**
1. 增加超时时间
2. 切换到更可靠的策略（Parallel）
3. 增加上游服务器数量
4. 启用健康检查

---

### 问题：资源消耗过高

**可能原因：**
1. 使用了 Parallel 策略
2. 并发数设置过高
3. 查询量过大

**排查步骤：**
1. 检查当前策略
2. 查看并发数设置
3. 监控 CPU/内存使用

**解决方案：**
1. 切换到 Sequential 或 Racing 策略
2. 降低并发数
3. 增加缓存 TTL
4. 启用请求去重

---

## 最佳实践

1. **始终启用健康检查**
   - 自动检测故障服务器
   - 自动故障转移

2. **使用 Auto 策略**
   - 自动选择最优策略
   - 无需手动调整

3. **监控性能指标**
   - 定期检查响应时间
   - 定期检查成功率
   - 定期检查资源使用

4. **定期调优参数**
   - 根据实际网络条件调整
   - 根据业务需求调整
   - 定期评估效果

5. **保持日志记录**
   - 便于故障排查
   - 便于性能分析
   - 便于趋势分析

6. **测试故障场景**
   - 测试单个服务器故障
   - 测试网络延迟增加
   - 测试高并发场景

---

## 相关文档

- [详细分析报告](QUERY_STRATEGIES_ANALYSIS.md)
- [代码优化建议](OPTIMIZATION_RECOMMENDATIONS.md)
- [管理器结构](MANAGER_STRUCTURE.md)
