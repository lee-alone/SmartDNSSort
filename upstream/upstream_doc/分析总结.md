# ä¸Šæ¸¸æœåŠ¡å™¨ IPv4/IPv6 å¤±è´¥çŽ‡é—®é¢˜ - åˆ†æžæ€»ç»“

## é—®é¢˜é™ˆè¿°

åœ¨ IPv4+IPv6 åŒæ ˆçŽ¯å¢ƒä¸‹ï¼Œç¨‹åºä½œä¸º DNS è½¬å‘å™¨è®¿é—®ä¸Šæ¸¸é€’å½’æœåŠ¡å™¨æ—¶ï¼Œå¤±è´¥çŽ‡å‡é«˜ã€‚ç‰¹åˆ«æ˜¯ï¼š
- ä»… IPv4 çŽ¯å¢ƒï¼šå¤±è´¥çŽ‡ä½Ž
- IPv4+IPv6 çŽ¯å¢ƒï¼šå¤±è´¥çŽ‡é«˜

ä¸Šæ¸¸æœåŠ¡å™¨é…ç½®ï¼š
- ä¸¤ä¸ªæœåŠ¡å™¨éƒ½æ˜¯ç›´æŽ¥å†™ IP åœ°å€ï¼ˆå¦‚ `udp://192.168.1.1:53`ï¼‰
- åè®®ï¼šUDP
- ç±»åž‹ï¼šè‡ªå»ºé€’å½’æœåŠ¡å™¨

---

## æ ¹æœ¬åŽŸå› åˆ†æž

### æ ¸å¿ƒé—®é¢˜

**å…¨å±€ç†”æ–­æœºåˆ¶å¯¼è‡´ IPv6 è·¯å¾„çš„å¤±è´¥è¯¯ä¼¤ IPv4 è·¯å¾„**

### é—®é¢˜é“¾æ¡

```
åŒæ ˆçŽ¯å¢ƒ + ä¸Šæ¸¸ IPv4 åœ°å€
    â†“
ç³»ç»Ÿé€šè¿‡ IPv6 éš§é“/æ˜ å°„è®¿é—®ä¸Šæ¸¸
    â†“
IPv6 è·¯å¾„ä¸ç¨³å®šï¼ˆä¸¢åŒ…ã€MTUã€PMTUD å¤±è´¥ï¼‰
    â†“
AAAA æŸ¥è¯¢è¶…æ—¶æˆ–å¤±è´¥
    â†“
å•ä¸ª HealthAwareUpstream å®žä¾‹è®°å½•å¤±è´¥
    â†“
è¿žç»­å¤±è´¥ 5 æ¬¡ â†’ ç†”æ–­ï¼ˆ30 ç§’å†…å®Œå…¨è·³è¿‡ï¼‰
    â†“
å³ä½¿ IPv4 è·¯å¾„æ­£å¸¸ï¼Œä¹Ÿè¢«ç†”æ–­è·³è¿‡
    â†“
å¤±è´¥çŽ‡å‡é«˜
```

### ä»£ç è¯æ®

#### 1. å•ä¸€å¥åº·çŠ¶æ€ï¼ˆ`health_aware.go`ï¼‰
```go
type HealthAwareUpstream struct {
    upstream Upstream
    health   *ServerHealth  // å•ä¸€å¥åº·çŠ¶æ€
}

// ä»»ä½•é”™è¯¯éƒ½ä¼šè§¦å‘ MarkFailure()
if err != nil {
    h.health.MarkFailure()  // æ— è®ºæ˜¯ IPv4 è¿˜æ˜¯ IPv6 é”™è¯¯
}
```

#### 2. ç†”æ–­è·³è¿‡ï¼ˆ`manager_sequential.go`ï¼‰
```go
if server.ShouldSkipTemporarily() {
    continue  // ç›´æŽ¥è·³è¿‡ï¼Œä¸å°è¯•
}
```

#### 3. ç†”æ–­åˆ¤å®šï¼ˆ`health.go`ï¼‰
```go
// è¿žç»­å¤±è´¥ 5 æ¬¡è¿›å…¥ç†”æ–­
if h.consecutiveFailures >= h.config.CircuitBreakerThreshold {
    h.status = HealthStatusUnhealthy
}

// 30 ç§’å†…å®Œå…¨è·³è¿‡
if elapsed < float64(h.config.CircuitBreakerTimeout) {
    return true  // è·³è¿‡
}
```

---

## ä½ çš„åˆ†æžå‡†ç¡®æ€§è¯„ä¼°

| åˆ†æžç‚¹ | å‡†ç¡®æ€§ | è¯´æ˜Ž |
|------|------|------|
| å…¨å±€ç†”æ–­å¯¼è‡´ IPv4 è·¯å¾„è¢«è¯¯ä¼¤ | â­â­â­â­â­ | å®Œå…¨æ­£ç¡®ï¼Œæ˜¯æ ¹æœ¬åŽŸå›  |
| é»˜è®¤è¶…æ—¶æ—¶é—´è¿‡çŸ­å¯¼è‡´è¿žçŽ¯å¤±æ•ˆ | â­â­â­â­â­ | å®Œå…¨æ­£ç¡®ï¼ŒåŠ é€Ÿç†”æ–­è§¦å‘ |
| UDP å•è·¯å¾„ä¾èµ–ä¸Žç¼ºä¹æ¥æºç»‘å®š | â­â­â­â­ | æ­£ç¡®ï¼Œä½†å½±å“æœ‰é™ |
| MTU ä¸Ž ICMPv6 é»‘æ´žé—®é¢˜ | â­â­â­â­â­ | å®Œå…¨æ­£ç¡®ï¼Œéšè—çš„å‘ |

**æ€»ä½“è¯„ä»·**ï¼šä½ çš„åˆ†æžéžå¸¸æ·±åˆ»å’Œå‡†ç¡®ï¼Œç‰¹åˆ«æ˜¯å¯¹ç†”æ–­æœºåˆ¶çš„ç†è§£ã€‚

---

## æŽ¨èè§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šåˆ†ç¦»åè®®æ ˆçš„å¥åº·æ£€æŸ¥ï¼ˆæŽ¨èï¼‰

**ä¼˜å…ˆçº§**ï¼šðŸ”´ ç«‹å³åš

**æ ¸å¿ƒæ€æƒ³**ï¼š
- ä¸ºæ¯ä¸ªä¸Šæ¸¸ IP åˆ›å»ºä¸¤ä¸ª `HealthAwareUpstream` å®žä¾‹
- ä¸€ä¸ªç”¨äºŽ A æŸ¥è¯¢ï¼ˆIPv4ï¼‰ï¼Œä¸€ä¸ªç”¨äºŽ AAAA æŸ¥è¯¢ï¼ˆIPv6ï¼‰
- IPv6 æ•…éšœä¸ä¼šå½±å“ IPv4 æŸ¥è¯¢

**é¢„æœŸæ•ˆæžœ**ï¼š
- å¤±è´¥çŽ‡ä¸‹é™ 50-80%
- å®žçŽ°ç›¸å¯¹ç®€å•

**å®žçŽ°éš¾åº¦**ï¼šâ­â­ ä¸­ç­‰

**æ–‡ä»¶**ï¼š`ä¸Šæ¸¸é—®é¢˜_å®žçŽ°æ–¹æ¡ˆ.md`

---

### æ–¹æ¡ˆ 2ï¼šå¢žåŠ  DNS ä¼šè¯è¶…æ—¶é‡è¯•

**ä¼˜å…ˆçº§**ï¼šðŸŸ¡ æ¬¡ä¼˜å…ˆ

**æ ¸å¿ƒæ€æƒ³**ï¼š
- åœ¨ 300ms è¶…æ—¶åŽï¼Œä¸ç«‹å³åˆ¤å®šå¤±è´¥
- å†…ç½®ä¸€æ¬¡æˆ–å¤šæ¬¡å¿«é€Ÿé‡è¯•

**é¢„æœŸæ•ˆæžœ**ï¼š
- å‡å°‘è™šå‡å¤±è´¥
- é™ä½Žç†”æ–­è§¦å‘é¢‘çŽ‡

**å®žçŽ°éš¾åº¦**ï¼šâ­â­ ä¸­ç­‰

---

### æ–¹æ¡ˆ 3ï¼šä¼˜åŒ–ç†”æ–­æ¢å¤ç­–ç•¥

**ä¼˜å…ˆçº§**ï¼šðŸŸ¢ å¯é€‰

**æ ¸å¿ƒæ€æƒ³**ï¼š
- å¯¹äºŽè¶…æ—¶å¯¼è‡´çš„ç†”æ–­ï¼Œé‡‡ç”¨"ä¼˜é›…é™çº§"è€Œéž"ç¡¬æˆªæ–­"
- å³ä½¿åœ¨ç†”æ–­æœŸé—´ï¼Œä¹Ÿèƒ½æœ‰å°‘é‡è¯·æ±‚é€šè¿‡ä»¥æŽ¢æµ‹æ¢å¤æƒ…å†µ

**é¢„æœŸæ•ˆæžœ**ï¼š
- æ›´å¿«çš„æ•…éšœæ¢å¤
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

**å®žçŽ°éš¾åº¦**ï¼šâ­â­â­ å¤æ‚

---

### æ–¹æ¡ˆ 4ï¼šMTU è°ƒä¼˜

**ä¼˜å…ˆçº§**ï¼šðŸ”µ ä¿¡æ¯æ€§

**æ ¸å¿ƒæ€æƒ³**ï¼š
- è®¾ç½® EDNS0 çš„ Buffer Size ä¸º 1232 å­—èŠ‚
- é¿å…åˆ†ç‰‡å’Œ MTU é—®é¢˜

**é¢„æœŸæ•ˆæžœ**ï¼š
- å‡å°‘å¤§åŒ…è¶…æ—¶
- ç‰¹åˆ«æ˜¯åœ¨ç»è¿‡ NAT64 ç­‰åè®®è½¬æ¢æ—¶

**å®žçŽ°éš¾åº¦**ï¼šâ­ ç®€å•

---

## ç«‹å³è¡ŒåŠ¨å»ºè®®

### ç¬¬ 1 æ­¥ï¼šå®žæ–½æ–¹æ¡ˆ 1ï¼ˆåˆ†ç¦»åè®®æ ˆï¼‰

è¿™æ˜¯æœ€ç›´æŽ¥çš„è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥æ˜¾è‘—é™ä½Žå¤±è´¥çŽ‡ã€‚

**é¢„è®¡å·¥ä½œé‡**ï¼š2-4 å°æ—¶

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `transport/udp.go`ï¼šæ·»åŠ åè®®æ ˆåå¥½å‚æ•°
- `factory.go`ï¼šæ·»åŠ åè®®æ ˆåˆ†ç¦»é€»è¾‘
- `manager.go`ï¼šæ·»åŠ åè®®æ ˆåˆ†ç¦»åˆå§‹åŒ–

### ç¬¬ 2 æ­¥ï¼šæµ‹è¯•å’ŒéªŒè¯

åœ¨åŒæ ˆçŽ¯å¢ƒä¸‹æµ‹è¯•ï¼Œå¯¹æ¯”ä¿®æ”¹å‰åŽçš„å¤±è´¥çŽ‡ã€‚

**é¢„è®¡å·¥ä½œé‡**ï¼š1-2 å°æ—¶

### ç¬¬ 3 æ­¥ï¼šå¯é€‰ä¼˜åŒ–

æ ¹æ®æµ‹è¯•ç»“æžœï¼Œè€ƒè™‘å®žæ–½æ–¹æ¡ˆ 2ã€3ã€4ã€‚

---

## æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | è¯´æ˜Ž |
|-----|------|
| `ä¸Šæ¸¸åˆ†æž.md` | ä½ çš„åŽŸå§‹åˆ†æž |
| `ä¸Šæ¸¸åˆ†æž_ä»£ç éªŒè¯_æœ€ç»ˆç‰ˆ.md` | ä»£ç éªŒè¯å’Œåˆ†æž |
| `ä¸Šæ¸¸é—®é¢˜_å®žçŽ°æ–¹æ¡ˆ.md` | è¯¦ç»†çš„å®žçŽ°æ–¹æ¡ˆ |
| `åˆ†æžæ€»ç»“.md` | æœ¬æ–‡ä»¶ |

---

## å…³é”®ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œå· |
|-----|-----|------|
| ç†”æ–­åˆ¤å®š | `upstream/health.go` | ~60-80 |
| ç†”æ–­è·³è¿‡ | `upstream/health.go` | ~90-100 |
| Sequential ç­–ç•¥ | `upstream/manager_sequential.go` | ~30-50 |
| UDP ä¼ è¾“ | `upstream/transport/udp.go` | ~10-30 |
| å·¥åŽ‚å‡½æ•° | `upstream/factory.go` | ~10-40 |

---

## é¢„æœŸæ—¶é—´è¡¨

| é˜¶æ®µ | å·¥ä½œ | é¢„è®¡æ—¶é—´ |
|-----|-----|--------|
| 1 | å®žæ–½æ–¹æ¡ˆ 1 | 2-4 å°æ—¶ |
| 2 | æµ‹è¯•å’ŒéªŒè¯ | 1-2 å°æ—¶ |
| 3 | å¯é€‰ä¼˜åŒ– | 2-4 å°æ—¶ |
| **æ€»è®¡** | | **5-10 å°æ—¶** |

---

## æˆåŠŸæŒ‡æ ‡

- âœ… å¤±è´¥çŽ‡ä¸‹é™ 50% ä»¥ä¸Š
- âœ… IPv6 è·¯å¾„æ•…éšœä¸å½±å“ IPv4 æŸ¥è¯¢
- âœ… ç†”æ–­æœºåˆ¶ä»ç„¶æœ‰æ•ˆ
- âœ… å‘åŽå…¼å®¹çŽ°æœ‰é…ç½®

---

## åŽç»­è·Ÿè¿›

å®žæ–½æ–¹æ¡ˆåŽï¼Œå»ºè®®ï¼š

1. **ç›‘æŽ§å¤±è´¥çŽ‡**ï¼šæŒç»­è§‚å¯Ÿæ˜¯å¦æœ‰æ”¹å–„
2. **æ”¶é›†æ—¥å¿—**ï¼šè®°å½•ç†”æ–­äº‹ä»¶ï¼Œåˆ†æžæ¨¡å¼
3. **æ€§èƒ½æµ‹è¯•**ï¼šç¡®ä¿å“åº”æ—¶é—´åœ¨å¯æŽ¥å—èŒƒå›´å†…
4. **ç”¨æˆ·åé¦ˆ**ï¼šæ”¶é›†ç”¨æˆ·çš„ä½“éªŒæ”¹å–„åé¦ˆ

