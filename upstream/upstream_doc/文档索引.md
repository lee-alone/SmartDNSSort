# 上游 IPv4/IPv6 失败率问题 - 文档索引

## 问题分析文档

### 1. `上游分析.md`
**你的原始分析**
- 问题描述
- 初步分析
- 改进建议

### 2. `问题重新分析.md`
**问题的深度分析**
- 澄清了程序侧 vs 上游侧的区别
- 提出了新的假设：上游 IPv6 失败导致程序超时
- 验证方法

### 3. `上游分析_代码验证_最终版.md`
**代码级别的验证**
- 逐点验证你的分析
- 代码证据
- 问题链条分析

---

## 解决方案文档

### 4. `上游问题_实现方案.md`
**之前建议的实现方案**
- 分离协议栈的健康检查
- 详细的代码示例
- 实现步骤

### 5. `解决方案验证_MarkTimeout机制.md`
**你的 MarkTimeout 方案的详细验证**
- 方案总结
- 代码质量评估
- 预期效果分析
- 与之前分析的对比

### 6. `实施总结_MarkTimeout方案.md`
**MarkTimeout 方案的完整总结**
- 问题回顾
- 解决方案详解
- 工作流程
- 预期效果
- 与其他方案的对比
- 验证清单

---

## 快速参考文档

### 7. `快速参考.md`
**快速查询指南（之前的建议）**
- 问题一句话总结
- 根本原因
- 代码位置
- 解决方案优先级
- 快速诊断

### 8. `MarkTimeout方案_快速参考.md`
**MarkTimeout 方案的快速参考卡**
- 问题和解决方案一句话
- 核心改动
- 工作原理
- 预期效果
- 关键数字
- 验证方法

---

## 评价文档

### 9. `分析总结.md`
**之前的分析总结**
- 问题陈述
- 根本原因分析
- 分析准确性评估
- 推荐解决方案
- 立即行动建议

### 10. `最终评价_MarkTimeout方案.md`
**对 MarkTimeout 方案的最终评价**
- 总体评价（5/5）
- 为什么这是最优方案
- 与其他方案的对比
- 预期效果分析
- 技术细节评价
- 部署建议

---

## 文档阅读指南

### 快速了解问题

1. 阅读 `问题重新分析.md`（5 分钟）
2. 阅读 `MarkTimeout方案_快速参考.md`（3 分钟）

### 深入理解问题

1. 阅读 `上游分析.md`（10 分钟）
2. 阅读 `上游分析_代码验证_最终版.md`（15 分钟）
3. 阅读 `问题重新分析.md`（10 分钟）

### 了解解决方案

1. 阅读 `解决方案验证_MarkTimeout机制.md`（15 分钟）
2. 阅读 `实施总结_MarkTimeout方案.md`（15 分钟）
3. 阅读 `最终评价_MarkTimeout方案.md`（10 分钟）

### 部署前准备

1. 阅读 `MarkTimeout方案_快速参考.md`（3 分钟）
2. 查看代码修改（`upstream/health.go`, `upstream/health_aware.go`, `upstream/manager_sequential.go`）
3. 阅读 `实施总结_MarkTimeout方案.md` 中的验证清单

---

## 文档关键内容速查

### 问题是什么？

**文档**：`问题重新分析.md`

**核心**：
- 程序通过 IPv4 访问上游
- 上游通过 IPv6 向权威服务器查询
- 上游 IPv6 失败导致程序超时
- 程序因超时而熔断整个服务器

### 解决方案是什么？

**文档**：`MarkTimeout方案_快速参考.md`

**核心**：
- 区分超时和硬错误
- 超时不触发熔断，只增加延迟
- 利用现有排序机制实现自动避让

### 代码改动在哪里？

**文档**：`实施总结_MarkTimeout方案.md`

**位置**：
- `upstream/health.go`：新增 `MarkTimeout` 方法
- `upstream/health_aware.go`：错误类型判定
- `upstream/manager_sequential.go`：调用 `RecordTimeout`

### 预期效果是什么？

**文档**：`最终评价_MarkTimeout方案.md`

**效果**：
- 失败率下降 50-80%
- IPv4 访问不再受影响
- 自动流量分配
- 平滑的故障恢复

---

## 文档时间表

| 阶段 | 文档 | 时间 |
|-----|-----|------|
| 理解问题 | `问题重新分析.md` | 10 分钟 |
| 理解方案 | `MarkTimeout方案_快速参考.md` | 5 分钟 |
| 深入学习 | `解决方案验证_MarkTimeout机制.md` | 20 分钟 |
| 部署准备 | `实施总结_MarkTimeout方案.md` | 15 分钟 |
| 最终评价 | `最终评价_MarkTimeout方案.md` | 10 分钟 |
| **总计** | | **60 分钟** |

---

## 文档关系图

```
问题分析
├── 上游分析.md（原始分析）
├── 问题重新分析.md（深度分析）
└── 上游分析_代码验证_最终版.md（代码验证）

解决方案
├── 上游问题_实现方案.md（之前的建议）
├── 解决方案验证_MarkTimeout机制.md（方案验证）
├── 实施总结_MarkTimeout方案.md（完整总结）
└── 最终评价_MarkTimeout方案.md（最终评价）

快速参考
├── 快速参考.md（之前的快速参考）
└── MarkTimeout方案_快速参考.md（当前方案快速参考）

总结
├── 分析总结.md（之前的总结）
└── 文档索引.md（本文件）
```

---

## 关键概念速查

### MarkTimeout 是什么？

**定义**：一个新的方法，用于处理超时错误，不触发熔断，只增加延迟。

**位置**：`upstream/health.go`

**作用**：
- 不增加 `consecutiveFailures` 计数器
- 增加延迟（EWMA）
- 服务器排序靠后

### EWMA 是什么？

**定义**：指数加权移动平均（Exponential Weighted Moving Average）

**公式**：`new_avg = alpha * new_value + (1 - alpha) * old_avg`

**作用**：平衡新旧数据，平滑的过渡

### 软惩罚是什么？

**定义**：不熔断，只增加延迟，让服务器排序靠后

**效果**：自动避让缓慢的服务器，但保留资格

### 硬错误是什么？

**定义**：连接拒绝、DNS 错误等真正的故障

**处理**：仍然触发熔断，快速切断

---

## 常见问题速查

### Q: 这个方案会影响性能吗？

**答案**：不会。只是改变了错误处理的方式，不增加额外开销。

**文档**：`最终评价_MarkTimeout方案.md`

### Q: 熔断机制还有效吗？

**答案**：有效。只有超时被特殊处理，硬错误仍然触发熔断。

**文档**：`MarkTimeout方案_快速参考.md`

### Q: 如何快速验证修改是否有效？

**答案**：查看日志中是否有 `MarkTimeout` 被调用，观察失败率是否下降。

**文档**：`实施总结_MarkTimeout方案.md`

### Q: 需要修改配置吗？

**答案**：不需要。代码修改后自动生效。

**文档**：`MarkTimeout方案_快速参考.md`

---

## 推荐阅读顺序

### 对于项目经理

1. `问题重新分析.md`（了解问题）
2. `最终评价_MarkTimeout方案.md`（了解方案）
3. `实施总结_MarkTimeout方案.md`（了解效果）

### 对于开发人员

1. `问题重新分析.md`（了解问题）
2. `解决方案验证_MarkTimeout机制.md`（了解方案）
3. 查看代码修改
4. `实施总结_MarkTimeout方案.md`（了解验证方法）

### 对于运维人员

1. `MarkTimeout方案_快速参考.md`（快速了解）
2. `实施总结_MarkTimeout方案.md`（了解监控指标）
3. 部署和监控

---

## 文档版本

| 版本 | 日期 | 说明 |
|-----|------|------|
| 1.0 | 2024 | 初始版本 |

---

## 反馈和改进

如有任何问题或建议，请参考相关文档或提出讨论。

