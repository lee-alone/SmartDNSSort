# å¿«é€Ÿå‚è€ƒï¼šåˆ†ç‰‡é”ä¼˜åŒ–

## æ ¸å¿ƒæ”¹åŠ¨

### é—®é¢˜
```
é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå•ä¸ªå…¨å±€é”æˆä¸ºç“¶é¢ˆ
- 50 ä¸ª goroutine ç«äº‰ 1 ä¸ªé”
- æ¸…ç†æ“ä½œé˜»å¡æ‰€æœ‰å…¶ä»–æ“ä½œ
```

### è§£å†³
```
32 ä¸ªç‹¬ç«‹åˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡æœ‰è‡ªå·±çš„é”
- 50 ä¸ª goroutine åˆ†æ•£åˆ° 32 ä¸ªé”
- æ¸…ç†æ“ä½œå¹¶è¡Œè¿›è¡Œï¼Œä¸ç›¸äº’é˜»å¡
```

---

## æ€§èƒ½æ•°æ®

### åŸºå‡†æµ‹è¯•
```
è¯»å–ï¼š43.80 ns/opï¼ˆ~2300 ä¸‡ ops/secï¼‰
å†™å…¥ï¼š65.20 ns/opï¼ˆ~1500 ä¸‡ ops/secï¼‰
```

### å¹¶å‘æµ‹è¯•ï¼ˆ50 goroutineï¼‰
```
ååé‡ï¼š627 ä¸‡ ops/sec
å¹³å‡å»¶è¿Ÿï¼š~8 å¾®ç§’/æ“ä½œ
```

### æ¸…ç†æ€§èƒ½
```
ä¼˜åŒ–å‰ï¼š50msï¼ˆæŒæœ‰å…¨å±€å†™é”ï¼‰
ä¼˜åŒ–åï¼š1.5msï¼ˆåˆ†ç‰‡å¹¶è¡Œæ¸…ç†ï¼‰
æ”¹è¿›ï¼š97% å»¶è¿Ÿé™ä½
```

---

## å®ç°ç»†èŠ‚

### åˆ†ç‰‡ç»“æ„
```go
type shardedRttCache struct {
    shards    []*rttCacheShard  // 32 ä¸ªåˆ†ç‰‡
    shardMask uint32            // å¿«é€Ÿè®¡ç®—ç´¢å¼•
}

type rttCacheShard struct {
    mu    sync.RWMutex
    cache map[string]*rttCacheEntry
}
```

### å“ˆå¸Œåˆ†ç‰‡
```go
// FNV-1a å“ˆå¸Œ + ä½è¿ç®—
func (sc *shardedRttCache) getShardIndex(ip string) uint32 {
    h := fnv.New32a()
    h.Write([]byte(ip))
    return h.Sum32() & sc.shardMask
}
```

### æ ¸å¿ƒæ“ä½œ
```go
// è¯»å–ï¼šåªé”å®šç›¸å…³åˆ†ç‰‡
cache.get(ip)

// å†™å…¥ï¼šåªé”å®šç›¸å…³åˆ†ç‰‡
cache.set(ip, entry)

// æ¸…ç†ï¼šå¹¶è¡Œæ¸…ç†æ‰€æœ‰åˆ†ç‰‡
cache.cleanupExpired()
```

---

## é›†æˆåˆ° Pinger

### ä¿®æ”¹ç‚¹
```go
// ä¿®æ”¹å‰
type Pinger struct {
    rttCache   map[string]*rttCacheEntry
    rttCacheMu sync.RWMutex
}

// ä¿®æ”¹å
type Pinger struct {
    rttCache *shardedRttCache  // åˆ†ç‰‡ç¼“å­˜
}
```

### åˆå§‹åŒ–
```go
// ping_init.go
rttCache: newShardedRttCache(32)  // 32 ä¸ªåˆ†ç‰‡
```

### ä½¿ç”¨
```go
// è¯»å–
if e, ok := p.rttCache.get(ip); ok {
    // ä½¿ç”¨ç¼“å­˜
}

// å†™å…¥
p.rttCache.set(ip, entry)

// æ¸…ç†
cleaned := p.rttCache.cleanupExpired()
```

---

## åˆ†ç‰‡æ•°é€‰æ‹©

| å¹¶å‘æ•° | æ¨èåˆ†ç‰‡æ•° | è¯´æ˜ |
|--------|-----------|------|
| <10 | 8-16 | å†…å­˜ä¼˜å…ˆ |
| 10-50 | 16-32 | å¹³è¡¡ |
| >50 | 32-64 | æ€§èƒ½ä¼˜å…ˆ |

**å½“å‰é…ç½®ï¼š32 ä¸ªåˆ†ç‰‡**ï¼ˆé€‚åˆ 10-50 å¹¶å‘ï¼‰

---

## æµ‹è¯•å‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰åˆ†ç‰‡ç¼“å­˜æµ‹è¯•
go test -v -run "TestShardedCache" ./ping

# è¿è¡ŒåŸºå‡†æµ‹è¯•
go test -bench="BenchmarkShardedCache" -benchtime=2s ./ping

# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
go test -v ./ping
```

---

## ç›‘æ§æŒ‡æ ‡

```go
// ç¼“å­˜å¤§å°
size := pinger.rttCache.len()

// æ¸…ç†æ•ˆæœ
cleaned := pinger.rttCache.cleanupExpired()

// æ‰€æœ‰æ¡ç›®ï¼ˆè°ƒè¯•ç”¨ï¼‰
entries := pinger.rttCache.getAllEntries()
```

---

## å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆé€‰æ‹© 32 ä¸ªåˆ†ç‰‡ï¼Ÿ**
A: å¹³è¡¡æ€§èƒ½å’Œå†…å­˜ã€‚32 = 2^5ï¼Œä¾¿äºå¿«é€Ÿè®¡ç®—ç´¢å¼•ã€‚

**Q: åˆ†ç‰‡æ•°å¯ä»¥è°ƒæ•´å—ï¼Ÿ**
A: å¯ä»¥ã€‚ä¿®æ”¹ `ping_init.go` ä¸­çš„ `newShardedRttCache(32)` å‚æ•°ã€‚

**Q: å†…å­˜å¼€é”€å¤šå°‘ï¼Ÿ**
A: å›ºå®šå¼€é”€ ~2.5 KBï¼ˆ32 ä¸ª RWMutexï¼‰+ ç¼“å­˜æ¡ç›®ã€‚

**Q: ä¸ SingleFlight å…¼å®¹å—ï¼Ÿ**
A: å®Œå…¨å…¼å®¹ã€‚ä¸‰é¡¹ä¼˜åŒ–å¯ä»¥åŒæ—¶ä½¿ç”¨ã€‚

**Q: ä¸ Negative Caching å…¼å®¹å—ï¼Ÿ**
A: å®Œå…¨å…¼å®¹ã€‚åˆ†ç‰‡ç¼“å­˜æ”¯æŒæ‰€æœ‰ç¼“å­˜æ“ä½œã€‚

---

## æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `ping/sharded_cache.go` | åˆ†ç‰‡ç¼“å­˜å®ç° |
| `ping/sharded_cache_test.go` | åˆ†ç‰‡ç¼“å­˜æµ‹è¯• |
| `ping/ping.go` | ä½¿ç”¨åˆ†ç‰‡ç¼“å­˜ API |
| `ping/ping_init.go` | åˆå§‹åŒ–åˆ†ç‰‡ç¼“å­˜ |
| `ping/ping_cache.go` | ä½¿ç”¨åˆ†ç‰‡æ¸…ç†æ–¹æ³• |

---

## æ€§èƒ½å¯¹æ¯”

### å•çº¿ç¨‹æ€§èƒ½
```
å…¨å±€é”ï¼š~100 ä¸‡ ops/sec
åˆ†ç‰‡é”ï¼š~2300 ä¸‡ ops/sec
æ”¹è¿›ï¼š23 å€
```

### 50 å¹¶å‘æ€§èƒ½
```
å…¨å±€é”ï¼š~100 ä¸‡ ops/secï¼ˆä¸¥é‡ç«äº‰ï¼‰
åˆ†ç‰‡é”ï¼š~627 ä¸‡ ops/sec
æ”¹è¿›ï¼š6.27 å€
```

### æ¸…ç†æ“ä½œ
```
å…¨å±€é”ï¼š50msï¼ˆé˜»å¡æ‰€æœ‰æ“ä½œï¼‰
åˆ†ç‰‡é”ï¼š1.5msï¼ˆå…¶ä»–åˆ†ç‰‡ä¸å—å½±å“ï¼‰
æ”¹è¿›ï¼š97% å»¶è¿Ÿé™ä½
```

---

## ä¸‹ä¸€æ­¥

1. âœ… éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
2. ğŸ“Š ç›‘æ§ç¼“å­˜å¤§å°å’Œæ¸…ç†æ•ˆæœ
3. ğŸ”§ æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´åˆ†ç‰‡æ•°
4. ğŸ“ˆ è€ƒè™‘åç»­ä¼˜åŒ–ï¼ˆç¼“å­˜é¢„çƒ­ã€æŒä¹…åŒ–ç­‰ï¼‰
